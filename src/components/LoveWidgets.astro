---
const enabled = import.meta.env.PUBLIC_ENABLE_LOVE_WIDGETS !== "false";
---

{enabled && (
  <>
    <div class="love-counter-wrap mx-auto max-w-7xl px-5">
      <div class="love-counter-strip" data-love-counter>
        <span class="love-counter__icons" aria-hidden="true">‚ô•Ô∏é ‚ú∂ ‚òæ</span>
        <div class="love-counter__day" data-love-day>DAY 0</div>
        <div class="love-counter__since">since 31 Dec 2025</div>
      </div>

      <section class="love-events-strip" data-love-events aria-label="Main events c·ªßa M·ªπ Uy√™n v√† Vi·ªát Ho√†">
        <div class="love-events-strip__head">
          <span class="love-events-strip__next" data-love-event-next>‚ö° THE UPCOMING EVENT</span>
          <button
            class="love-events-strip__toggle"
            type="button"
            data-love-events-toggle
            aria-expanded="false"
            aria-controls="love-events-more"
            aria-label="M·ªü full timeline"
            title="M·ªü full timeline"
          >
            <span aria-hidden="true">‚ñæ</span>
          </button>
        </div>

        <div class="love-events-strip__rail love-events-strip__rail--featured" role="list" aria-label="Featured event timeline">
          <article
            class="love-event-chip"
            role="listitem"
            style="--event-accent: 255 141 177;"
            data-love-event
            data-love-event-group="featured"
            data-love-event-name="Sinh nh·∫≠t M·ªπ Uy√™n"
            data-love-event-month="3"
            data-love-event-day="17"
          >
            <span class="love-event-chip__icon" aria-hidden="true">üéÇ</span>
            <div class="love-event-chip__meta">
              <span class="love-event-chip__name">Sinh nh·∫≠t M·ªπ Uy√™n</span>
              <span class="love-event-chip__date" data-love-event-date>17/03</span>
            </div>
            <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
          </article>

          <article
            class="love-event-chip"
            role="listitem"
            style="--event-accent: 116 218 255;"
            data-love-event
            data-love-event-group="featured"
            data-love-event-name="Vi·ªát Ho√† v·ªÅ Vi·ªát Nam"
            data-love-event-month="3"
            data-love-event-day="23"
            data-love-event-hour="21"
            data-love-event-minute="30"
          >
            <span class="love-event-chip__icon" aria-hidden="true">‚úàÔ∏é</span>
            <div class="love-event-chip__meta">
              <span class="love-event-chip__name">Vi·ªát Ho√† v·ªÅ Vi·ªát Nam</span>
              <span class="love-event-chip__date" data-love-event-date>23/03</span>
            </div>
            <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
          </article>
        </div>

        <div class="love-events-strip__more" id="love-events-more" data-love-events-more hidden>
          <div class="love-events-strip__rail love-events-strip__rail--extra" role="list" aria-label="Extra event timeline">
            <article
              class="love-event-chip love-event-chip--extra"
              role="listitem"
              style="--event-accent: 255 205 118;"
              data-love-event
              data-love-event-group="extra"
              data-love-event-name="Sinh nh·∫≠t Vi·ªát Ho√†"
              data-love-event-month="6"
              data-love-event-day="4"
            >
              <span class="love-event-chip__icon" aria-hidden="true">üéâ</span>
              <div class="love-event-chip__meta">
                <span class="love-event-chip__name">Sinh nh·∫≠t Vi·ªát Ho√†</span>
                <span class="love-event-chip__date" data-love-event-date>04/06</span>
              </div>
              <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
            </article>

            <article
              class="love-event-chip love-event-chip--extra"
              role="listitem"
              style="--event-accent: 186 255 158;"
              data-love-event
              data-love-event-group="extra"
              data-love-event-name="Valentine Day"
              data-love-event-month="2"
              data-love-event-day="14"
            >
              <span class="love-event-chip__icon" aria-hidden="true">üíå</span>
              <div class="love-event-chip__meta">
                <span class="love-event-chip__name">Valentine Day</span>
                <span class="love-event-chip__date" data-love-event-date>14/02</span>
              </div>
              <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
            </article>

            <article
              class="love-event-chip love-event-chip--extra"
              role="listitem"
              style="--event-accent: 255 167 118;"
              data-love-event
              data-love-event-group="extra"
              data-love-event-name="Anniversary 1 Year"
              data-love-event-month="12"
              data-love-event-day="31"
            >
              <span class="love-event-chip__icon" aria-hidden="true">ü•Ç</span>
              <div class="love-event-chip__meta">
                <span class="love-event-chip__name">Anniversary 1 Year</span>
                <span class="love-event-chip__date" data-love-event-date>31/12</span>
              </div>
              <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
            </article>
          </div>
        </div>
      </section>
    </div>

    <div class="love-widgets love-widgets--clocks" data-love-widgets>
      <div class="love-widgets__panel">
        <div class="love-widgets__clocks">
          <div class="love-widgets__clock" data-love-clock="vn">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üáªüá≥</span>
              VN
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="jp">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üáØüáµ</span>
              JP
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="us">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üá∫üá∏</span>
              NY
            </span>
            <strong>--:--</strong>
          </div>
        </div>
      </div>
    </div>
  </>
)}

{enabled && (
  <script is:inline>
    const initLoveWidgets = () => {
      const dayEl = document.querySelector("[data-love-day]");
      const clockRoot = document.querySelector("[data-love-widgets]");
      const eventRoot = document.querySelector("[data-love-events]");
      const featuredRail = eventRoot ? eventRoot.querySelector(".love-events-strip__rail--featured") : null;
      const extraRail = eventRoot ? eventRoot.querySelector(".love-events-strip__rail--extra") : null;
      const clockEls = clockRoot
        ? {
            vn: clockRoot.querySelector("[data-love-clock='vn'] strong"),
            jp: clockRoot.querySelector("[data-love-clock='jp'] strong"),
            us: clockRoot.querySelector("[data-love-clock='us'] strong"),
          }
        : {};
      const nextEventEl = eventRoot ? eventRoot.querySelector("[data-love-event-next]") : null;
      const eventToggleBtn = eventRoot ? eventRoot.querySelector("[data-love-events-toggle]") : null;
      const eventMorePanel = eventRoot ? eventRoot.querySelector("[data-love-events-more]") : null;
      const extraEventsCount = eventRoot
        ? eventRoot.querySelectorAll("[data-love-event-group='extra']").length
        : 0;
      const eventEls = eventRoot
        ? Array.from(eventRoot.querySelectorAll("[data-love-event]")).map((eventEl) => ({
            id: eventEl.getAttribute("data-love-event-name") || "event",
            group: eventEl.getAttribute("data-love-event-group") || "extra",
            name: eventEl.getAttribute("data-love-event-name") || "event",
            month: Number(eventEl.getAttribute("data-love-event-month") || "1"),
            day: Number(eventEl.getAttribute("data-love-event-day") || "1"),
            hour: Number(eventEl.getAttribute("data-love-event-hour") || "0"),
            minute: Number(eventEl.getAttribute("data-love-event-minute") || "0"),
            eventEl,
            countdownEl: eventEl.querySelector("[data-love-event-countdown]"),
            dateEl: eventEl.querySelector("[data-love-event-date]"),
          }))
        : [];

      const startParts = { year: 2025, month: 12, day: 31 };
      const eventTimezoneOffsetMinutes = 7 * 60;
      const pad = (value) => String(value).padStart(2, "0");

      const getDateParts = (timeZone) => {
        const formatter = new Intl.DateTimeFormat("en-CA", {
          timeZone,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        const parts = formatter.formatToParts(new Date());
        const lookup = Object.fromEntries(parts.map((p) => [p.type, p.value]));
        return {
          year: Number(lookup.year),
          month: Number(lookup.month),
          day: Number(lookup.day),
        };
      };

      const updateDay = () => {
        if (!dayEl) return;
        const parts = getDateParts("Asia/Ho_Chi_Minh");
        const todayUtc = Date.UTC(parts.year, parts.month - 1, parts.day);
        const startUtc = Date.UTC(startParts.year, startParts.month - 1, startParts.day);
        const diff = Math.max(0, Math.floor((todayUtc - startUtc) / (1000 * 60 * 60 * 24)) + 1);
        dayEl.textContent = `DAY ${diff}`;
      };

      const eventTargetUtc = (year, month, day, hour, minute) =>
        Date.UTC(year, month - 1, day, hour, minute, 0) - eventTimezoneOffsetMinutes * 60 * 1000;

      const formatCountdown = (diffMs) => {
        const totalSeconds = Math.max(0, Math.floor(diffMs / 1000));
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${days}D ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
      };

      const setMorePanelState = (isOpen) => {
        if (!eventToggleBtn || !eventMorePanel) return;
        eventMorePanel.hidden = !isOpen;
        eventToggleBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        eventToggleBtn.setAttribute("aria-label", isOpen ? "·∫®n full timeline" : "M·ªü full timeline");
        eventToggleBtn.setAttribute(
          "title",
          isOpen ? "·∫®n full timeline" : `M·ªü full timeline (${extraEventsCount} s·ª± ki·ªán)`
        );
      };

      if (eventToggleBtn && eventMorePanel) {
        if (extraEventsCount <= 0) {
          eventToggleBtn.hidden = true;
          eventMorePanel.hidden = true;
        } else {
          setMorePanelState(false);
          if (eventToggleBtn.dataset.bound !== "1") {
            eventToggleBtn.dataset.bound = "1";
            eventToggleBtn.addEventListener("click", () => {
              const isOpen = eventToggleBtn.getAttribute("aria-expanded") === "true";
              setMorePanelState(!isOpen);
            });
          }
        }
      }

      const updateEvents = () => {
        if (!eventEls.length) return;
        const nowTs = Date.now();
        const currentYear = getDateParts("Asia/Ho_Chi_Minh").year;
        const computedEvents = [];
        let nearest = null;

        eventEls.forEach((eventItem) => {
          let targetYear = currentYear;
          let targetTs = eventTargetUtc(
            targetYear,
            eventItem.month,
            eventItem.day,
            eventItem.hour,
            eventItem.minute
          );
          if (targetTs <= nowTs) {
            targetYear += 1;
            targetTs = eventTargetUtc(
              targetYear,
              eventItem.month,
              eventItem.day,
              eventItem.hour,
              eventItem.minute
            );
          }

          const diff = Math.max(0, targetTs - nowTs);
          computedEvents.push({ eventItem, diff });
          if (eventItem.countdownEl) eventItem.countdownEl.textContent = formatCountdown(diff);
          if (eventItem.dateEl) {
            const eventTime =
              eventItem.hour !== 0 || eventItem.minute !== 0
                ? ` ¬∑ ${pad(eventItem.hour)}:${pad(eventItem.minute)}`
                : "";
            eventItem.dateEl.textContent = `${pad(eventItem.day)}/${pad(eventItem.month)}${eventTime} ¬∑ ${targetYear}`;
          }

          if (!nearest || diff < nearest.diff) {
            nearest = { name: eventItem.name, diff };
          }
        });

        if (nextEventEl && nearest) {
          nextEventEl.textContent = "‚ö° THE UPCOMING EVENT";
          nextEventEl.setAttribute("title", nearest.name);
        }

        const sortAndRender = (railEl, group) => {
          if (!(railEl instanceof HTMLElement)) return;
          const sorted = computedEvents
            .filter((entry) => entry.eventItem.group === group)
            .sort((a, b) => a.diff - b.diff);
          sorted.forEach(({ eventItem }) => {
            if (eventItem.eventEl instanceof HTMLElement) {
              railEl.appendChild(eventItem.eventEl);
            }
          });
        };

        sortAndRender(featuredRail, "featured");
        sortAndRender(extraRail, "extra");
      };

      const makeClock = (timeZone) =>
        new Intl.DateTimeFormat("en-GB", {
          timeZone,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

      const clocks = {
        vn: makeClock("Asia/Ho_Chi_Minh"),
        jp: makeClock("Asia/Tokyo"),
        us: makeClock("America/New_York"),
      };

      const tick = () => {
        const now = new Date();
        if (clockEls.vn) clockEls.vn.textContent = clocks.vn.format(now);
        if (clockEls.jp) clockEls.jp.textContent = clocks.jp.format(now);
        if (clockEls.us) clockEls.us.textContent = clocks.us.format(now);
        updateDay();
        updateEvents();
      };

      tick();

      const globalState = window.__loveWidgetsState || {};
      if (globalState.timerId) {
        window.clearInterval(globalState.timerId);
      }
      globalState.timerId = window.setInterval(tick, 1000);
      window.__loveWidgetsState = globalState;
    };

    initLoveWidgets();
    document.addEventListener("astro:page-load", initLoveWidgets);
  </script>
)}
