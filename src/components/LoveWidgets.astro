---
const enabled = import.meta.env.PUBLIC_ENABLE_LOVE_WIDGETS !== "false";
---

{enabled && (
  <>
    <div class="love-counter-wrap mx-auto max-w-7xl px-5">
      <div class="love-counter-strip" data-love-counter>
        <span class="love-counter__icons" aria-hidden="true">â™¥ï¸Ž âœ¶ â˜¾</span>
        <div class="love-counter__day" data-love-day>DAY 0</div>
        <div class="love-counter__since">since 31 Dec 2025</div>
      </div>
    </div>

    <div class="love-widgets love-widgets--clocks" data-love-widgets>
      <div class="love-widgets__panel">
        <div class="love-widgets__clocks">
          <div class="love-widgets__clock" data-love-clock="vn">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">ðŸ‡»ðŸ‡³</span>
              VN
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="jp">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">ðŸ‡¯ðŸ‡µ</span>
              JP
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="us">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">ðŸ‡ºðŸ‡¸</span>
              NY
            </span>
            <strong>--:--</strong>
          </div>
        </div>
      </div>
    </div>
  </>
)}

{enabled && (
  <script is:inline>
    const initLoveWidgets = () => {
      if (document.documentElement.dataset.loveWidgetsBound === "1") return;
      document.documentElement.dataset.loveWidgetsBound = "1";

      const dayEl = document.querySelector("[data-love-day]");
      const clockRoot = document.querySelector("[data-love-widgets]");
      const clockEls = clockRoot
        ? {
            vn: clockRoot.querySelector("[data-love-clock='vn'] strong"),
            jp: clockRoot.querySelector("[data-love-clock='jp'] strong"),
            us: clockRoot.querySelector("[data-love-clock='us'] strong"),
          }
        : {};

      const startParts = { year: 2025, month: 12, day: 31 };

      const getDateParts = (timeZone) => {
        const formatter = new Intl.DateTimeFormat("en-CA", {
          timeZone,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        const parts = formatter.formatToParts(new Date());
        const lookup = Object.fromEntries(parts.map((p) => [p.type, p.value]));
        return {
          year: Number(lookup.year),
          month: Number(lookup.month),
          day: Number(lookup.day),
        };
      };

      const updateDay = () => {
        if (!dayEl) return;
        const parts = getDateParts("Asia/Ho_Chi_Minh");
        const todayUtc = Date.UTC(parts.year, parts.month - 1, parts.day);
        const startUtc = Date.UTC(startParts.year, startParts.month - 1, startParts.day);
        const diff = Math.max(0, Math.floor((todayUtc - startUtc) / (1000 * 60 * 60 * 24)) + 1);
        dayEl.textContent = `DAY ${diff}`;
      };

      const makeClock = (timeZone) =>
        new Intl.DateTimeFormat("en-GB", {
          timeZone,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

      const clocks = {
        vn: makeClock("Asia/Ho_Chi_Minh"),
        jp: makeClock("Asia/Tokyo"),
        us: makeClock("America/New_York"),
      };

      const tick = () => {
        const now = new Date();
        if (clockEls.vn) clockEls.vn.textContent = clocks.vn.format(now);
        if (clockEls.jp) clockEls.jp.textContent = clocks.jp.format(now);
        if (clockEls.us) clockEls.us.textContent = clocks.us.format(now);
        updateDay();
      };

      tick();
      setInterval(tick, 1000);
    };

    initLoveWidgets();
    document.addEventListener("astro:page-load", initLoveWidgets);
  </script>
)}
