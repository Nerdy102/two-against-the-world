---
const enabled = import.meta.env.PUBLIC_ENABLE_LOVE_WIDGETS !== "false";
---

{enabled && (
  <>
    <div class="love-counter-wrap mx-auto max-w-7xl px-5">
      <div class="love-counter-strip" data-love-counter>
        <span class="love-counter__icons" aria-hidden="true">‚ô•Ô∏é ‚ú∂ ‚òæ</span>
        <div class="love-counter__day" data-love-day>DAY 0</div>
        <div class="love-counter__since">since 31 Dec 2025</div>
      </div>

      <section class="love-events-strip" data-love-events aria-label="Main events c·ªßa M·ªπ Uy√™n v√† Vi·ªát Ho√†">
        <div class="love-events-strip__head">
          <span class="love-events-strip__next" data-love-event-next>‚ö° THE UPCOMING EVENT</span>
          <button
            class="love-events-strip__admin-btn"
            type="button"
            data-love-events-admin-open
            aria-label="Th√™m event (admin)"
            title="Th√™m event (admin)"
          >
            ‚úö
          </button>
          <button
            class="love-events-strip__toggle"
            type="button"
            data-love-events-toggle
            aria-expanded="false"
            aria-controls="love-events-more"
            aria-label="M·ªü full timeline"
            title="M·ªü full timeline"
          >
            <span aria-hidden="true">‚ñæ</span>
          </button>
        </div>

        <div class="love-events-strip__rail love-events-strip__rail--featured" role="list" aria-label="Featured event timeline">
          <article
            class="love-event-chip"
            role="listitem"
            style="--event-accent: 116 218 255;"
            data-love-event
            data-love-event-id="viet-hoa-ve-viet-nam"
            data-love-event-group="featured"
            data-love-event-name="Vi·ªát Ho√† v·ªÅ Vi·ªát Nam"
            data-love-event-month="3"
            data-love-event-day="23"
            data-love-event-hour="21"
            data-love-event-minute="30"
            data-love-event-note="Ho√† v·ªÅ VN sau hai nƒÉm du h·ªçc sinh t·∫°i Nh·∫≠t - Master chuy√™n ng√†nh An ninh m·∫°ng."
          >
            <span class="love-event-chip__icon" aria-hidden="true">‚úàÔ∏é</span>
            <div class="love-event-chip__meta">
              <span class="love-event-chip__name">Vi·ªát Ho√† v·ªÅ Vi·ªát Nam</span>
              <span class="love-event-chip__date" data-love-event-date>23/03</span>
            </div>
            <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
            <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="Xem note event">‚ú¶</button>
          </article>
        </div>

        <div class="love-events-strip__more" id="love-events-more" data-love-events-more hidden>
          <div class="love-events-strip__rail love-events-strip__rail--extra" role="list" aria-label="Extra event timeline"></div>
        </div>
      </section>

      <div class="love-event-note-modal" data-love-event-note-modal hidden>
        <button class="love-event-note-modal__backdrop" type="button" data-love-event-note-close aria-label="ƒê√≥ng note event"></button>
        <section
          class="love-event-note-modal__card"
          role="dialog"
          aria-modal="true"
          aria-labelledby="love-event-note-title"
        >
          <div class="love-event-note-modal__eyebrow">EVENT NOTE</div>
          <h3 id="love-event-note-title" class="love-event-note-modal__title" data-love-event-note-title>Event</h3>
          <p class="love-event-note-modal__body" data-love-event-note-body>Ch∆∞a c√≥ ghi ch√∫.</p>
          <button class="love-event-note-modal__close" type="button" data-love-event-note-close>
            ƒê√≥ng
          </button>
        </section>
      </div>

      <div class="love-event-admin-modal" data-love-event-admin-modal hidden>
        <button class="love-event-admin-modal__backdrop" type="button" data-love-events-admin-close aria-label="ƒê√≥ng event admin"></button>
        <section class="love-event-admin-modal__card" role="dialog" aria-modal="true" aria-labelledby="love-event-admin-title">
          <div class="love-event-admin-modal__eyebrow">EVENT ADMIN</div>
          <h3 id="love-event-admin-title" class="love-event-admin-modal__title">Event Control</h3>

          <div class="love-event-admin-modal__auth" data-love-event-admin-auth>
            <label class="love-event-admin-modal__field">
              <span>Password</span>
              <input class="input" type="password" data-love-event-admin-password placeholder="Admin password" />
            </label>
            <button class="love-event-admin-modal__btn" type="button" data-love-event-admin-unlock>Unlock</button>
          </div>

          <div class="love-event-admin-modal__panel" data-love-event-admin-panel hidden>
            <div class="love-event-admin-modal__tabs" role="tablist" aria-label="Event admin mode">
              <button
                class="love-event-admin-modal__tab"
                type="button"
                role="tab"
                data-love-event-admin-tab="add"
                aria-selected="true"
              >
                Add
              </button>
              <button
                class="love-event-admin-modal__tab"
                type="button"
                role="tab"
                data-love-event-admin-tab="edit"
                aria-selected="false"
              >
                Edit Description
              </button>
            </div>

            <form class="love-event-admin-modal__form" data-love-event-admin-form>
              <label class="love-event-admin-modal__field">
                <span>Event title</span>
                <input class="input" name="name" required placeholder="T√™n s·ª± ki·ªán" />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Date</span>
                <input class="input" type="date" name="event_date" required />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Time (optional)</span>
                <input class="input" type="time" name="event_time" step="60" />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Icon</span>
                <input class="input" name="icon" maxlength="4" placeholder="‚úàÔ∏é" />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Group</span>
                <select class="input" name="event_group">
                  <option value="extra">Timeline</option>
                  <option value="featured">Featured</option>
                </select>
              </label>
              <label class="love-event-admin-modal__field">
                <span>Accent rgb (optional)</span>
                <input class="input" name="accent_rgb" placeholder="116 218 255" />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Description</span>
                <textarea class="input" name="note" rows="3" placeholder="M√¥ t·∫£ ng·∫Øn cho event"></textarea>
              </label>
              <button class="love-event-admin-modal__btn" type="submit">Push To Timeline</button>
            </form>

            <form class="love-event-admin-modal__form" data-love-event-admin-edit-form hidden>
              <label class="love-event-admin-modal__field">
                <span>Event</span>
                <select class="input" data-love-event-admin-edit-target required></select>
              </label>
              <label class="love-event-admin-modal__field">
                <span>Description</span>
                <textarea
                  class="input"
                  name="note"
                  rows="4"
                  data-love-event-admin-edit-note
                  placeholder="M√¥ t·∫£ s·∫Ω hi·ªÉn th·ªã khi b·∫•m icon note"
                ></textarea>
              </label>
              <button class="love-event-admin-modal__btn" type="submit">Save Description</button>
            </form>
          </div>

          <p class="love-event-admin-modal__status" data-love-event-admin-status></p>
        </section>
      </div>
    </div>

    <div class="love-widgets love-widgets--clocks" data-love-widgets>
      <div class="love-widgets__panel">
        <div class="love-widgets__clocks">
          <div class="love-widgets__clock" data-love-clock="vn">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üáªüá≥</span>
              VN
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="jp">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üáØüáµ</span>
              JP
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="us">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üá∫üá∏</span>
              NY
            </span>
            <strong>--:--</strong>
          </div>
        </div>
      </div>
    </div>
  </>
)}

{enabled && (
  <script is:inline>
    const initLoveWidgets = () => {
      const dayEl = document.querySelector("[data-love-day]");
      const clockRoot = document.querySelector("[data-love-widgets]");
      const eventRoot = document.querySelector("[data-love-events]");
      const featuredRail = eventRoot ? eventRoot.querySelector(".love-events-strip__rail--featured") : null;
      const extraRail = eventRoot ? eventRoot.querySelector(".love-events-strip__rail--extra") : null;
      const pastBanner = document.querySelector("[data-header-past-events]");
      const pastList = pastBanner ? pastBanner.querySelector("[data-header-past-events-list]") : null;
      const noteModal = document.querySelector("[data-love-event-note-modal]");
      const noteTitle = noteModal ? noteModal.querySelector("[data-love-event-note-title]") : null;
      const noteBody = noteModal ? noteModal.querySelector("[data-love-event-note-body]") : null;
      const adminOpenBtn = eventRoot ? eventRoot.querySelector("[data-love-events-admin-open]") : null;
      const adminModal = document.querySelector("[data-love-event-admin-modal]");
      const adminAuth = adminModal ? adminModal.querySelector("[data-love-event-admin-auth]") : null;
      const adminPanel = adminModal ? adminModal.querySelector("[data-love-event-admin-panel]") : null;
      const adminAddForm = adminModal ? adminModal.querySelector("[data-love-event-admin-form]") : null;
      const adminEditForm = adminModal ? adminModal.querySelector("[data-love-event-admin-edit-form]") : null;
      const adminEditTarget = adminModal ? adminModal.querySelector("[data-love-event-admin-edit-target]") : null;
      const adminEditNote = adminModal ? adminModal.querySelector("[data-love-event-admin-edit-note]") : null;
      const adminTabEls = adminModal ? adminModal.querySelectorAll("[data-love-event-admin-tab]") : [];
      const adminPasswordInput = adminModal ? adminModal.querySelector("[data-love-event-admin-password]") : null;
      const adminUnlockBtn = adminModal ? adminModal.querySelector("[data-love-event-admin-unlock]") : null;
      const adminStatus = adminModal ? adminModal.querySelector("[data-love-event-admin-status]") : null;
      const clockEls = clockRoot
        ? {
            vn: clockRoot.querySelector("[data-love-clock='vn'] strong"),
            jp: clockRoot.querySelector("[data-love-clock='jp'] strong"),
            us: clockRoot.querySelector("[data-love-clock='us'] strong"),
          }
        : {};
      const nextEventEl = eventRoot ? eventRoot.querySelector("[data-love-event-next]") : null;
      const eventToggleBtn = eventRoot ? eventRoot.querySelector("[data-love-events-toggle]") : null;
      const eventMorePanel = eventRoot ? eventRoot.querySelector("[data-love-events-more]") : null;
      let extraEventsCount = 0;

      const parseEventEl = (eventEl) => ({
        id:
          eventEl.getAttribute("data-love-event-id") ||
          [
            eventEl.getAttribute("data-love-event-name") || "event",
            eventEl.getAttribute("data-love-event-month") || "1",
            eventEl.getAttribute("data-love-event-day") || "1",
          ].join("__"),
        group: eventEl.getAttribute("data-love-event-group") || "extra",
        name: eventEl.getAttribute("data-love-event-name") || "event",
        month: Number(eventEl.getAttribute("data-love-event-month") || "1"),
        day: Number(eventEl.getAttribute("data-love-event-day") || "1"),
        hour: Number(eventEl.getAttribute("data-love-event-hour") || "0"),
        minute: Number(eventEl.getAttribute("data-love-event-minute") || "0"),
        note: eventEl.getAttribute("data-love-event-note") || "",
        icon:
          eventEl.querySelector(".love-event-chip__icon")?.textContent?.trim() || "‚ú¶",
        eventEl,
        countdownEl: eventEl.querySelector("[data-love-event-countdown]"),
        dateEl: eventEl.querySelector("[data-love-event-date]"),
        noteTrigger: eventEl.querySelector("[data-love-event-note-trigger]"),
      });

      const collectEventEls = () =>
        eventRoot
          ? Array.from(eventRoot.querySelectorAll("[data-love-event]")).map((eventEl) => parseEventEl(eventEl))
          : [];
      const refreshExtraEventsCount = () => {
        extraEventsCount = eventRoot
          ? eventRoot.querySelectorAll("[data-love-event-group='extra']").length
          : 0;
        return extraEventsCount;
      };

      let eventEls = collectEventEls();
      refreshExtraEventsCount();

      const startParts = { year: 2025, month: 12, day: 31 };
      const eventTimezoneOffsetMinutes = 7 * 60;
      const pastStorageKey = "twaw:past-events";
      const pad = (value) => String(value).padStart(2, "0");
      const globalState = window.__loveWidgetsState || {};
      let pastSnapshot = "";

      const getDateParts = (timeZone) => {
        const formatter = new Intl.DateTimeFormat("en-CA", {
          timeZone,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        const parts = formatter.formatToParts(new Date());
        const lookup = Object.fromEntries(parts.map((p) => [p.type, p.value]));
        return {
          year: Number(lookup.year),
          month: Number(lookup.month),
          day: Number(lookup.day),
        };
      };

      const updateDay = () => {
        if (!dayEl) return;
        const parts = getDateParts("Asia/Ho_Chi_Minh");
        const todayUtc = Date.UTC(parts.year, parts.month - 1, parts.day);
        const startUtc = Date.UTC(startParts.year, startParts.month - 1, startParts.day);
        const diff = Math.max(0, Math.floor((todayUtc - startUtc) / (1000 * 60 * 60 * 24)) + 1);
        dayEl.textContent = `DAY ${diff}`;
      };

      const eventTargetUtc = (year, month, day, hour, minute) =>
        Date.UTC(year, month - 1, day, hour, minute, 0) - eventTimezoneOffsetMinutes * 60 * 1000;

      const sortEventsForAdmin = () => {
        const nowTs = Date.now();
        const currentYear = getDateParts("Asia/Ho_Chi_Minh").year;
        return [...eventEls]
          .map((eventItem) => {
            const targetTs = eventTargetUtc(
              currentYear,
              eventItem.month,
              eventItem.day,
              eventItem.hour,
              eventItem.minute
            );
            const diff = targetTs - nowTs;
            const rank = diff >= 0 ? 0 : 1;
            return { eventItem, diff, rank };
          })
          .sort((a, b) => {
            if (a.rank !== b.rank) return a.rank - b.rank;
            if (a.rank === 0) return a.diff - b.diff;
            return b.diff - a.diff;
          })
          .map((entry) => entry.eventItem);
      };

      const findEventItemById = (id) => eventEls.find((eventItem) => eventItem.id === id);

      const formatCountdown = (diffMs) => {
        const totalSeconds = Math.max(0, Math.floor(diffMs / 1000));
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${days}D ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
      };

      const getCsrfToken = () => {
        const match = document.cookie.match(/(?:^|; )twaw_admin_csrf=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : "";
      };

      const createEventChip = ({
        id,
        name,
        month,
        day,
        hour = 0,
        minute = 0,
        eventGroup = "extra",
        icon = "‚ú¶",
        note = "",
        accentRgb = "",
      }) => {
        const article = document.createElement("article");
        article.className =
          eventGroup === "extra" ? "love-event-chip love-event-chip--extra" : "love-event-chip";
        article.setAttribute("role", "listitem");
        article.setAttribute("data-love-event", "");
        article.setAttribute("data-love-event-id", id);
        article.setAttribute("data-love-event-group", eventGroup);
        article.setAttribute("data-love-event-name", name);
        article.setAttribute("data-love-event-month", String(month));
        article.setAttribute("data-love-event-day", String(day));
        article.setAttribute("data-love-event-note", note || "");
        if (hour > 0 || minute > 0) {
          article.setAttribute("data-love-event-hour", String(hour));
          article.setAttribute("data-love-event-minute", String(minute));
        }
        const defaultAccent = eventGroup === "featured" ? "116 218 255" : "255 167 118";
        article.style.setProperty("--event-accent", accentRgb || defaultAccent);

        const iconEl = document.createElement("span");
        iconEl.className = "love-event-chip__icon";
        iconEl.setAttribute("aria-hidden", "true");
        iconEl.textContent = icon || "‚ú¶";

        const metaEl = document.createElement("div");
        metaEl.className = "love-event-chip__meta";

        const nameEl = document.createElement("span");
        nameEl.className = "love-event-chip__name";
        nameEl.textContent = name;

        const dateEl = document.createElement("span");
        dateEl.className = "love-event-chip__date";
        dateEl.setAttribute("data-love-event-date", "");
        dateEl.textContent = `${pad(day)}/${pad(month)}`;

        metaEl.appendChild(nameEl);
        metaEl.appendChild(dateEl);

        const countdownEl = document.createElement("strong");
        countdownEl.className = "love-event-chip__countdown";
        countdownEl.setAttribute("data-love-event-countdown", "");
        countdownEl.textContent = "--D --:--:--";

        const noteBtn = document.createElement("button");
        noteBtn.className = "love-event-chip__note-btn";
        noteBtn.type = "button";
        noteBtn.setAttribute("data-love-event-note-trigger", "");
        noteBtn.setAttribute("aria-label", "Xem note event");
        noteBtn.textContent = "‚ú¶";

        article.appendChild(iconEl);
        article.appendChild(metaEl);
        article.appendChild(countdownEl);
        article.appendChild(noteBtn);
        return article;
      };

      const readPastEvents = () => {
        try {
          const raw = window.localStorage.getItem(pastStorageKey);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (_error) {
          return [];
        }
      };

      const writePastEvents = (items) => {
        try {
          if (!items.length) {
            window.localStorage.removeItem(pastStorageKey);
            return;
          }
          window.localStorage.setItem(pastStorageKey, JSON.stringify(items));
        } catch (_error) {}
      };

      const renderPastEventsBanner = (items) => {
        if (!(pastBanner instanceof HTMLElement) || !(pastList instanceof HTMLElement)) return;
        pastList.textContent = "";
        if (!items.length) {
          pastBanner.hidden = true;
          return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
          const chip = document.createElement("span");
          chip.className = "header-past-events__item";
          chip.textContent = `${item.icon || "‚ú¶"} ${item.name}`;
          chip.title = `${item.name} ¬∑ ${pad(item.day)}/${pad(item.month)}/${item.year}`;
          fragment.appendChild(chip);
        });
        pastList.appendChild(fragment);
        pastBanner.hidden = false;
      };

      const hydratePastBannerFromStorage = () => {
        const currentYear = getDateParts("Asia/Ho_Chi_Minh").year;
        const items = readPastEvents()
          .filter((item) => Number(item?.year) === currentYear)
          .sort((a, b) => Number(b?.completedAt || 0) - Number(a?.completedAt || 0));
        renderPastEventsBanner(items);
      };

      const syncPastEvents = (items, currentYear) => {
        const normalized = items
          .map((item) => ({
            id: item.id,
            name: item.name,
            month: item.month,
            day: item.day,
            year: currentYear,
            icon: item.icon,
            completedAt: item.completedAt,
          }))
          .sort((a, b) => b.completedAt - a.completedAt);
        const snapshot = `${currentYear}:${normalized.map((item) => item.id).join("|")}`;
        if (snapshot === pastSnapshot) return;
        pastSnapshot = snapshot;
        writePastEvents(normalized);
        renderPastEventsBanner(normalized);
      };

      const setMorePanelState = (isOpen) => {
        if (!eventToggleBtn || !eventMorePanel) return;
        refreshExtraEventsCount();
        eventMorePanel.hidden = !isOpen;
        eventToggleBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        eventToggleBtn.setAttribute("aria-label", isOpen ? "·∫®n full timeline" : "M·ªü full timeline");
        eventToggleBtn.setAttribute(
          "title",
          isOpen ? "·∫®n full timeline" : `M·ªü full timeline (${extraEventsCount} s·ª± ki·ªán)`
        );
      };

      if (eventToggleBtn && eventMorePanel) {
        if (extraEventsCount <= 0) {
          eventToggleBtn.hidden = true;
          eventMorePanel.hidden = true;
        } else {
          setMorePanelState(false);
          if (eventToggleBtn.dataset.bound !== "1") {
            eventToggleBtn.dataset.bound = "1";
            eventToggleBtn.addEventListener("click", () => {
              const isOpen = eventToggleBtn.getAttribute("aria-expanded") === "true";
              setMorePanelState(!isOpen);
            });
          }
        }
      }

      const closeNoteModal = () => {
        if (!(noteModal instanceof HTMLElement)) return;
        noteModal.hidden = true;
        noteModal.dataset.open = "0";
      };

      const openNoteModal = (eventItem) => {
        if (
          !(noteModal instanceof HTMLElement) ||
          !(noteTitle instanceof HTMLElement) ||
          !(noteBody instanceof HTMLElement)
        ) {
          return;
        }
        noteTitle.textContent = eventItem.name;
        noteBody.textContent = eventItem.note || "No note yet.";
        noteModal.hidden = false;
        noteModal.dataset.open = "1";
      };

      const bindNoteTrigger = (eventItem) => {
        if (!(eventItem.noteTrigger instanceof HTMLButtonElement)) return;
        if (eventItem.noteTrigger.dataset.bound === "1") return;
        eventItem.noteTrigger.dataset.bound = "1";
        eventItem.noteTrigger.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          openNoteModal(eventItem);
        });
      };

      const bindAllNoteTriggers = () => {
        eventEls.forEach((eventItem) => bindNoteTrigger(eventItem));
      };

      const closeAdminModal = () => {
        if (!(adminModal instanceof HTMLElement)) return;
        adminModal.hidden = true;
        adminModal.dataset.open = "0";
      };

      const openAdminModal = () => {
        if (!(adminModal instanceof HTMLElement)) return;
        adminModal.hidden = false;
        adminModal.dataset.open = "1";
      };

      let adminUnlocked = false;
      const setAdminStatus = (message, variant = "info") => {
        if (!(adminStatus instanceof HTMLElement)) return;
        adminStatus.textContent = message;
        adminStatus.dataset.state = variant;
      };

      const setAdminUnlocked = (value) => {
        adminUnlocked = value;
        if (adminAuth instanceof HTMLElement) {
          adminAuth.hidden = value;
        }
        if (adminForm instanceof HTMLElement) {
          adminForm.hidden = !value;
        }
        if (value) {
          setAdminStatus("Unlocked. Push event m·ªõi ngay tr√™n ƒëi·ªán tho·∫°i.");
          if (adminPasswordInput instanceof HTMLInputElement) {
            adminPasswordInput.value = "";
          }
        }
      };

      if (noteModal instanceof HTMLElement && noteModal.dataset.bound !== "1") {
        noteModal.dataset.bound = "1";
        const closeEls = noteModal.querySelectorAll("[data-love-event-note-close]");
        closeEls.forEach((closeEl) => {
          closeEl.addEventListener("click", (event) => {
            event.preventDefault();
            closeNoteModal();
          });
        });
      }

      if (globalState.noteEscapeHandler) {
        document.removeEventListener("keydown", globalState.noteEscapeHandler);
      }
      globalState.noteEscapeHandler = (event) => {
        if (event.key === "Escape") {
          closeNoteModal();
          closeAdminModal();
        }
      };
      document.addEventListener("keydown", globalState.noteEscapeHandler);

      bindAllNoteTriggers();

      if (adminOpenBtn instanceof HTMLButtonElement && adminOpenBtn.dataset.bound !== "1") {
        adminOpenBtn.dataset.bound = "1";
        adminOpenBtn.addEventListener("click", (event) => {
          event.preventDefault();
          openAdminModal();
        });
      }

      if (adminModal instanceof HTMLElement && adminModal.dataset.bound !== "1") {
        adminModal.dataset.bound = "1";
        const closeEls = adminModal.querySelectorAll("[data-love-events-admin-close]");
        closeEls.forEach((closeEl) => {
          closeEl.addEventListener("click", (event) => {
            event.preventDefault();
            closeAdminModal();
          });
        });
      }

      const ensureAdminSession = async () => {
        try {
          const res = await fetch("/api/admin/session");
          const payload = await res.json().catch(() => null);
          setAdminUnlocked(Boolean(payload?.authenticated));
        } catch (_error) {
          setAdminUnlocked(false);
        }
      };

      if (adminUnlockBtn instanceof HTMLButtonElement && adminUnlockBtn.dataset.bound !== "1") {
        adminUnlockBtn.dataset.bound = "1";
        adminUnlockBtn.addEventListener("click", async (event) => {
          event.preventDefault();
          if (!(adminPasswordInput instanceof HTMLInputElement)) return;
          const password = adminPasswordInput.value.trim();
          if (!password) {
            setAdminStatus("Nh·∫≠p password tr∆∞·ªõc ƒë√£.", "error");
            return;
          }
          setAdminStatus("ƒêang verify password...");
          try {
            const res = await fetch("/api/admin/login", {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ password }),
            });
            const payload = await res.json().catch(() => null);
            if (!res.ok || !payload?.ok) {
              setAdminStatus(payload?.error || "Unlock failed.", "error");
              return;
            }
            setAdminUnlocked(true);
          } catch (_error) {
            setAdminStatus("Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi admin endpoint.", "error");
          }
        });
      }

      if (adminForm instanceof HTMLFormElement && adminForm.dataset.bound !== "1") {
        adminForm.dataset.bound = "1";
        adminForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!adminUnlocked) {
            setAdminStatus("C·∫ßn unlock b·∫±ng password tr∆∞·ªõc.", "error");
            return;
          }

          const fd = new FormData(adminForm);
          const name = String(fd.get("name") || "").trim();
          const dateRaw = String(fd.get("event_date") || "").trim();
          if (!name || !dateRaw) {
            setAdminStatus("Thi·∫øu t√™n ho·∫∑c ng√†y event.", "error");
            return;
          }

          const dateParts = dateRaw.split("-").map((part) => Number(part));
          if (dateParts.length !== 3 || dateParts.some((part) => !Number.isFinite(part))) {
            setAdminStatus("Ng√†y kh√¥ng h·ª£p l·ªá.", "error");
            return;
          }
          const month = Math.max(1, Math.min(12, dateParts[1]));
          const day = Math.max(1, Math.min(31, dateParts[2]));

          const timeRaw = String(fd.get("event_time") || "").trim();
          const [hhRaw = "0", mmRaw = "0"] = timeRaw ? timeRaw.split(":") : ["0", "0"];
          const hour = Math.max(0, Math.min(23, Number.parseInt(hhRaw, 10) || 0));
          const minute = Math.max(0, Math.min(59, Number.parseInt(mmRaw, 10) || 0));
          const eventGroup = fd.get("event_group") === "featured" ? "featured" : "extra";
          const icon = String(fd.get("icon") || "").trim();
          const note = String(fd.get("note") || "").trim();
          const accentRgb = String(fd.get("accent_rgb") || "").trim();
          const csrf = getCsrfToken();
          if (!csrf) {
            setAdminStatus("Thi·∫øu CSRF token, th·ª≠ unlock l·∫°i.", "error");
            return;
          }

          setAdminStatus("ƒêang push event l√™n timeline...");
          try {
            const res = await fetch("/api/admin/love-events", {
              method: "POST",
              headers: {
                "content-type": "application/json",
                "x-csrf-token": csrf,
              },
              body: JSON.stringify({
                name,
                month,
                day,
                hour,
                minute,
                event_group: eventGroup,
                icon,
                note,
                accent_rgb: accentRgb,
              }),
            });
            const payload = await res.json().catch(() => null);
            if (!res.ok || !payload?.ok || !payload?.event) {
              setAdminStatus(payload?.error || "Push event failed.", "error");
              return;
            }

            const created = payload.event;
            const targetRail =
              created.event_group === "featured" ? featuredRail : extraRail;
            if (!(targetRail instanceof HTMLElement)) {
              setAdminStatus("Kh√¥ng t√¨m th·∫•y event rail.", "error");
              return;
            }
            const chip = createEventChip({
              id: created.id,
              name: created.name,
              month: Number(created.month),
              day: Number(created.day),
              hour: Number(created.hour || 0),
              minute: Number(created.minute || 0),
              eventGroup: created.event_group === "featured" ? "featured" : "extra",
              icon: created.icon || "",
              note: created.note || "",
              accentRgb: created.accent_rgb || "",
            });
            targetRail.appendChild(chip);
            eventEls = collectEventEls();
            refreshExtraEventsCount();
            bindAllNoteTriggers();
            updateEvents();
            adminForm.reset();
            setAdminStatus("Pushed. Event ƒë√£ l√™n timeline.");
          } catch (_error) {
            setAdminStatus("Kh√¥ng th·ªÉ push event l√∫c n√†y.", "error");
          }
        });
      }

      ensureAdminSession();

      const hydrateRemoteEvents = async () => {
        if (!eventRoot) return;
        try {
          const res = await fetch("/api/love-events");
          const payload = await res.json().catch(() => null);
          if (!res.ok || !payload?.ok || !Array.isArray(payload.events)) return;

          const existingIds = new Set(
            Array.from(eventRoot.querySelectorAll("[data-love-event-id]"))
              .map((el) => el.getAttribute("data-love-event-id"))
              .filter(Boolean)
          );

          payload.events.forEach((item) => {
            const id = String(item?.id || "").trim();
            if (!id || existingIds.has(id)) return;
            const eventGroup = item?.event_group === "featured" ? "featured" : "extra";
            const targetRail = eventGroup === "featured" ? featuredRail : extraRail;
            if (!(targetRail instanceof HTMLElement)) return;
            const month = Number(item?.month || 1);
            const day = Number(item?.day || 1);
            const hour = Number(item?.hour || 0);
            const minute = Number(item?.minute || 0);
            const chip = createEventChip({
              id,
              name: String(item?.name || "Event"),
              month,
              day,
              hour,
              minute,
              eventGroup,
              icon: String(item?.icon || ""),
              note: String(item?.note || ""),
              accentRgb: String(item?.accent_rgb || ""),
            });
            targetRail.appendChild(chip);
            existingIds.add(id);
          });

          eventEls = collectEventEls();
          refreshExtraEventsCount();
          bindAllNoteTriggers();
          updateEvents();
        } catch (_error) {}
      };

      hydratePastBannerFromStorage();

      const updateEvents = () => {
        if (!eventEls.length) return;
        const nowTs = Date.now();
        const currentYear = getDateParts("Asia/Ho_Chi_Minh").year;
        const upcomingEntries = [];
        const pastEntries = [];
        let nearest = null;

        eventEls.forEach((eventItem) => {
          const targetTs = eventTargetUtc(
            currentYear,
            eventItem.month,
            eventItem.day,
            eventItem.hour,
            eventItem.minute
          );
          if (targetTs <= nowTs) {
            eventItem.eventEl.hidden = true;
            pastEntries.push({
              id: eventItem.id,
              name: eventItem.name,
              month: eventItem.month,
              day: eventItem.day,
              icon: eventItem.icon,
              completedAt: targetTs,
            });
            return;
          }

          eventItem.eventEl.hidden = false;
          const diff = Math.max(0, targetTs - nowTs);
          upcomingEntries.push({ eventItem, diff });
          if (eventItem.countdownEl) {
            eventItem.countdownEl.textContent = formatCountdown(diff);
          }
          if (eventItem.dateEl) {
            eventItem.dateEl.textContent = `${pad(eventItem.day)}/${pad(eventItem.month)} ¬∑ ${currentYear}`;
          }

          if (!nearest || diff < nearest.diff) {
            nearest = { name: eventItem.name, diff };
          }
        });

        syncPastEvents(pastEntries, currentYear);

        if (nextEventEl && nearest) {
          nextEventEl.textContent = "‚ö° THE UPCOMING EVENT";
          nextEventEl.setAttribute("title", nearest.name);
        } else if (nextEventEl) {
          nextEventEl.textContent = "‚ö° THE UPCOMING EVENT";
          nextEventEl.setAttribute("title", "No upcoming event");
        }

        const sortAndRender = (railEl, group) => {
          if (!(railEl instanceof HTMLElement)) return;
          const sorted = upcomingEntries
            .filter((entry) => entry.eventItem.group === group)
            .sort((a, b) => a.diff - b.diff);
          sorted.forEach(({ eventItem }) => {
            if (eventItem.eventEl instanceof HTMLElement) {
              railEl.appendChild(eventItem.eventEl);
            }
          });
        };

        sortAndRender(featuredRail, "featured");
        sortAndRender(extraRail, "extra");

        if (eventToggleBtn && eventMorePanel) {
          const hasUpcomingExtra = upcomingEntries.some((entry) => entry.eventItem.group === "extra");
          if (!hasUpcomingExtra) {
            eventToggleBtn.hidden = true;
            eventMorePanel.hidden = true;
          } else {
            eventToggleBtn.hidden = false;
            const isOpen = eventToggleBtn.getAttribute("aria-expanded") === "true";
            eventMorePanel.hidden = !isOpen;
          }
        }
      };

      hydrateRemoteEvents();

      const makeClock = (timeZone) =>
        new Intl.DateTimeFormat("en-GB", {
          timeZone,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

      const clocks = {
        vn: makeClock("Asia/Ho_Chi_Minh"),
        jp: makeClock("Asia/Tokyo"),
        us: makeClock("America/New_York"),
      };

      const tick = () => {
        const now = new Date();
        if (clockEls.vn) clockEls.vn.textContent = clocks.vn.format(now);
        if (clockEls.jp) clockEls.jp.textContent = clocks.jp.format(now);
        if (clockEls.us) clockEls.us.textContent = clocks.us.format(now);
        updateDay();
        updateEvents();
      };

      tick();

      if (globalState.timerId) {
        window.clearInterval(globalState.timerId);
      }
      globalState.timerId = window.setInterval(tick, 1000);
      window.__loveWidgetsState = globalState;
    };

    initLoveWidgets();
    document.addEventListener("astro:page-load", initLoveWidgets);
  </script>
)}
