---
const enabled = import.meta.env.PUBLIC_ENABLE_LOVE_WIDGETS !== "false";
---

{enabled && (
  <>
    <div class="love-counter-wrap mx-auto max-w-7xl px-5">
      <div class="love-counter-strip" data-love-counter>
        <span class="love-counter__icons" aria-hidden="true">‚ô•Ô∏é ‚ú∂ ‚òæ</span>
        <div class="love-counter__day" data-love-day>DAY 0</div>
        <div class="love-counter__since">since 31 Dec 2025</div>
      </div>

      <section class="love-events-strip" data-love-events aria-label="Main events c·ªßa M·ªπ Uy√™n v√† Vi·ªát Ho√†">
        <div class="love-events-strip__head">
          <span class="love-events-strip__next" data-love-event-next>‚ö° THE UPCOMING EVENT</span>
          <button
            class="love-events-strip__toggle"
            type="button"
            data-love-events-toggle
            aria-expanded="false"
            aria-controls="love-events-more"
            aria-label="M·ªü full timeline"
            title="M·ªü full timeline"
          >
            <span aria-hidden="true">‚ñæ</span>
          </button>
        </div>

        <div class="love-events-strip__rail love-events-strip__rail--featured" role="list" aria-label="Featured event timeline">
          <article
            class="love-event-chip"
            role="listitem"
            style="--event-accent: 255 141 177;"
            data-love-event
            data-love-event-group="featured"
            data-love-event-name="Sinh nh·∫≠t M·ªπ Uy√™n"
            data-love-event-month="3"
            data-love-event-day="17"
            data-love-event-note="Sinh nh·∫≠t em b√© M·ªπ Uy√™n. Ng√†y ƒë·∫∑c bi·ªát nh·∫•t th√°ng 3."
          >
            <span class="love-event-chip__icon" aria-hidden="true">üéÇ</span>
            <div class="love-event-chip__meta">
              <span class="love-event-chip__name">Sinh nh·∫≠t M·ªπ Uy√™n</span>
              <span class="love-event-chip__date" data-love-event-date>17/03</span>
            </div>
            <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
            <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="Xem note event">‚ú¶</button>
          </article>

          <article
            class="love-event-chip"
            role="listitem"
            style="--event-accent: 116 218 255;"
            data-love-event
            data-love-event-group="featured"
            data-love-event-name="Vi·ªát Ho√† v·ªÅ Vi·ªát Nam"
            data-love-event-month="3"
            data-love-event-day="23"
            data-love-event-hour="21"
            data-love-event-minute="30"
            data-love-event-note="Ho√† v·ªÅ VN sau hai nƒÉm du h·ªçc sinh t·∫°i Nh·∫≠t - Master chuy√™n ng√†nh An ninh m·∫°ng."
          >
            <span class="love-event-chip__icon" aria-hidden="true">‚úàÔ∏é</span>
            <div class="love-event-chip__meta">
              <span class="love-event-chip__name">Vi·ªát Ho√† v·ªÅ Vi·ªát Nam</span>
              <span class="love-event-chip__date" data-love-event-date>23/03</span>
            </div>
            <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
            <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="Xem note event">‚ú¶</button>
          </article>
        </div>

        <div class="love-events-strip__more" id="love-events-more" data-love-events-more hidden>
          <div class="love-events-strip__rail love-events-strip__rail--extra" role="list" aria-label="Extra event timeline">
            <article
              class="love-event-chip love-event-chip--extra"
              role="listitem"
              style="--event-accent: 255 205 118;"
              data-love-event
              data-love-event-group="extra"
              data-love-event-name="Sinh nh·∫≠t Vi·ªát Ho√†"
              data-love-event-month="6"
              data-love-event-day="4"
              data-love-event-note="Sinh nh·∫≠t c·ªßa Ho√†, ng√†y reset nƒÉng l∆∞·ª£ng ƒë·ªÉ b·∫Øt ƒë·∫ßu chapter m·ªõi."
            >
              <span class="love-event-chip__icon" aria-hidden="true">üéâ</span>
              <div class="love-event-chip__meta">
                <span class="love-event-chip__name">Sinh nh·∫≠t Vi·ªát Ho√†</span>
                <span class="love-event-chip__date" data-love-event-date>04/06</span>
              </div>
              <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
              <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="Xem note event">‚ú¶</button>
            </article>

            <article
              class="love-event-chip love-event-chip--extra"
              role="listitem"
              style="--event-accent: 186 255 158;"
              data-love-event
              data-love-event-group="extra"
              data-love-event-name="Valentine Day"
              data-love-event-month="2"
              data-love-event-day="14"
              data-love-event-note="Valentine, m·ªôt ƒëi·ªÉm neo c·∫£m x√∫c cho nh·ªØng th·ª© kh√¥ng n√≥i th√†nh l·ªùi."
            >
              <span class="love-event-chip__icon" aria-hidden="true">üíå</span>
              <div class="love-event-chip__meta">
                <span class="love-event-chip__name">Valentine Day</span>
                <span class="love-event-chip__date" data-love-event-date>14/02</span>
              </div>
              <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
              <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="Xem note event">‚ú¶</button>
            </article>

            <article
              class="love-event-chip love-event-chip--extra"
              role="listitem"
              style="--event-accent: 255 167 118;"
              data-love-event
              data-love-event-group="extra"
              data-love-event-name="Anniversary 1 Year"
              data-love-event-month="12"
              data-love-event-day="31"
              data-love-event-note="Anniversary 1 nƒÉm, checkpoint l·ªõn c·ªßa c·∫£ hai sau m·ªôt nƒÉm ƒë·ªìng h√†nh."
            >
              <span class="love-event-chip__icon" aria-hidden="true">ü•Ç</span>
              <div class="love-event-chip__meta">
                <span class="love-event-chip__name">Anniversary 1 Year</span>
                <span class="love-event-chip__date" data-love-event-date>31/12</span>
              </div>
              <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
              <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="Xem note event">‚ú¶</button>
            </article>
          </div>
        </div>
      </section>

      <div class="love-event-note-modal" data-love-event-note-modal hidden>
        <button class="love-event-note-modal__backdrop" type="button" data-love-event-note-close aria-label="ƒê√≥ng note event"></button>
        <section
          class="love-event-note-modal__card"
          role="dialog"
          aria-modal="true"
          aria-labelledby="love-event-note-title"
        >
          <div class="love-event-note-modal__eyebrow">EVENT NOTE</div>
          <h3 id="love-event-note-title" class="love-event-note-modal__title" data-love-event-note-title>Event</h3>
          <p class="love-event-note-modal__body" data-love-event-note-body>No note yet.</p>
          <button class="love-event-note-modal__close" type="button" data-love-event-note-close>
            Close
          </button>
        </section>
      </div>
    </div>

    <div class="love-widgets love-widgets--clocks" data-love-widgets>
      <div class="love-widgets__panel">
        <div class="love-widgets__clocks">
          <div class="love-widgets__clock" data-love-clock="vn">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üáªüá≥</span>
              VN
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="jp">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üáØüáµ</span>
              JP
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="us">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üá∫üá∏</span>
              NY
            </span>
            <strong>--:--</strong>
          </div>
        </div>
      </div>
    </div>
  </>
)}

{enabled && (
  <script is:inline>
    const initLoveWidgets = () => {
      const dayEl = document.querySelector("[data-love-day]");
      const clockRoot = document.querySelector("[data-love-widgets]");
      const eventRoot = document.querySelector("[data-love-events]");
      const featuredRail = eventRoot ? eventRoot.querySelector(".love-events-strip__rail--featured") : null;
      const extraRail = eventRoot ? eventRoot.querySelector(".love-events-strip__rail--extra") : null;
      const pastBanner = document.querySelector("[data-header-past-events]");
      const pastList = pastBanner ? pastBanner.querySelector("[data-header-past-events-list]") : null;
      const noteModal = document.querySelector("[data-love-event-note-modal]");
      const noteTitle = noteModal ? noteModal.querySelector("[data-love-event-note-title]") : null;
      const noteBody = noteModal ? noteModal.querySelector("[data-love-event-note-body]") : null;
      const clockEls = clockRoot
        ? {
            vn: clockRoot.querySelector("[data-love-clock='vn'] strong"),
            jp: clockRoot.querySelector("[data-love-clock='jp'] strong"),
            us: clockRoot.querySelector("[data-love-clock='us'] strong"),
          }
        : {};
      const nextEventEl = eventRoot ? eventRoot.querySelector("[data-love-event-next]") : null;
      const eventToggleBtn = eventRoot ? eventRoot.querySelector("[data-love-events-toggle]") : null;
      const eventMorePanel = eventRoot ? eventRoot.querySelector("[data-love-events-more]") : null;
      const extraEventsCount = eventRoot
        ? eventRoot.querySelectorAll("[data-love-event-group='extra']").length
        : 0;
      const eventEls = eventRoot
        ? Array.from(eventRoot.querySelectorAll("[data-love-event]")).map((eventEl) => ({
            id: [
              eventEl.getAttribute("data-love-event-name") || "event",
              eventEl.getAttribute("data-love-event-month") || "1",
              eventEl.getAttribute("data-love-event-day") || "1",
            ].join("__"),
            group: eventEl.getAttribute("data-love-event-group") || "extra",
            name: eventEl.getAttribute("data-love-event-name") || "event",
            month: Number(eventEl.getAttribute("data-love-event-month") || "1"),
            day: Number(eventEl.getAttribute("data-love-event-day") || "1"),
            hour: Number(eventEl.getAttribute("data-love-event-hour") || "0"),
            minute: Number(eventEl.getAttribute("data-love-event-minute") || "0"),
            note: eventEl.getAttribute("data-love-event-note") || "No note yet.",
            icon:
              eventEl.querySelector(".love-event-chip__icon")?.textContent?.trim() || "‚ú¶",
            eventEl,
            countdownEl: eventEl.querySelector("[data-love-event-countdown]"),
            dateEl: eventEl.querySelector("[data-love-event-date]"),
            noteTrigger: eventEl.querySelector("[data-love-event-note-trigger]"),
          }))
        : [];

      const startParts = { year: 2025, month: 12, day: 31 };
      const eventTimezoneOffsetMinutes = 7 * 60;
      const pastStorageKey = "twaw:past-events";
      const pad = (value) => String(value).padStart(2, "0");
      const globalState = window.__loveWidgetsState || {};
      let pastSnapshot = "";

      const getDateParts = (timeZone) => {
        const formatter = new Intl.DateTimeFormat("en-CA", {
          timeZone,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
        });
        const parts = formatter.formatToParts(new Date());
        const lookup = Object.fromEntries(parts.map((p) => [p.type, p.value]));
        return {
          year: Number(lookup.year),
          month: Number(lookup.month),
          day: Number(lookup.day),
        };
      };

      const updateDay = () => {
        if (!dayEl) return;
        const parts = getDateParts("Asia/Ho_Chi_Minh");
        const todayUtc = Date.UTC(parts.year, parts.month - 1, parts.day);
        const startUtc = Date.UTC(startParts.year, startParts.month - 1, startParts.day);
        const diff = Math.max(0, Math.floor((todayUtc - startUtc) / (1000 * 60 * 60 * 24)) + 1);
        dayEl.textContent = `DAY ${diff}`;
      };

      const eventTargetUtc = (year, month, day, hour, minute) =>
        Date.UTC(year, month - 1, day, hour, minute, 0) - eventTimezoneOffsetMinutes * 60 * 1000;

      const formatCountdown = (diffMs) => {
        const totalSeconds = Math.max(0, Math.floor(diffMs / 1000));
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${days}D ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
      };

      const readPastEvents = () => {
        try {
          const raw = window.localStorage.getItem(pastStorageKey);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (_error) {
          return [];
        }
      };

      const writePastEvents = (items) => {
        try {
          if (!items.length) {
            window.localStorage.removeItem(pastStorageKey);
            return;
          }
          window.localStorage.setItem(pastStorageKey, JSON.stringify(items));
        } catch (_error) {}
      };

      const renderPastEventsBanner = (items) => {
        if (!(pastBanner instanceof HTMLElement) || !(pastList instanceof HTMLElement)) return;
        pastList.textContent = "";
        if (!items.length) {
          pastBanner.hidden = true;
          return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
          const chip = document.createElement("span");
          chip.className = "header-past-events__item";
          chip.textContent = `${item.icon || "‚ú¶"} ${item.name}`;
          chip.title = `${item.name} ¬∑ ${pad(item.day)}/${pad(item.month)}/${item.year}`;
          fragment.appendChild(chip);
        });
        pastList.appendChild(fragment);
        pastBanner.hidden = false;
      };

      const hydratePastBannerFromStorage = () => {
        const currentYear = getDateParts("Asia/Ho_Chi_Minh").year;
        const items = readPastEvents()
          .filter((item) => Number(item?.year) === currentYear)
          .sort((a, b) => Number(b?.completedAt || 0) - Number(a?.completedAt || 0));
        renderPastEventsBanner(items);
      };

      const syncPastEvents = (items, currentYear) => {
        const normalized = items
          .map((item) => ({
            id: item.id,
            name: item.name,
            month: item.month,
            day: item.day,
            year: currentYear,
            icon: item.icon,
            completedAt: item.completedAt,
          }))
          .sort((a, b) => b.completedAt - a.completedAt);
        const snapshot = `${currentYear}:${normalized.map((item) => item.id).join("|")}`;
        if (snapshot === pastSnapshot) return;
        pastSnapshot = snapshot;
        writePastEvents(normalized);
        renderPastEventsBanner(normalized);
      };

      const setMorePanelState = (isOpen) => {
        if (!eventToggleBtn || !eventMorePanel) return;
        eventMorePanel.hidden = !isOpen;
        eventToggleBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        eventToggleBtn.setAttribute("aria-label", isOpen ? "·∫®n full timeline" : "M·ªü full timeline");
        eventToggleBtn.setAttribute(
          "title",
          isOpen ? "·∫®n full timeline" : `M·ªü full timeline (${extraEventsCount} s·ª± ki·ªán)`
        );
      };

      if (eventToggleBtn && eventMorePanel) {
        if (extraEventsCount <= 0) {
          eventToggleBtn.hidden = true;
          eventMorePanel.hidden = true;
        } else {
          setMorePanelState(false);
          if (eventToggleBtn.dataset.bound !== "1") {
            eventToggleBtn.dataset.bound = "1";
            eventToggleBtn.addEventListener("click", () => {
              const isOpen = eventToggleBtn.getAttribute("aria-expanded") === "true";
              setMorePanelState(!isOpen);
            });
          }
        }
      }

      const closeNoteModal = () => {
        if (!(noteModal instanceof HTMLElement)) return;
        noteModal.hidden = true;
        noteModal.dataset.open = "0";
      };

      const openNoteModal = (eventItem) => {
        if (
          !(noteModal instanceof HTMLElement) ||
          !(noteTitle instanceof HTMLElement) ||
          !(noteBody instanceof HTMLElement)
        ) {
          return;
        }
        noteTitle.textContent = eventItem.name;
        noteBody.textContent = eventItem.note || "No note yet.";
        noteModal.hidden = false;
        noteModal.dataset.open = "1";
      };

      if (noteModal instanceof HTMLElement && noteModal.dataset.bound !== "1") {
        noteModal.dataset.bound = "1";
        const closeEls = noteModal.querySelectorAll("[data-love-event-note-close]");
        closeEls.forEach((closeEl) => {
          closeEl.addEventListener("click", (event) => {
            event.preventDefault();
            closeNoteModal();
          });
        });
      }

      if (globalState.noteEscapeHandler) {
        document.removeEventListener("keydown", globalState.noteEscapeHandler);
      }
      globalState.noteEscapeHandler = (event) => {
        if (event.key === "Escape") closeNoteModal();
      };
      document.addEventListener("keydown", globalState.noteEscapeHandler);

      eventEls.forEach((eventItem) => {
        if (!(eventItem.noteTrigger instanceof HTMLButtonElement)) return;
        if (eventItem.noteTrigger.dataset.bound === "1") return;
        eventItem.noteTrigger.dataset.bound = "1";
        eventItem.noteTrigger.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          openNoteModal(eventItem);
        });
      });

      hydratePastBannerFromStorage();

      const updateEvents = () => {
        if (!eventEls.length) return;
        const nowTs = Date.now();
        const currentYear = getDateParts("Asia/Ho_Chi_Minh").year;
        const upcomingEntries = [];
        const pastEntries = [];
        let nearest = null;

        eventEls.forEach((eventItem) => {
          const targetTs = eventTargetUtc(
            currentYear,
            eventItem.month,
            eventItem.day,
            eventItem.hour,
            eventItem.minute
          );
          if (targetTs <= nowTs) {
            eventItem.eventEl.hidden = true;
            pastEntries.push({
              id: eventItem.id,
              name: eventItem.name,
              month: eventItem.month,
              day: eventItem.day,
              icon: eventItem.icon,
              completedAt: targetTs,
            });
            return;
          }

          eventItem.eventEl.hidden = false;
          const diff = Math.max(0, targetTs - nowTs);
          upcomingEntries.push({ eventItem, diff });
          if (eventItem.countdownEl) {
            eventItem.countdownEl.textContent = formatCountdown(diff);
          }
          if (eventItem.dateEl) {
            eventItem.dateEl.textContent = `${pad(eventItem.day)}/${pad(eventItem.month)} ¬∑ ${currentYear}`;
          }

          if (!nearest || diff < nearest.diff) {
            nearest = { name: eventItem.name, diff };
          }
        });

        syncPastEvents(pastEntries, currentYear);

        if (nextEventEl && nearest) {
          nextEventEl.textContent = "‚ö° THE UPCOMING EVENT";
          nextEventEl.setAttribute("title", nearest.name);
        } else if (nextEventEl) {
          nextEventEl.textContent = "‚ö° THE UPCOMING EVENT";
          nextEventEl.setAttribute("title", "No upcoming event");
        }

        const sortAndRender = (railEl, group) => {
          if (!(railEl instanceof HTMLElement)) return;
          const sorted = upcomingEntries
            .filter((entry) => entry.eventItem.group === group)
            .sort((a, b) => a.diff - b.diff);
          sorted.forEach(({ eventItem }) => {
            if (eventItem.eventEl instanceof HTMLElement) {
              railEl.appendChild(eventItem.eventEl);
            }
          });
        };

        sortAndRender(featuredRail, "featured");
        sortAndRender(extraRail, "extra");

        if (eventToggleBtn && eventMorePanel) {
          const hasUpcomingExtra = upcomingEntries.some((entry) => entry.eventItem.group === "extra");
          if (!hasUpcomingExtra) {
            eventToggleBtn.hidden = true;
            eventMorePanel.hidden = true;
          } else {
            eventToggleBtn.hidden = false;
            const isOpen = eventToggleBtn.getAttribute("aria-expanded") === "true";
            eventMorePanel.hidden = !isOpen;
          }
        }
      };

      const makeClock = (timeZone) =>
        new Intl.DateTimeFormat("en-GB", {
          timeZone,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

      const clocks = {
        vn: makeClock("Asia/Ho_Chi_Minh"),
        jp: makeClock("Asia/Tokyo"),
        us: makeClock("America/New_York"),
      };

      const tick = () => {
        const now = new Date();
        if (clockEls.vn) clockEls.vn.textContent = clocks.vn.format(now);
        if (clockEls.jp) clockEls.jp.textContent = clocks.jp.format(now);
        if (clockEls.us) clockEls.us.textContent = clocks.us.format(now);
        updateDay();
        updateEvents();
      };

      tick();

      if (globalState.timerId) {
        window.clearInterval(globalState.timerId);
      }
      globalState.timerId = window.setInterval(tick, 1000);
      window.__loveWidgetsState = globalState;
    };

    initLoveWidgets();
    document.addEventListener("astro:page-load", initLoveWidgets);
  </script>
)}
