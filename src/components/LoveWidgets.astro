---
const enabled = import.meta.env.PUBLIC_ENABLE_LOVE_WIDGETS !== "false";
---

{enabled && (
  <>
    <div class="love-counter-wrap mx-auto max-w-7xl px-5">
      <div class="love-counter-strip" data-love-counter>
        <span class="love-counter__icons" aria-hidden="true">‚ô•Ô∏é ‚ú∂ ‚òæ</span>
        <div class="love-counter__day" data-love-day>DAY 0</div>
        <div class="love-counter__since">since 2026</div>
      </div>

      <section class="love-events-strip" data-love-events aria-label="Events for My Uyen and Viet Hoa">
        <div class="love-events-strip__head">
          <span class="love-events-strip__next" data-love-event-next>‚ö° THE UPCOMING EVENT</span>
          <button
            class="love-events-strip__admin-btn"
            type="button"
            data-love-events-admin-open
            aria-label="Add event (admin)"
            title="Add event (admin)"
          >
            ‚úö
          </button>
          <button
            class="love-events-strip__toggle"
            type="button"
            data-love-events-toggle
            aria-expanded="false"
            aria-controls="love-events-more"
            aria-label="Open full timeline"
            title="Open full timeline"
          >
            <span aria-hidden="true">‚ñæ</span>
          </button>
        </div>

        <div class="love-events-strip__rail love-events-strip__rail--featured" role="list" aria-label="S·ª± ki·ªán ch√≠nh">
          <article
            class="love-event-chip"
            role="listitem"
            style="--event-accent: 255 141 177;"
            data-love-event
            data-love-event-id="sinh-nhat-my-uyen"
            data-love-event-group="featured"
            data-love-event-name="Sinh nh·∫≠t M·ªπ Uy√™n"
            data-love-event-month="3"
            data-love-event-day="17"
            data-love-event-note="Sinh nh·∫≠t con v·ªãu ∆°"
          >
            <span class="love-event-chip__icon" aria-hidden="true">üéÇ</span>
            <div class="love-event-chip__meta">
              <span class="love-event-chip__name">Sinh nh·∫≠t M·ªπ Uy√™n</span>
              <span class="love-event-chip__date" data-love-event-date>17/03</span>
            </div>
            <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
            <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="View event note">‚ú¶</button>
          </article>

          <article
            class="love-event-chip"
            role="listitem"
            style="--event-accent: 116 218 255;"
            data-love-event
            data-love-event-id="viet-hoa-ve-viet-nam"
            data-love-event-group="featured"
            data-love-event-name="Vi·ªát Ho√† v·ªÅ Vi·ªát Nam"
            data-love-event-month="3"
            data-love-event-day="23"
            data-love-event-hour="21"
            data-love-event-minute="30"
            data-love-event-note="Ho√† v·ªÅ VN sau hai nƒÉm du h·ªçc sinh t·∫°i Nh·∫≠t - Master chuy√™n ng√†nh An ninh m·∫°ng."
          >
            <span class="love-event-chip__icon" aria-hidden="true">‚úàÔ∏é</span>
            <div class="love-event-chip__meta">
              <span class="love-event-chip__name">Vi·ªát Ho√† v·ªÅ Vi·ªát Nam</span>
              <span class="love-event-chip__date" data-love-event-date>23/03</span>
            </div>
            <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
            <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="View event note">‚ú¶</button>
          </article>
        </div>

        <div class="love-events-strip__more" id="love-events-more" data-love-events-more hidden>
          <div class="love-events-strip__rail love-events-strip__rail--extra" role="list" aria-label="S·ª± ki·ªán pending">
            <article
              class="love-event-chip love-event-chip--extra"
              role="listitem"
              style="--event-accent: 255 205 118;"
              data-love-event
              data-love-event-id="sinh-nhat-viet-hoa"
              data-love-event-group="extra"
              data-love-event-name="Sinh nh·∫≠t Vi·ªát Ho√†"
              data-love-event-month="6"
              data-love-event-day="4"
              data-love-event-note="t l·∫°i ki·∫øm g√≥c n√†o v√† tr·ªën m·∫•t cho xem"
            >
              <span class="love-event-chip__icon" aria-hidden="true">üéâ</span>
              <div class="love-event-chip__meta">
                <span class="love-event-chip__name">Sinh nh·∫≠t Vi·ªát Ho√†</span>
                <span class="love-event-chip__date" data-love-event-date>04/06</span>
              </div>
              <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
              <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="View event note">‚ú¶</button>
            </article>

            <article
              class="love-event-chip love-event-chip--extra"
              role="listitem"
              style="--event-accent: 186 255 158;"
              data-love-event
              data-love-event-id="valentine-day"
              data-love-event-group="extra"
              data-love-event-name="Valentine Day"
              data-love-event-month="2"
              data-love-event-day="14"
              data-love-event-note="Valentine, m·ªôt ƒëi·ªÉm neo c·∫£m x√∫c cho nh·ªØng th·ª© kh√¥ng n√≥i th√†nh l·ªùi."
            >
              <span class="love-event-chip__icon" aria-hidden="true">üíå</span>
              <div class="love-event-chip__meta">
                <span class="love-event-chip__name">Valentine Day</span>
                <span class="love-event-chip__date" data-love-event-date>14/02</span>
              </div>
              <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
              <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="View event note">‚ú¶</button>
            </article>

            <article
              class="love-event-chip love-event-chip--extra"
              role="listitem"
              style="--event-accent: 255 167 118;"
              data-love-event
              data-love-event-id="anniversary-1-year"
              data-love-event-group="extra"
              data-love-event-name="Anniversary 1 Year"
              data-love-event-month="12"
              data-love-event-day="31"
              data-love-event-note="c√≥ nh·∫Øm l√† ƒë·∫øn ƒë∆∞·ª£c ng√†y n√†y kh√¥ng ?"
            >
              <span class="love-event-chip__icon" aria-hidden="true">ü•Ç</span>
              <div class="love-event-chip__meta">
                <span class="love-event-chip__name">Anniversary 1 Year</span>
                <span class="love-event-chip__date" data-love-event-date>31/12</span>
              </div>
              <strong class="love-event-chip__countdown" data-love-event-countdown>--D --:--:--</strong>
              <button class="love-event-chip__note-btn" type="button" data-love-event-note-trigger aria-label="View event note">‚ú¶</button>
            </article>
          </div>
        </div>
      </section>

      <div class="love-event-note-modal" data-love-event-note-modal hidden>
        <button class="love-event-note-modal__backdrop" type="button" data-love-event-note-close aria-label="Close event note"></button>
        <section
          class="love-event-note-modal__card"
          role="dialog"
          aria-modal="true"
          aria-labelledby="love-event-note-title"
        >
          <div class="love-event-note-modal__eyebrow">EVENT NOTE</div>
          <h3 id="love-event-note-title" class="love-event-note-modal__title" data-love-event-note-title>Event</h3>
          <p class="love-event-note-modal__body" data-love-event-note-body>No note yet.</p>
          <button class="love-event-note-modal__close" type="button" data-love-event-note-close>
            Close
          </button>
        </section>
      </div>

      <div class="love-event-admin-modal" data-love-event-admin-modal hidden>
        <button class="love-event-admin-modal__backdrop" type="button" data-love-events-admin-close aria-label="Close event admin"></button>
        <section class="love-event-admin-modal__card" role="dialog" aria-modal="true" aria-labelledby="love-event-admin-title">
          <div class="love-event-admin-modal__eyebrow">EVENT ADMIN</div>
          <h3 id="love-event-admin-title" class="love-event-admin-modal__title">Event Control</h3>

          <div class="love-event-admin-modal__auth" data-love-event-admin-auth>
            <label class="love-event-admin-modal__field">
              <span>Password</span>
              <input class="input" type="password" data-love-event-admin-password placeholder="Admin password" />
            </label>
            <button class="love-event-admin-modal__btn" type="button" data-love-event-admin-unlock>Unlock</button>
          </div>

          <div class="love-event-admin-modal__panel" data-love-event-admin-panel hidden>
            <div class="love-event-admin-modal__tabs" role="tablist" aria-label="Event admin mode">
              <button
                class="love-event-admin-modal__tab"
                type="button"
                role="tab"
                data-love-event-admin-tab="add"
                aria-selected="true"
              >
                Add New
              </button>
              <button
                class="love-event-admin-modal__tab"
                type="button"
                role="tab"
                data-love-event-admin-tab="edit"
                aria-selected="false"
              >
                Edit Description
              </button>
            </div>

            <form class="love-event-admin-modal__form" data-love-event-admin-form>
              <label class="love-event-admin-modal__field">
                <span>Event title</span>
                <input class="input" name="name" required placeholder="Event title" />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Date</span>
                <input class="input" type="date" name="event_date" required />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Time (optional)</span>
                <input class="input" type="time" name="event_time" step="60" />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Icon</span>
                <input class="input" name="icon" maxlength="4" placeholder="‚úàÔ∏é" />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Group</span>
                <select class="input" name="event_group">
                  <option value="featured">S·ª± ki·ªán ch√≠nh</option>
                  <option value="extra">S·ª± ki·ªán pending</option>
                </select>
              </label>
              <label class="love-event-admin-modal__field">
                <span>Accent rgb (optional)</span>
                <input class="input" name="accent_rgb" placeholder="116 218 255" />
              </label>
              <label class="love-event-admin-modal__field">
                <span>Description</span>
                <textarea class="input" name="note" rows="3" required placeholder="Short event description"></textarea>
              </label>
              <button class="love-event-admin-modal__btn" type="submit">Push To Timeline</button>
            </form>

            <form class="love-event-admin-modal__form" data-love-event-admin-edit-form hidden>
              <label class="love-event-admin-modal__field">
                <span>Event</span>
                <select class="input" data-love-event-admin-edit-target required></select>
              </label>
              <label class="love-event-admin-modal__field">
                <span>Description</span>
                <textarea
                  class="input"
                  name="note"
                  rows="4"
                  data-love-event-admin-edit-note
                  required
                  placeholder="Description shown when clicking the note icon"
                ></textarea>
              </label>
              <button class="love-event-admin-modal__btn" type="submit">Save Description</button>
            </form>
          </div>

          <p class="love-event-admin-modal__status" data-love-event-admin-status></p>
        </section>
      </div>
    </div>

    <div class="love-widgets love-widgets--clocks" data-love-widgets>
      <div class="love-widgets__panel">
        <div class="love-widgets__clocks">
          <div class="love-widgets__clock" data-love-clock="vn">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üáªüá≥</span>
              VN
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="jp">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üáØüáµ</span>
              JP
            </span>
            <strong>--:--</strong>
          </div>
          <div class="love-widgets__clock" data-love-clock="us">
            <span class="love-widgets__label">
              <span class="love-widgets__flag" aria-hidden="true">üá∫üá∏</span>
              NY
            </span>
            <strong>--:--</strong>
          </div>
        </div>
      </div>
    </div>
  </>
)}

{enabled && (
  <script is:inline>
    const initLoveWidgets = () => {
      const dayEl = document.querySelector("[data-love-day]");
      const clockRoot = document.querySelector("[data-love-widgets]");
      const eventRoot = document.querySelector("[data-love-events]");
      const featuredRail = eventRoot ? eventRoot.querySelector(".love-events-strip__rail--featured") : null;
      const extraRail = eventRoot ? eventRoot.querySelector(".love-events-strip__rail--extra") : null;
      const pastBanner = document.querySelector("[data-header-past-events]");
      const pastList = pastBanner ? pastBanner.querySelector("[data-header-past-events-list]") : null;
      const noteModal = document.querySelector("[data-love-event-note-modal]");
      const noteTitle = noteModal ? noteModal.querySelector("[data-love-event-note-title]") : null;
      const noteBody = noteModal ? noteModal.querySelector("[data-love-event-note-body]") : null;
      const adminOpenBtn = eventRoot ? eventRoot.querySelector("[data-love-events-admin-open]") : null;
      const adminModal = document.querySelector("[data-love-event-admin-modal]");
      const adminAuth = adminModal ? adminModal.querySelector("[data-love-event-admin-auth]") : null;
      const adminPanel = adminModal ? adminModal.querySelector("[data-love-event-admin-panel]") : null;
      const adminAddForm = adminModal ? adminModal.querySelector("[data-love-event-admin-form]") : null;
      const adminEditForm = adminModal ? adminModal.querySelector("[data-love-event-admin-edit-form]") : null;
      const adminEditTarget = adminModal ? adminModal.querySelector("[data-love-event-admin-edit-target]") : null;
      const adminEditNote = adminModal ? adminModal.querySelector("[data-love-event-admin-edit-note]") : null;
      const adminTabEls = adminModal ? adminModal.querySelectorAll("[data-love-event-admin-tab]") : [];
      const adminPasswordInput = adminModal ? adminModal.querySelector("[data-love-event-admin-password]") : null;
      const adminUnlockBtn = adminModal ? adminModal.querySelector("[data-love-event-admin-unlock]") : null;
      const adminStatus = adminModal ? adminModal.querySelector("[data-love-event-admin-status]") : null;
      const clockEls = clockRoot
        ? {
            vn: clockRoot.querySelector("[data-love-clock='vn'] strong"),
            jp: clockRoot.querySelector("[data-love-clock='jp'] strong"),
            us: clockRoot.querySelector("[data-love-clock='us'] strong"),
          }
        : {};
      const nextEventEl = eventRoot ? eventRoot.querySelector("[data-love-event-next]") : null;
      const eventToggleBtn = eventRoot ? eventRoot.querySelector("[data-love-events-toggle]") : null;
      const eventMorePanel = eventRoot ? eventRoot.querySelector("[data-love-events-more]") : null;
      let extraEventsCount = 0;
      const featuredSlots = 2;

      const parseEventEl = (eventEl) => ({
        id:
          eventEl.getAttribute("data-love-event-id") ||
          [
            eventEl.getAttribute("data-love-event-name") || "event",
            eventEl.getAttribute("data-love-event-month") || "1",
            eventEl.getAttribute("data-love-event-day") || "1",
          ].join("__"),
        group: eventEl.getAttribute("data-love-event-group") || "extra",
        name: eventEl.getAttribute("data-love-event-name") || "event",
        month: Number(eventEl.getAttribute("data-love-event-month") || "1"),
        day: Number(eventEl.getAttribute("data-love-event-day") || "1"),
        hour: Number(eventEl.getAttribute("data-love-event-hour") || "0"),
        minute: Number(eventEl.getAttribute("data-love-event-minute") || "0"),
        note: eventEl.getAttribute("data-love-event-note") || "",
        icon:
          eventEl.querySelector(".love-event-chip__icon")?.textContent?.trim() || "‚ú¶",
        eventEl,
        countdownEl: eventEl.querySelector("[data-love-event-countdown]"),
        dateEl: eventEl.querySelector("[data-love-event-date]"),
        noteTrigger: eventEl.querySelector("[data-love-event-note-trigger]"),
      });

      const collectEventEls = () =>
        eventRoot
          ? Array.from(eventRoot.querySelectorAll("[data-love-event]")).map((eventEl) => parseEventEl(eventEl))
          : [];
      const refreshExtraEventsCount = () => {
        if (!(extraRail instanceof HTMLElement)) {
          extraEventsCount = 0;
          return extraEventsCount;
        }
        extraEventsCount = Array.from(extraRail.querySelectorAll("[data-love-event]")).filter((eventEl) => !eventEl.hidden).length;
        return extraEventsCount;
      };

      let eventEls = collectEventEls();
      refreshExtraEventsCount();

      const startParts = { year: 2025, month: 12, day: 27 };
      const eventTimezoneOffsetMinutes = 7 * 60;
      const pastStorageKey = "twaw:past-events";
      const pad = (value) => String(value).padStart(2, "0");
      const globalState = window.__loveWidgetsState || {};
      let pastSnapshot = "";

      const defaultDateParts = () => {
        const now = new Date();
        return {
          year: now.getFullYear(),
          month: now.getMonth() + 1,
          day: now.getDate(),
        };
      };

      const resolveTimeZone = (candidates) => {
        if (!Array.isArray(candidates) || typeof Intl === "undefined") return "UTC";
        for (const candidate of candidates) {
          try {
            new Intl.DateTimeFormat("en-US", { timeZone: candidate }).format(new Date());
            return candidate;
          } catch (_error) {}
        }
        return "UTC";
      };

      const timeZones = {
        vn: resolveTimeZone(["Asia/Ho_Chi_Minh", "Asia/Saigon", "Asia/Bangkok"]),
        jp: resolveTimeZone(["Asia/Tokyo"]),
        us: resolveTimeZone(["America/New_York", "US/Eastern"]),
      };

      const getDateParts = (timeZone) => {
        try {
          const formatter = new Intl.DateTimeFormat("en-CA", {
            timeZone,
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
          });
          if (typeof formatter.formatToParts !== "function") {
            return defaultDateParts();
          }
          const parts = formatter.formatToParts(new Date());
          let year = 0;
          let month = 0;
          let day = 0;
          parts.forEach((part) => {
            if (part.type === "year") year = Number(part.value);
            if (part.type === "month") month = Number(part.value);
            if (part.type === "day") day = Number(part.value);
          });
          if (!year || !month || !day) return defaultDateParts();
          return { year, month, day };
        } catch (_error) {
          return defaultDateParts();
        }
      };

      const updateDay = () => {
        if (!dayEl) return;
        const parts = getDateParts(timeZones.vn);
        const todayUtc = Date.UTC(parts.year, parts.month - 1, parts.day);
        const startUtc = Date.UTC(startParts.year, startParts.month - 1, startParts.day);
        const diff = Math.max(0, Math.floor((todayUtc - startUtc) / (1000 * 60 * 60 * 24)) + 1);
        dayEl.textContent = `DAY ${diff}`;
      };

      const eventTargetUtc = (year, month, day, hour, minute) =>
        Date.UTC(year, month - 1, day, hour, minute, 0) - eventTimezoneOffsetMinutes * 60 * 1000;

      const sortEventsForAdmin = () => {
        const nowTs = Date.now();
        const currentYear = getDateParts(timeZones.vn).year;
        return [...eventEls]
          .map((eventItem) => {
            const targetTs = eventTargetUtc(
              currentYear,
              eventItem.month,
              eventItem.day,
              eventItem.hour,
              eventItem.minute
            );
            const diff = targetTs - nowTs;
            const rank = diff >= 0 ? 0 : 1;
            return { eventItem, diff, rank };
          })
          .sort((a, b) => {
            if (a.rank !== b.rank) return a.rank - b.rank;
            if (a.rank === 0) return a.diff - b.diff;
            return b.diff - a.diff;
          })
          .map((entry) => entry.eventItem);
      };

      const findEventItemById = (id) => eventEls.find((eventItem) => eventItem.id === id);

      const formatCountdown = (diffMs) => {
        const totalSeconds = Math.max(0, Math.floor(diffMs / 1000));
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${days}D ${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
      };

      const getCsrfToken = () => {
        const match = document.cookie.match(/(?:^|; )twaw_admin_csrf=([^;]+)/);
        return match ? decodeURIComponent(match[1]) : "";
      };

      const createEventChip = ({
        id,
        name,
        month,
        day,
        hour = 0,
        minute = 0,
        eventGroup = "extra",
        icon = "‚ú¶",
        note = "",
        accentRgb = "",
      }) => {
        const article = document.createElement("article");
        article.className =
          eventGroup === "extra" ? "love-event-chip love-event-chip--extra" : "love-event-chip";
        article.setAttribute("role", "listitem");
        article.setAttribute("data-love-event", "");
        article.setAttribute("data-love-event-id", id);
        article.setAttribute("data-love-event-group", eventGroup);
        article.setAttribute("data-love-event-name", name);
        article.setAttribute("data-love-event-month", String(month));
        article.setAttribute("data-love-event-day", String(day));
        article.setAttribute("data-love-event-note", note || "");
        if (hour > 0 || minute > 0) {
          article.setAttribute("data-love-event-hour", String(hour));
          article.setAttribute("data-love-event-minute", String(minute));
        }
        const defaultAccent = eventGroup === "featured" ? "116 218 255" : "255 167 118";
        article.style.setProperty("--event-accent", accentRgb || defaultAccent);

        const iconEl = document.createElement("span");
        iconEl.className = "love-event-chip__icon";
        iconEl.setAttribute("aria-hidden", "true");
        iconEl.textContent = icon || "‚ú¶";

        const metaEl = document.createElement("div");
        metaEl.className = "love-event-chip__meta";

        const nameEl = document.createElement("span");
        nameEl.className = "love-event-chip__name";
        nameEl.textContent = name;

        const dateEl = document.createElement("span");
        dateEl.className = "love-event-chip__date";
        dateEl.setAttribute("data-love-event-date", "");
        dateEl.textContent = `${pad(day)}/${pad(month)}`;

        metaEl.appendChild(nameEl);
        metaEl.appendChild(dateEl);

        const countdownEl = document.createElement("strong");
        countdownEl.className = "love-event-chip__countdown";
        countdownEl.setAttribute("data-love-event-countdown", "");
        countdownEl.textContent = "--D --:--:--";

        const noteBtn = document.createElement("button");
        noteBtn.className = "love-event-chip__note-btn";
        noteBtn.type = "button";
        noteBtn.setAttribute("data-love-event-note-trigger", "");
        noteBtn.setAttribute("aria-label", "View event note");
        noteBtn.textContent = "‚ú¶";

        article.appendChild(iconEl);
        article.appendChild(metaEl);
        article.appendChild(countdownEl);
        article.appendChild(noteBtn);
        return article;
      };

      const readPastEvents = () => {
        try {
          const raw = window.localStorage.getItem(pastStorageKey);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (_error) {
          return [];
        }
      };

      const writePastEvents = (items) => {
        try {
          if (!items.length) {
            window.localStorage.removeItem(pastStorageKey);
            return;
          }
          window.localStorage.setItem(pastStorageKey, JSON.stringify(items));
        } catch (_error) {}
      };

      const renderPastEventsBanner = (items) => {
        if (!(pastBanner instanceof HTMLElement) || !(pastList instanceof HTMLElement)) return;
        pastList.textContent = "";
        if (!items.length) {
          pastBanner.hidden = true;
          return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
          const chip = document.createElement("span");
          chip.className = "header-past-events__item";
          chip.textContent = `${item.icon || "‚ú¶"} ${item.name}`;
          chip.title = `${item.name} ¬∑ ${pad(item.day)}/${pad(item.month)}/${item.year}`;
          fragment.appendChild(chip);
        });
        pastList.appendChild(fragment);
        pastBanner.hidden = false;
      };

      const hydratePastBannerFromStorage = () => {
        const currentYear = getDateParts(timeZones.vn).year;
        const items = readPastEvents()
          .filter((item) => Number(item?.year) === currentYear)
          .sort((a, b) => Number(b?.completedAt || 0) - Number(a?.completedAt || 0));
        renderPastEventsBanner(items);
      };

      const syncPastEvents = (items, currentYear) => {
        const normalized = items
          .map((item) => ({
            id: item.id,
            name: item.name,
            month: item.month,
            day: item.day,
            year: currentYear,
            icon: item.icon,
            completedAt: item.completedAt,
          }))
          .sort((a, b) => b.completedAt - a.completedAt);
        const snapshot = `${currentYear}:${normalized.map((item) => item.id).join("|")}`;
        if (snapshot === pastSnapshot) return;
        pastSnapshot = snapshot;
        writePastEvents(normalized);
        renderPastEventsBanner(normalized);
      };

      const setMorePanelState = (isOpen) => {
        if (!eventToggleBtn || !eventMorePanel) return;
        refreshExtraEventsCount();
        eventMorePanel.hidden = !isOpen;
        eventToggleBtn.setAttribute("aria-expanded", isOpen ? "true" : "false");
        eventToggleBtn.setAttribute("aria-label", isOpen ? "Hide full timeline" : "Open full timeline");
        eventToggleBtn.setAttribute(
          "title",
          isOpen ? "Hide full timeline" : `Open full timeline (${extraEventsCount} events)`
        );
      };

      if (eventToggleBtn && eventMorePanel) {
        if (extraEventsCount <= 0) {
          eventToggleBtn.hidden = true;
          eventMorePanel.hidden = true;
        } else {
          setMorePanelState(false);
          if (eventToggleBtn.dataset.bound !== "1") {
            eventToggleBtn.dataset.bound = "1";
            eventToggleBtn.addEventListener("click", () => {
              const isOpen = eventToggleBtn.getAttribute("aria-expanded") === "true";
              setMorePanelState(!isOpen);
            });
          }
        }
      }

      const closeNoteModal = () => {
        if (!(noteModal instanceof HTMLElement)) return;
        noteModal.hidden = true;
        noteModal.dataset.open = "0";
      };

      const openNoteModal = (eventItem) => {
        if (
          !(noteModal instanceof HTMLElement) ||
          !(noteTitle instanceof HTMLElement) ||
          !(noteBody instanceof HTMLElement)
        ) {
          return;
        }
        noteTitle.textContent = eventItem.name;
        noteBody.textContent = eventItem.note || "No note yet.";
        noteModal.hidden = false;
        noteModal.dataset.open = "1";
      };

      const bindNoteTrigger = (eventItem) => {
        if (!(eventItem.noteTrigger instanceof HTMLButtonElement)) return;
        if (eventItem.noteTrigger.dataset.bound === "1") return;
        eventItem.noteTrigger.dataset.bound = "1";
        eventItem.noteTrigger.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          // Read the latest DOM attributes on each click to avoid stale note data.
          const current = parseEventEl(eventItem.eventEl);
          openNoteModal(current);
        });
      };

      const bindAllNoteTriggers = () => {
        eventEls.forEach((eventItem) => bindNoteTrigger(eventItem));
      };

      const closeAdminModal = () => {
        if (!(adminModal instanceof HTMLElement)) return;
        adminModal.hidden = true;
        adminModal.dataset.open = "0";
      };

      const openAdminModal = () => {
        if (!(adminModal instanceof HTMLElement)) return;
        adminModal.hidden = false;
        adminModal.dataset.open = "1";
      };

      let adminUnlocked = false;
      let adminMode = "add";
      const setAdminStatus = (message, variant = "info") => {
        if (!(adminStatus instanceof HTMLElement)) return;
        adminStatus.textContent = message;
        adminStatus.dataset.state = variant;
      };

      const populateAdminEditOptions = (preferredId = "") => {
        if (!(adminEditTarget instanceof HTMLSelectElement)) return;
        if (!(adminEditNote instanceof HTMLTextAreaElement)) return;
        const sorted = sortEventsForAdmin();
        const currentValue = preferredId || adminEditTarget.value;
        adminEditTarget.textContent = "";
        if (!sorted.length) {
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "No events yet";
          adminEditTarget.appendChild(option);
          adminEditTarget.disabled = true;
          adminEditNote.value = "";
          return;
        }
        sorted.forEach((eventItem) => {
          const option = document.createElement("option");
          option.value = eventItem.id;
          option.textContent = `${pad(eventItem.day)}/${pad(eventItem.month)} ¬∑ ${eventItem.name}`;
          adminEditTarget.appendChild(option);
        });
        adminEditTarget.disabled = false;
        const nextId = sorted.some((item) => item.id === currentValue)
          ? currentValue
          : sorted[0].id;
        adminEditTarget.value = nextId;
        const activeEvent = findEventItemById(nextId);
        adminEditNote.value = activeEvent?.note || "";
      };

      const setAdminMode = (mode) => {
        adminMode = mode === "edit" ? "edit" : "add";
        if (adminAddForm instanceof HTMLElement) {
          adminAddForm.hidden = adminMode !== "add";
        }
        if (adminEditForm instanceof HTMLElement) {
          adminEditForm.hidden = adminMode !== "edit";
        }
        adminTabEls.forEach((tabEl) => {
          if (!(tabEl instanceof HTMLButtonElement)) return;
          const tabMode = tabEl.getAttribute("data-love-event-admin-tab") || "add";
          tabEl.setAttribute("aria-selected", tabMode === adminMode ? "true" : "false");
        });
        if (adminMode === "edit") {
          populateAdminEditOptions();
        }
      };

      const setAdminUnlocked = (value) => {
        adminUnlocked = value;
        if (adminAuth instanceof HTMLElement) {
          adminAuth.hidden = value;
        }
        if (adminPanel instanceof HTMLElement) {
          adminPanel.hidden = !value;
        }
        if (value) {
          setAdminMode(adminMode);
          populateAdminEditOptions();
          setAdminStatus("Unlocked. Add new events or edit descriptions directly.");
          if (adminPasswordInput instanceof HTMLInputElement) {
            adminPasswordInput.value = "";
          }
        } else {
          setAdminStatus("Enter admin password to unlock editing.");
        }
      };

      if (noteModal instanceof HTMLElement && noteModal.dataset.bound !== "1") {
        noteModal.dataset.bound = "1";
        const closeEls = noteModal.querySelectorAll("[data-love-event-note-close]");
        closeEls.forEach((closeEl) => {
          closeEl.addEventListener("click", (event) => {
            event.preventDefault();
            closeNoteModal();
          });
        });
      }

      if (globalState.noteEscapeHandler) {
        document.removeEventListener("keydown", globalState.noteEscapeHandler);
      }
      globalState.noteEscapeHandler = (event) => {
        if (event.key === "Escape") {
          closeNoteModal();
          closeAdminModal();
        }
      };
      document.addEventListener("keydown", globalState.noteEscapeHandler);

      bindAllNoteTriggers();

      if (adminOpenBtn instanceof HTMLButtonElement && adminOpenBtn.dataset.bound !== "1") {
        adminOpenBtn.dataset.bound = "1";
        adminOpenBtn.addEventListener("click", (event) => {
          event.preventDefault();
          openAdminModal();
          ensureAdminSession();
        });
      }

      if (adminModal instanceof HTMLElement && adminModal.dataset.bound !== "1") {
        adminModal.dataset.bound = "1";
        const closeEls = adminModal.querySelectorAll("[data-love-events-admin-close]");
        closeEls.forEach((closeEl) => {
          closeEl.addEventListener("click", (event) => {
            event.preventDefault();
            closeAdminModal();
          });
        });
      }

      if (adminTabEls.length) {
        adminTabEls.forEach((tabEl) => {
          if (!(tabEl instanceof HTMLButtonElement)) return;
          if (tabEl.dataset.bound === "1") return;
          tabEl.dataset.bound = "1";
          tabEl.addEventListener("click", (event) => {
            event.preventDefault();
            setAdminMode(tabEl.getAttribute("data-love-event-admin-tab") || "add");
          });
        });
      }

      if (adminEditTarget instanceof HTMLSelectElement && adminEditTarget.dataset.bound !== "1") {
        adminEditTarget.dataset.bound = "1";
        adminEditTarget.addEventListener("change", () => {
          if (!(adminEditNote instanceof HTMLTextAreaElement)) return;
          const selected = findEventItemById(adminEditTarget.value);
          adminEditNote.value = selected?.note || "";
        });
      }

      const ensureAdminSession = async () => {
        try {
          const res = await fetch("/api/admin/session");
          const payload = await res.json().catch(() => null);
          setAdminUnlocked(Boolean(payload?.authenticated));
        } catch (_error) {
          setAdminUnlocked(false);
        }
      };

      if (adminUnlockBtn instanceof HTMLButtonElement && adminUnlockBtn.dataset.bound !== "1") {
        adminUnlockBtn.dataset.bound = "1";
        adminUnlockBtn.addEventListener("click", async (event) => {
          event.preventDefault();
          if (!(adminPasswordInput instanceof HTMLInputElement)) return;
          const password = adminPasswordInput.value.trim();
          if (!password) {
            setAdminStatus("Enter password first.", "error");
            return;
          }
          setAdminStatus("Verifying password...");
          try {
            const res = await fetch("/api/admin/login", {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ password }),
            });
            const payload = await res.json().catch(() => null);
            if (!res.ok || !payload?.ok) {
              setAdminStatus(payload?.error || "Unlock failed.", "error");
              return;
            }
            setAdminUnlocked(true);
          } catch (_error) {
            setAdminStatus("Cannot connect to admin endpoint.", "error");
          }
        });
      }

      if (adminAddForm instanceof HTMLFormElement && adminAddForm.dataset.bound !== "1") {
        adminAddForm.dataset.bound = "1";
        adminAddForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!adminUnlocked) {
            setAdminStatus("Unlock with password first.", "error");
            return;
          }

          const fd = new FormData(adminAddForm);
          const name = String(fd.get("name") || "").trim();
          const dateRaw = String(fd.get("event_date") || "").trim();
          if (!name || !dateRaw) {
            setAdminStatus("Missing event title or date.", "error");
            return;
          }

          const dateParts = dateRaw.split("-").map((part) => Number(part));
          if (dateParts.length !== 3 || dateParts.some((part) => !Number.isFinite(part))) {
            setAdminStatus("Invalid date.", "error");
            return;
          }
          const month = Math.max(1, Math.min(12, dateParts[1]));
          const day = Math.max(1, Math.min(31, dateParts[2]));

          const timeRaw = String(fd.get("event_time") || "").trim();
          const [hhRaw = "0", mmRaw = "0"] = timeRaw ? timeRaw.split(":") : ["0", "0"];
          const hour = Math.max(0, Math.min(23, Number.parseInt(hhRaw, 10) || 0));
          const minute = Math.max(0, Math.min(59, Number.parseInt(mmRaw, 10) || 0));
          const eventGroup = fd.get("event_group") === "featured" ? "featured" : "extra";
          const icon = String(fd.get("icon") || "").trim();
          const note = String(fd.get("note") || "").trim();
          const accentRgb = String(fd.get("accent_rgb") || "").trim();
          if (!note) {
            setAdminStatus("Description is required for each event.", "error");
            return;
          }
          const csrf = getCsrfToken();
          if (!csrf) {
            setAdminStatus("Missing CSRF token. Please unlock again.", "error");
            return;
          }

          setAdminStatus("Pushing event to timeline...");
          try {
            const res = await fetch("/api/admin/love-events", {
              method: "POST",
              headers: {
                "content-type": "application/json",
                "x-csrf-token": csrf,
              },
              body: JSON.stringify({
                name,
                month,
                day,
                hour,
                minute,
                event_group: eventGroup,
                icon,
                note,
                accent_rgb: accentRgb,
              }),
            });
            const payload = await res.json().catch(() => null);
            if (!res.ok || !payload?.ok || !payload?.event) {
              setAdminStatus(payload?.error || "Push event failed.", "error");
              return;
            }

            const created = payload.event;
            const targetRail =
              created.event_group === "featured" ? featuredRail : extraRail;
            if (!(targetRail instanceof HTMLElement)) {
              setAdminStatus("Cannot find event rail.", "error");
              return;
            }
            const chip = createEventChip({
              id: created.id,
              name: created.name,
              month: Number(created.month),
              day: Number(created.day),
              hour: Number(created.hour || 0),
              minute: Number(created.minute || 0),
              eventGroup: created.event_group === "featured" ? "featured" : "extra",
              icon: created.icon || "",
              note: created.note || "",
              accentRgb: created.accent_rgb || "",
            });
            targetRail.appendChild(chip);
            eventEls = collectEventEls();
            refreshExtraEventsCount();
            bindAllNoteTriggers();
            populateAdminEditOptions(created.id);
            updateEvents();
            adminAddForm.reset();
            setAdminStatus("Pushed. Event is now on timeline.");
          } catch (_error) {
            setAdminStatus("Cannot push event right now.", "error");
          }
        });
      }

      if (adminEditForm instanceof HTMLFormElement && adminEditForm.dataset.bound !== "1") {
        adminEditForm.dataset.bound = "1";
        adminEditForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (!adminUnlocked) {
            setAdminStatus("Unlock with password first.", "error");
            return;
          }
          if (!(adminEditTarget instanceof HTMLSelectElement)) return;
          if (!(adminEditNote instanceof HTMLTextAreaElement)) return;

          const id = adminEditTarget.value.trim();
          const note = adminEditNote.value.trim();
          if (!id) {
            setAdminStatus("Choose an event to edit description.", "error");
            return;
          }
          if (!note) {
            setAdminStatus("Description cannot be empty.", "error");
            return;
          }

          const source = findEventItemById(id);
          if (!source) {
            setAdminStatus("Cannot find this event on timeline.", "error");
            return;
          }

          const csrf = getCsrfToken();
          if (!csrf) {
            setAdminStatus("Missing CSRF token. Please unlock again.", "error");
            return;
          }

          setAdminStatus("Updating description...");
          try {
            const res = await fetch("/api/admin/love-events", {
              method: "PATCH",
              headers: {
                "content-type": "application/json",
                "x-csrf-token": csrf,
              },
              body: JSON.stringify({
                id,
                name: source.name,
                month: source.month,
                day: source.day,
                hour: source.hour,
                minute: source.minute,
                event_group: source.group === "featured" ? "featured" : "extra",
                icon: source.icon || "",
                note,
              }),
            });
            const payload = await res.json().catch(() => null);
            if (!res.ok || !payload?.ok || !payload?.event) {
              setAdminStatus(payload?.error || "Update description failed.", "error");
              return;
            }

            const updated = payload.event;
            if (source.eventEl instanceof HTMLElement) {
              source.eventEl.setAttribute("data-love-event-note", String(updated.note || ""));
            }
            eventEls = collectEventEls();
            bindAllNoteTriggers();
            populateAdminEditOptions(id);
            setAdminStatus("Description updated.");
          } catch (_error) {
            setAdminStatus("Cannot update description right now.", "error");
          }
        });
      }

      setAdminMode("add");
      ensureAdminSession();

      const hydrateRemoteEvents = async () => {
        if (!eventRoot) return;
        try {
          const res = await fetch("/api/love-events");
          const payload = await res.json().catch(() => null);
          if (!res.ok || !payload?.ok || !Array.isArray(payload.events)) return;

          const existingIds = new Set(
            Array.from(eventRoot.querySelectorAll("[data-love-event-id]"))
              .map((el) => el.getAttribute("data-love-event-id"))
              .filter(Boolean)
          );

          payload.events.forEach((item) => {
            const id = String(item?.id || "").trim();
            if (!id || existingIds.has(id)) return;
            const eventGroup = item?.event_group === "featured" ? "featured" : "extra";
            const targetRail = eventGroup === "featured" ? featuredRail : extraRail;
            if (!(targetRail instanceof HTMLElement)) return;
            const month = Number(item?.month || 1);
            const day = Number(item?.day || 1);
            const hour = Number(item?.hour || 0);
            const minute = Number(item?.minute || 0);
            const chip = createEventChip({
              id,
              name: String(item?.name || "Event"),
              month,
              day,
              hour,
              minute,
              eventGroup,
              icon: String(item?.icon || ""),
              note: String(item?.note || ""),
              accentRgb: String(item?.accent_rgb || ""),
            });
            targetRail.appendChild(chip);
            existingIds.add(id);
          });

          eventEls = collectEventEls();
          refreshExtraEventsCount();
          bindAllNoteTriggers();
          populateAdminEditOptions();
          updateEvents();
        } catch (_error) {}
      };

      hydratePastBannerFromStorage();

      const updateEvents = () => {
        if (!eventEls.length) return;
        const nowTs = Date.now();
        const currentYear = getDateParts(timeZones.vn).year;
        const upcomingEntries = [];
        const pastEntries = [];
        let nearest = null;

        eventEls.forEach((eventItem) => {
          const targetTs = eventTargetUtc(
            currentYear,
            eventItem.month,
            eventItem.day,
            eventItem.hour,
            eventItem.minute
          );
          if (targetTs <= nowTs) {
            eventItem.eventEl.hidden = true;
            pastEntries.push({
              id: eventItem.id,
              name: eventItem.name,
              month: eventItem.month,
              day: eventItem.day,
              icon: eventItem.icon,
              completedAt: targetTs,
            });
            return;
          }

          eventItem.eventEl.hidden = false;
          const diff = Math.max(0, targetTs - nowTs);
          upcomingEntries.push({ eventItem, diff });
          if (eventItem.countdownEl) {
            eventItem.countdownEl.textContent = formatCountdown(diff);
          }
          if (eventItem.dateEl) {
            eventItem.dateEl.textContent = `${pad(eventItem.day)}/${pad(eventItem.month)} ¬∑ ${currentYear}`;
          }

          if (!nearest || diff < nearest.diff) {
            nearest = { name: eventItem.name, diff };
          }
        });

        syncPastEvents(pastEntries, currentYear);

        if (nextEventEl && nearest) {
          nextEventEl.textContent = "‚ö° THE UPCOMING EVENT";
          nextEventEl.setAttribute("title", nearest.name);
        } else if (nextEventEl) {
          nextEventEl.textContent = "‚ö° THE UPCOMING EVENT";
          nextEventEl.setAttribute("title", "No upcoming event");
        }

        const sortedFeatured = upcomingEntries
          .filter((entry) => entry.eventItem.group === "featured")
          .sort((a, b) => a.diff - b.diff);
        const sortedExtra = upcomingEntries
          .filter((entry) => entry.eventItem.group === "extra")
          .sort((a, b) => a.diff - b.diff);

        const displayedFeatured = [...sortedFeatured.slice(0, featuredSlots)];
        if (displayedFeatured.length < featuredSlots) {
          displayedFeatured.push(...sortedExtra.slice(0, featuredSlots - displayedFeatured.length));
        }

        const displayedFeaturedIds = new Set(
          displayedFeatured.map((entry) => entry.eventItem.id)
        );
        const displayedExtra = upcomingEntries
          .filter((entry) => !displayedFeaturedIds.has(entry.eventItem.id))
          .sort((a, b) => a.diff - b.diff);

        if (featuredRail instanceof HTMLElement) {
          displayedFeatured.forEach(({ eventItem }) => {
            if (eventItem.eventEl instanceof HTMLElement) {
              featuredRail.appendChild(eventItem.eventEl);
            }
          });
        }

        if (extraRail instanceof HTMLElement) {
          displayedExtra.forEach(({ eventItem }) => {
            if (eventItem.eventEl instanceof HTMLElement) {
              extraRail.appendChild(eventItem.eventEl);
            }
          });
        }

        extraEventsCount = displayedExtra.length;

        if (eventToggleBtn && eventMorePanel) {
          const hasUpcomingExtra = displayedExtra.length > 0;
          if (!hasUpcomingExtra) {
            eventToggleBtn.hidden = true;
            eventMorePanel.hidden = true;
          } else {
            eventToggleBtn.hidden = false;
            const isOpen = eventToggleBtn.getAttribute("aria-expanded") === "true";
            eventMorePanel.hidden = !isOpen;
            eventToggleBtn.setAttribute(
              "title",
              isOpen ? "Hide full timeline" : `Open full timeline (${extraEventsCount} events)`
            );
          }
        }
      };

      hydrateRemoteEvents();

      const makeClock = (timeZone) => {
        try {
          return new Intl.DateTimeFormat("en-GB", {
            timeZone,
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        } catch (_error) {
          return new Intl.DateTimeFormat("en-GB", {
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
          });
        }
      };

      const clocks = {
        vn: makeClock(timeZones.vn),
        jp: makeClock(timeZones.jp),
        us: makeClock(timeZones.us),
      };

      const tick = () => {
        const now = new Date();
        if (clockEls.vn) clockEls.vn.textContent = clocks.vn.format(now);
        if (clockEls.jp) clockEls.jp.textContent = clocks.jp.format(now);
        if (clockEls.us) clockEls.us.textContent = clocks.us.format(now);
        updateDay();
        updateEvents();
      };

      tick();

      if (globalState.timerId) {
        window.clearInterval(globalState.timerId);
      }
      globalState.timerId = window.setInterval(tick, 1000);
      window.__loveWidgetsState = globalState;
    };

    initLoveWidgets();
    document.addEventListener("astro:page-load", initLoveWidgets);
  </script>
)}
