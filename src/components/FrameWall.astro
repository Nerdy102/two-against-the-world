---
type WallImage = { src: string; alt?: string };

const { images, seed = "wall" } = Astro.props as {
  images: WallImage[];
  seed?: string;
};

// Deterministic random (for tiny tilts only)
function xmur3(str: string) {
  let h = 1779033703 ^ str.length;
  for (let i = 0; i < str.length; i++) {
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = (h << 13) | (h >>> 19);
  }
  return function () {
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    return (h ^= h >>> 16) >>> 0;
  };
}
function mulberry32(a: number) {
  return function () {
    let t = (a += 0x6d2b79f5);
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    t = t ^ (t >>> 14);
    return (t >>> 0) / 4294967296;
  };
}

const seedFn = xmur3(seed);
const rand = mulberry32(seedFn());
const r = (min: number, max: number) => min + rand() * (max - min);

// Cover fixed center
const COVER = { cStart: 4, cSpan: 6, rStart: 1, rSpan: 46 };

// Packed slots around it (tight wall)
const SLOTS = [
  { cStart: 1,  cSpan: 3, rStart: 1,  rSpan: 16, shape: "rect" },
  { cStart: 1,  cSpan: 3, rStart: 17, rSpan: 16, shape: "rect" },
  { cStart: 1,  cSpan: 3, rStart: 33, rSpan: 14, shape: "soft" },

  { cStart: 10, cSpan: 3, rStart: 1,  rSpan: 16, shape: "rect" },
  { cStart: 10, cSpan: 3, rStart: 17, rSpan: 16, shape: "round" },
  { cStart: 10, cSpan: 3, rStart: 33, rSpan: 14, shape: "soft" },

  { cStart: 1,  cSpan: 4, rStart: 47, rSpan: 20, shape: "rect" },
  { cStart: 5,  cSpan: 4, rStart: 47, rSpan: 20, shape: "soft" },
  { cStart: 9,  cSpan: 4, rStart: 47, rSpan: 20, shape: "rect" },

  { cStart: 3,  cSpan: 4, rStart: 67, rSpan: 18, shape: "round" },
  { cStart: 7,  cSpan: 6, rStart: 67, rSpan: 18, shape: "rect" },
];

const frames = images.map((img, i) => {
  const isCover = i === 0;
  const slot = !isCover ? SLOTS[(i - 1) % SLOTS.length] : null;

  const rot = isCover ? r(-0.6, 0.6) : r(-1.1, 1.1);

  return {
    ...img,
    idx: i,
    isCover,
    rot,
    cStart: isCover ? COVER.cStart : (slot?.cStart ?? 1),
    cSpan:  isCover ? COVER.cSpan  : (slot?.cSpan ?? 3),
    rStart: isCover ? COVER.rStart : (slot?.rStart ?? 1),
    rSpan:  isCover ? COVER.rSpan  : (slot?.rSpan ?? 18),
    shape:  isCover ? "" : (slot?.shape ?? "rect"),
    delay: i * 60,
  };
});
---

<div class="framewall">
  <!-- dummy target for closing -->
  <span id="lb-close" class="lb-close-target" aria-hidden="true"></span>

  <div class="wall" aria-label="Bức tường ảnh">
    {frames.map((f) => (
      <a
        href={`#lb-${f.idx}`}
        class={`frame ${f.isCover ? "is-cover" : ""} ${f.shape ? "shape-" + f.shape : ""}`}
        style={`grid-column:${f.cStart} / span ${f.cSpan}; grid-row:${f.rStart} / span ${f.rSpan}; --rot:${f.rot}deg; --delay:${f.delay}ms;`}
        data-reveal
        aria-label={`Open photo ${f.idx + 1}`}
      >
        <div class="frame-inner">
          <div class="mat">
            <img src={f.src} alt={f.alt ?? ""} loading="lazy" decoding="async" />
          </div>
        </div>
      </a>
    ))}
  </div>

  <!-- LIGHTBOX PER IMAGE (CSS :target => always works, even with view transitions) -->
  {frames.map((f) => {
    const prev = (f.idx - 1 + frames.length) % frames.length;
    const next = (f.idx + 1) % frames.length;

    return (
      <div class="lb" id={`lb-${f.idx}`} aria-label="Image viewer">
        <a class="lb-backdrop" href="#lb-close" aria-label="Close"></a>

        <div class="lb-panel" role="dialog" aria-modal="true">
          <a class="lb-x" href="#lb-close" aria-label="Close">×</a>

          <a class="lb-nav lb-prev" href={`#lb-${prev}`} aria-label="Previous">‹</a>

          <div class="lb-frame">
            <img class="lb-img" src={f.src} alt={f.alt ?? ""} decoding="async" />
          </div>

          <a class="lb-nav lb-next" href={`#lb-${next}`} aria-label="Next">›</a>

          <div class="lb-meta">
            <span class="lb-count">{f.idx + 1} / {frames.length}</span>
            <a class="lb-open" href={f.src} target="_blank" rel="noreferrer">Open original</a>
          </div>

          <!-- “Slider” thumbnail strip (scroll horizontally on mobile) -->
          <div class="lb-thumbs" aria-label="Thumbnails">
            {frames.map((t) => (
              <a class={`lb-thumb ${t.idx === f.idx ? "is-active" : ""}`} href={`#lb-${t.idx}`} aria-label={`Go to ${t.idx + 1}`}>
                <img src={t.src} alt="" loading="lazy" decoding="async" />
              </a>
            ))}
          </div>
        </div>
      </div>
    );
  })}

  <style>
    /* Make sure wall is clickable */
    .framewall{ position: relative; z-index: 30; }
    .wall{ pointer-events: auto; }

    /* Packed wall */
    .wall{
      position: relative;
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      grid-auto-rows: 10px;
      grid-auto-flow: dense;
      gap: 8px;
      padding: 10px;

      border-radius: 22px;
      background: rgba(0,0,0,0.16);
      border: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(8px);
      box-shadow: 0 22px 70px rgba(0,0,0,0.45);
    }

    @media (max-width: 640px){
      .wall{
        grid-template-columns: repeat(6, minmax(0, 1fr));
        grid-auto-rows: 9px;
        gap: 7px;
        padding: 8px;
      }
      .frame{ grid-column: span 3 !important; grid-row: span 18 !important; }
      .frame.is-cover{ grid-column: 1 / -1 !important; grid-row: span 30 !important; }
    }

    .frame{
      display:block;
      width: 100%;
      height: 100%;
      text-decoration: none;
      transform: rotate(var(--rot, 0deg));
      transition: transform 220ms ease, filter 220ms ease;
      border-radius: 18px;
      pointer-events: auto;
    }
    .frame:hover{
      transform: rotate(calc(var(--rot, 0deg) * 0.55)) scale(1.01);
      filter: saturate(1.03);
    }
    .frame:focus-visible{
      outline: 2px dashed rgba(212,176,106,0.55);
      outline-offset: 6px;
    }

    /* European renaissance frame (richer gold + ornament) */
    .frame-inner{
      position: relative;
      height: 100%;
      width: 100%;
      padding: 7px;
      border-radius: 18px;
      overflow: hidden;

      background:
        linear-gradient(180deg, rgba(255,233,170,0.22), rgba(94,66,28,0.35)),
        linear-gradient(90deg, rgba(48,32,12,0.4), rgba(255,230,168,0.25), rgba(48,32,12,0.4));

      border: 1px solid rgba(214,184,118,0.38);
      box-shadow:
        0 18px 46px rgba(0,0,0,0.45),
        0 1px 0 rgba(255,214,128,0.28) inset;
    }

    .frame-inner::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity: 0.35;
      mix-blend-mode: overlay;
      background-image: url("data:image/svg+xml,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27120%27%20height%3D%27120%27%20viewBox%3D%270%200%20120%20120%27%3E%3Cg%20fill%3D%27none%27%20stroke%3D%27%23d4b06a%27%20stroke-opacity%3D%270.55%27%20stroke-width%3D%272%27%3E%3Cpath%20d%3D%27M60%2010c-9%2010-14%2018-14%2028%200%2010%206%2016%2014%2016s14-6%2014-16c0-10-5-18-14-28z%27/%3E%3Cpath%20d%3D%27M60%20110c9-10%2014-18%2014-28%200-10-6-16-14-16s-14%206-14%2016c0%2010%205%2018%2014%2028z%27/%3E%3Cpath%20d%3D%27M10%2060c10-9%2018-14%2028-14%2010%200%2016%206%2016%2014s-6%2014-16%2014c-10%200-18-5-28-14z%27/%3E%3Cpath%20d%3D%27M110%2060c-10%209-18%2014-28%2014-10%200-16-6-16-14s6-14%2016-14c10%200%2018%205%2028%2014z%27/%3E%3Ccircle%20cx%3D%2760%27%20cy%3D%2760%27%20r%3D%276%27%20stroke-opacity%3D%270.35%27/%3E%3C/g%3E%3C/svg%3E");
      background-size: 140px 140px;
      background-repeat: repeat;
    }

    .frame-inner::after{
      content:"";
      position:absolute;
      inset: 4px;
      border-radius: 16px;
      pointer-events:none;
      border: 1px solid rgba(76,44,12,0.35);
      box-shadow:
        0 0 0 1px rgba(255,222,160,0.18) inset,
        0 0 18px rgba(212,176,106,0.22);
      opacity: 0.75;
    }

    .mat{
      height: 100%;
      width: 100%;
      border-radius: 14px;
      overflow: hidden;
      background: rgba(0,0,0,0.12);
      border: 1px solid rgba(255,255,255,0.05);
      position: relative;
      z-index: 1;
    }
    .mat img{ width:100%; height:100%; object-fit: cover; display:block; }

    .shape-round .mat{ border-radius: 999px; }
    .shape-soft .mat{ border-radius: 22px; }

    /* -------- LIGHTBOX (CSS :target) -------- */
    .lb{ position: fixed; inset:0; z-index: 9999; opacity:0; pointer-events:none; transition: opacity 160ms ease; }
    .lb:target{ opacity:1; pointer-events:auto; }

    .lb-backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(10px);
    }

    .lb-panel{
      position: relative;
      width: min(980px, 96vw);
      max-height: 90vh;
      margin: 0 auto;
      top: 50%;
      transform: translateY(-50%);
      display: grid;
      grid-template-columns: 56px 1fr 56px;
      gap: 12px;
      align-items: center;
      padding: 10px;
    }
    @media (max-width: 640px){
      .lb-panel{ grid-template-columns: 44px 1fr 44px; }
    }

    .lb-x{
      position:absolute;
      top: -10px;
      right: -10px;
      width: 40px; height: 40px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.35);
      color: rgba(255,255,255,0.92);
      font-size: 22px;
      display:grid;
      place-items:center;
      text-decoration:none;
      z-index: 2;
    }

    .lb-nav{
      width: 56px; height: 56px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.35);
      color: rgba(255,255,255,0.92);
      font-size: 34px;
      display:grid;
      place-items:center;
      text-decoration:none;
      z-index: 2;
      user-select: none;
    }
    @media (max-width: 640px){
      .lb-nav{ width: 44px; height: 44px; font-size: 28px; }
    }

    .lb-frame{
      border-radius: 18px;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 26px 90px rgba(0,0,0,0.65);
      backdrop-filter: blur(8px);
      overflow: hidden;
      touch-action: pan-x; /* allow swipe scroll on thumbs */
    }

    .lb-img{
      width: 100%;
      max-height: 72vh;
      height: auto;
      object-fit: contain;
      display:block;
      border-radius: 12px;
    }

    .lb-meta{
      grid-column: 1 / -1;
      display:flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
      color: rgba(255,255,255,0.75);
    }
    .lb-open, .lb-count{
      font-size: 12px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 6px 10px;
      border-radius: 999px;
      text-decoration:none;
      color: rgba(255,255,255,0.78);
      backdrop-filter: blur(8px);
    }

    /* thumbnail "slider" strip */
    .lb-thumbs{
      grid-column: 1 / -1;
      margin-top: 10px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 8px 4px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .lb-thumb{
      flex: 0 0 auto;
      width: 64px;
      height: 46px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      scroll-snap-align: start;
      opacity: 0.75;
      text-decoration:none;
    }
    .lb-thumb img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(0.95) contrast(1.05);
    }
    .lb-thumb.is-active{
      opacity: 1;
      border-color: rgba(212,176,106,0.35);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }

    /* hide dummy close target */
    .lb-close-target{ position: fixed; width:1px; height:1px; left:-9999px; top:-9999px; }
  </style>
</div>
