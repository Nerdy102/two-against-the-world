---
import BaseLayout from "../layouts/BaseLayout.astro";
import RansomTitle from "../components/RansomTitle.astro";
import { TOPICS } from "../config/topics";
import { PASSCODE } from "../config/secrets";
---

<BaseLayout title="Soạn bài — Two Against The World" active="entries" description="Soạn bài trực tiếp trên web">
  <main class="mx-auto max-w-5xl px-5 pb-24 pt-10">
    <section class="paper edge-torn p-6 sm:p-10" data-reveal>
      <p class="kicker text-xs text-black/50">SOẠN BÀI</p>
      <RansomTitle text="Soạn bài mới" as="h1" class="text-[44px] sm:text-[56px]" />
      <p class="mt-3 text-black/60">
        Trang này cho phép 2 người nhập nội dung trực tiếp và tải xuống gói bài viết để dùng trên máy local.
      </p>
      <p class="mt-2 text-black/60">
        Nội dung mới sẽ đồng bộ theo cấu trúc các bài đã đăng trước đó (frontmatter + thư mục ảnh).
      </p>
    </section>

    <section class="mt-10" aria-label="Soạn bài">
      <div class="lock-panel" data-compose-lock>
        <div class="lock-card">
          <div class="kicker text-xs text-white/60">XÁC THỰC</div>
          <h3 class="lock-title">Mở khóa khu soạn bài</h3>
          <p class="lock-desc">Nhập mật khẩu để dùng trình soạn bài.</p>
          <form class="lock-form" data-compose-form>
            <input class="input" type="password" name="passcode" placeholder="Mật khẩu" autocomplete="off" />
            <button class="btn" type="submit">Mở khóa</button>
          </form>
          <p class="lock-hint" data-compose-error></p>
        </div>
      </div>

      <div class="paper edge-torn p-6 sm:p-10 compose-wrap" data-compose-wrap>
        <div class="kicker text-xs text-black/50">NỘI DUNG</div>
        <div class="compose-grid">
          <label class="compose-field">
            <span>Tiêu đề</span>
            <input class="input" name="title" placeholder="Tiêu đề bài viết" required />
          </label>
          <label class="compose-field">
            <span>Mô tả ngắn</span>
            <input class="input" name="description" placeholder="Một câu giới thiệu ngắn" required />
          </label>
          <label class="compose-field">
            <span>Ngày đăng</span>
            <input class="input" name="pubDate" type="date" required />
          </label>
          <label class="compose-field">
            <span>Chủ đề</span>
            <select class="input" name="topic" required>
              {TOPICS.map((t) => (
                <option value={t.slug}>{t.label}</option>
              ))}
            </select>
          </label>
          <label class="compose-field">
            <span>Tác giả</span>
            <input class="input" name="author" placeholder="Tên người viết" required />
          </label>
          <label class="compose-field">
            <span>Địa điểm</span>
            <input class="input" name="location" placeholder="Địa điểm" required />
          </label>
          <label class="compose-field">
            <span>Thời gian sự kiện</span>
            <input class="input" name="eventTime" placeholder="Ví dụ: 20:30 - 21:00" required />
          </label>
          <label class="compose-field">
            <span>Viết lúc</span>
            <input class="input" name="writtenAt" placeholder="Ví dụ: 21/02/2026" required />
          </label>
          <label class="compose-field">
            <span>Chụp lúc</span>
            <input class="input" name="photoTime" placeholder="Ví dụ: 21/02/2026" required />
          </label>
          <label class="compose-field">
            <span>Ghi âm (URL)</span>
            <input class="input" name="voiceMemo" placeholder="https://..." required />
          </label>
          <label class="compose-field">
            <span>Tiêu đề ghi âm</span>
            <input class="input" name="voiceMemoTitle" placeholder="Tên đoạn ghi âm" required />
          </label>
          <label class="compose-field">
            <span>Video (URL)</span>
            <input class="input" name="videoUrl" placeholder="https://..." required />
          </label>
          <label class="compose-field">
            <span>Poster video (URL)</span>
            <input class="input" name="videoPoster" placeholder="https://..." required />
          </label>
        </div>

        <label class="compose-field mt-6">
          <span>Nội dung chính</span>
          <textarea class="input compose-textarea" name="body" rows={10} placeholder="Viết nội dung ở đây..." required></textarea>
        </label>

        <label class="compose-field mt-6">
          <span>Ảnh (chọn nhiều ảnh)</span>
          <input class="input" type="file" name="photos" accept="image/*" multiple required />
        </label>

        <label class="compose-field">
          <span>Ảnh cover (chọn số thứ tự)</span>
          <select class="input" name="coverIndex" required>
            {Array.from({ length: 36 }, (_, i) => (
              <option value={i}>Ảnh {i + 1}</option>
            ))}
          </select>
        </label>

        <div class="compose-preview" data-compose-preview></div>

        <div class="mt-6 flex flex-wrap gap-3">
          <button class="btn" type="button" data-compose-generate>Tạo markdown</button>
          <button class="btn" type="button" data-compose-download>Tải file .md</button>
          <button class="btn" type="button" data-compose-export>Xuất ảnh</button>
        </div>

        <div class="mt-6">
          <p class="kicker text-xs text-black/50">NỘI DUNG</p>
          <textarea class="input compose-textarea" data-compose-output rows={12} readonly></textarea>
          <p class="mt-2 text-xs text-black/50">
            Gợi ý: Tải file .md rồi chép vào <code>src/content/posts</code>, ảnh vào <code>public/photos/&lt;slug&gt;</code>.
          </p>
        </div>
      </div>
    </section>
  </main>

  <script is:inline>
    const PASS = "281225";
    const KEY = "tatw-compose-pass";

    const initCompose = () => {
      const lock = document.querySelector("[data-compose-lock]");
      const wrap = document.querySelector("[data-compose-wrap]");
      const form = document.querySelector("[data-compose-form]");
      const err = document.querySelector("[data-compose-error]");
      const preview = document.querySelector("[data-compose-preview]");
      const output = document.querySelector("[data-compose-output]");
      const genBtn = document.querySelector("[data-compose-generate]");
      const dlBtn = document.querySelector("[data-compose-download]");
      const exportBtn = document.querySelector("[data-compose-export]");

      if (!lock || !wrap || !form || !genBtn || !dlBtn || !exportBtn) return;
      if (form.dataset.bound === "1") return;
      form.dataset.bound = "1";

      const unlock = () => {
        lock.classList.add("is-hidden");
        wrap.classList.add("is-unlocked");
      };

      if (localStorage.getItem(KEY) === PASS) unlock();

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const input = form.querySelector("input[name='passcode']");
        const val = input?.value?.trim();
        if (val === PASS) {
          localStorage.setItem(KEY, PASS);
          unlock();
          if (err) err.textContent = "";
        } else {
          if (err) err.textContent = "Sai mật khẩu rồi.";
        }
      });

      const slugify = (s = "") =>
        s
          .toLowerCase()
          .normalize("NFKD")
          .replace(/[^\w\s-]/g, "")
          .trim()
          .replace(/\s+/g, "-")
          .replace(/-+/g, "-");

      const getFormData = () => {
        const data = {};
        wrap.querySelectorAll("input, select, textarea").forEach((el) => {
          if (el.name && el.type !== "file") data[el.name] = el.value?.trim?.() ?? "";
        });
        const files = wrap.querySelector("input[name='photos']")?.files ?? [];
        const coverIndex = Number(wrap.querySelector("select[name='coverIndex']")?.value ?? 0);
        return { data, files, coverIndex };
      };

      const renderPreview = (files, coverIndex) => {
        if (!preview) return;
        preview.innerHTML = "";
        Array.from(files).forEach((file, idx) => {
          const url = URL.createObjectURL(file);
          const card = document.createElement("div");
          card.className = "compose-thumb";
          const label = idx === coverIndex ? " (cover)" : "";
          card.innerHTML = `<img src="${url}" alt="photo-${idx + 1}" /><span>${file.name}${label}</span>`;
          preview.appendChild(card);
        });
      };

      const generateMarkdown = () => {
        const { data, files, coverIndex } = getFormData();
        renderPreview(files, coverIndex);
        const required = [
          "title",
          "description",
          "pubDate",
          "topic",
          "author",
          "location",
          "eventTime",
          "writtenAt",
          "photoTime",
          "voiceMemo",
          "voiceMemoTitle",
          "videoUrl",
          "videoPoster",
          "body",
        ];
        const missing = required.filter((k) => !data[k]);
        if (missing.length) {
          if (err) err.textContent = "Vui lòng điền đầy đủ metadata trước khi tạo.";
          return { md: "", slug: "", files };
        }
        if (!files.length) {
          if (err) err.textContent = "Vui lòng chọn ảnh và chọn ảnh cover.";
          return { md: "", slug: "", files };
        }
        const slug = slugify(data.title || "bai-chua-dat-ten");
        const photoCount = files.length ? Math.max(0, files.length - 1) : 0;
        const cover = Array.from(files)[coverIndex] ?? files[0];
        const md =
          `---\n` +
          `title: "${(data.title || "Chưa đặt tên").replaceAll('"', '\\"')}"\n` +
          `description: "${(data.description || "").replaceAll('"', '\\"')}"\n` +
          `pubDate: ${data.pubDate || new Date().toISOString().slice(0, 10)}\n` +
          `topic: ${data.topic || "two-of-us"}\n` +
          `cover: "/photos/${slug}/cover.jpg"\n` +
          `photoDir: "${slug}"\n` +
          `photoCount: ${photoCount}\n\n` +
          `author: "${(data.author || "").replaceAll('"', '\\"')}"\n` +
          `location: "${(data.location || "").replaceAll('"', '\\"')}"\n` +
          `eventTime: "${(data.eventTime || "").replaceAll('"', '\\"')}"\n` +
          `writtenAt: "${(data.writtenAt || "").replaceAll('"', '\\"')}"\n` +
          `photoTime: "${(data.photoTime || "").replaceAll('"', '\\"')}"\n\n` +
          `voiceMemo: "${(data.voiceMemo || "").replaceAll('"', '\\"')}"\n` +
          `voiceMemoTitle: "${(data.voiceMemoTitle || "").replaceAll('"', '\\"')}"\n` +
          `videoUrl: "${(data.videoUrl || "").replaceAll('"', '\\"')}"\n` +
          `videoPoster: "${(data.videoPoster || "").replaceAll('"', '\\"')}"\n\n` +
          `tags: []\n` +
          `draft: true\n` +
          `sideNote: ""\n` +
          `---\n\n` +
          `${data.body || "Viết ở đây."}\n`;
        if (output) output.value = md;
        return { md, slug, files };
      };

      genBtn.addEventListener("click", generateMarkdown);

      dlBtn.addEventListener("click", () => {
        const { md, slug } = generateMarkdown();
        if (!md) return;
        const blob = new Blob([md], { type: "text/markdown;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${slug}.md`;
        a.click();
        URL.revokeObjectURL(a.href);
      });

      exportBtn.addEventListener("click", () => {
        const { files, slug, coverIndex } = getFormData();
        if (!files.length || !slug) return;
        const ordered = Array.from(files);
        const cover = ordered.splice(coverIndex, 1)[0];
        ordered.unshift(cover);
        ordered.forEach((file, idx) => {
          const a = document.createElement("a");
          const name = idx === 0 ? "cover.jpg" : String(idx).padStart(2, "0") + "." + file.name.split(".").pop();
          a.href = URL.createObjectURL(file);
          a.download = `${slug}/${name}`;
          a.click();
          URL.revokeObjectURL(a.href);
        });
      });
    };

    initCompose();
    document.addEventListener("astro:page-load", initCompose);
  </script>
</BaseLayout>
