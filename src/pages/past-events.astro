---
import BaseLayout from "../layouts/BaseLayout.astro";
import RansomTitle from "../components/RansomTitle.astro";
---

<BaseLayout
  title="Past Events Archive — Two Against The World"
  active="past-events"
  description="Full list of events that have already passed in our timeline."
>
  <section class="paper edge-torn px-6 py-7 sm:px-8 sm:py-8 past-events-page" data-reveal>
    <p class="kicker text-[11px] text-black/50">Event Archive</p>
    <div class="mt-2">
      <RansomTitle text="Past Events" as="h1" stampEvery={0} class="text-[44px] sm:text-[56px]" />
    </div>

    <p class="mt-4 text-black/70">
      This is the full list of events that have passed. Every timestamp is kept as a somehow important milestone.
    </p>

    <div class="past-events-list" data-past-events-list aria-live="polite"></div>
  </section>

  <script is:inline>
    const initPastEventsPage = () => {
      const listEl = document.querySelector("[data-past-events-list]");
      if (!(listEl instanceof HTMLElement)) return;

      const storageKey = "twaw:past-events";
      const pad = (value) => String(value).padStart(2, "0");
      const read = () => {
        try {
          const raw = window.localStorage.getItem(storageKey);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : [];
        } catch (_error) {
          return [];
        }
      };

      const formatCompleted = (value) => {
        const ts = Number(value || 0);
        if (!Number.isFinite(ts) || ts <= 0) return "";
        try {
          return new Intl.DateTimeFormat("en-GB", {
            timeZone: "Asia/Ho_Chi_Minh",
            dateStyle: "medium",
            timeStyle: "short",
          }).format(new Date(ts));
        } catch (_error) {
          return "";
        }
      };

      const render = () => {
        const items = read().sort((a, b) => Number(b?.completedAt || 0) - Number(a?.completedAt || 0));
        listEl.textContent = "";

        if (!items.length) {
          const empty = document.createElement("div");
          empty.className = "past-events-empty";
          empty.textContent = "No past events yet.";
          listEl.appendChild(empty);
          return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((item, index) => {
          const card = document.createElement("article");
          card.className = "past-event-card";

          const head = document.createElement("div");
          head.className = "past-event-card__head";

          const title = document.createElement("h2");
          title.className = "past-event-card__title";
          title.textContent = `${item?.icon || "✦"} ${item?.name || "Event"}`;

          const number = document.createElement("span");
          number.className = "past-event-card__number";
          number.textContent = `#${index + 1}`;

          head.appendChild(title);
          head.appendChild(number);

          const meta = document.createElement("div");
          meta.className = "past-event-card__meta";
          const day = pad(item?.day || "0");
          const month = pad(item?.month || "0");
          const year = Number(item?.year || new Date().getFullYear());
          const completed = formatCompleted(item?.completedAt);
          meta.textContent = completed
            ? `${day}/${month}/${year} · ended at ${completed}`
            : `${day}/${month}/${year}`;

          card.appendChild(head);
          card.appendChild(meta);
          fragment.appendChild(card);
        });

        listEl.appendChild(fragment);
      };

      render();
    };

    initPastEventsPage();
    document.addEventListener("astro:page-load", initPastEventsPage);
  </script>
</BaseLayout>
