---
import BaseLayout from "../../layouts/BaseLayout.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import FeedCard from "../../components/FeedCard.astro";
import TopicCard from "../../components/TopicCard.astro";
import {
  DEFAULT_TOPIC_SLUG,
  normalizeTopicSlug,
  parseTopicSlug,
  resolveTopicSlug,
  TOPICS,
  topicLabel,
  TOPIC_COPY,
} from "../../config/topics";
import { ensurePostMediaSchema, ensurePostsSchema, getDb, type PostRecord } from "../../lib/d1";
import {
  getPublishedPostsFromContent,
  mergePostsBySlug,
  resolvePostCoverUrl,
  shouldUseContentFallback,
} from "../../lib/posts";
import { comparePostsByNewest } from "../../lib/postTime";

export const prerender = false;

const rawTopic = Astro.params.topic ?? DEFAULT_TOPIC_SLUG;
const normalizedTopic = normalizeTopicSlug(rawTopic);
const topicFromRoute = parseTopicSlug(normalizedTopic);
const topic = topicFromRoute ?? (normalizedTopic || DEFAULT_TOPIC_SLUG);
const label = topicLabel(topic);
const isLocked = topicFromRoute === "trash-bin";

let allPosts: PostRecord[] = [];
let dbPosts: PostRecord[] = [];
try {
  const allowBootstrap = Astro.locals?.runtime?.env?.ALLOW_SCHEMA_BOOTSTRAP === "true";
  const db = getDb(Astro.locals);
  await ensurePostsSchema(db, { allowBootstrap });
  await ensurePostMediaSchema(db, { allowBootstrap });
  const { results = [] } = await db
      .prepare(
      `SELECT
        id,
        slug,
        title,
        summary,
        COALESCE(
          NULLIF(posts.cover_url, ''),
          (
            SELECT pm.url
            FROM post_media pm
            WHERE pm.post_id = posts.id
            ORDER BY pm.sort_order ASC, datetime(pm.created_at) ASC
            LIMIT 1
          )
        ) as cover_url,
        video_url,
        video_poster,
        topic,
        author_name,
        published_at,
        published_tz,
        created_at,
        status,
        CASE
          WHEN pinned = 1 AND (pinned_until IS NULL OR datetime(pinned_until) > datetime('now')) THEN 1
          ELSE 0
        END as pinned,
        pinned_priority, pinned_until, pinned_style
       FROM posts
       WHERE status = 'published'
       ORDER BY pinned DESC, pinned_priority DESC,
         COALESCE(unixepoch(published_at), unixepoch(created_at), 0) DESC`
    )
    .all<PostRecord>();
  dbPosts = results ?? [];
  if (shouldUseContentFallback()) {
    const contentPosts = await getPublishedPostsFromContent();
    allPosts = mergePostsBySlug(dbPosts, contentPosts);
  } else {
    allPosts = dbPosts;
  }
} catch (err) {
  console.warn("Using content posts fallback:", err);
  allPosts = await getPublishedPostsFromContent();
}

const posts = allPosts
  .filter((p) => (topicFromRoute ? resolveTopicSlug(p.topic) === topicFromRoute : false))
  .sort((a, b) => {
    const pinnedA = Number(a.pinned ?? 0);
    const pinnedB = Number(b.pinned ?? 0);
    if (pinnedA !== pinnedB) return pinnedB - pinnedA;
    const priorityA = Number(a.pinned_priority ?? 0);
    const priorityB = Number(b.pinned_priority ?? 0);
    if (priorityA !== priorityB) return priorityB - priorityA;
    return comparePostsByNewest(a, b);
  });
const counts: Record<string, number> = {};
for (const p of allPosts) {
  const t = resolveTopicSlug(p.topic);
  counts[t] = (counts[t] ?? 0) + 1;
}
---

<BaseLayout title={label} active="topics">
  <main class="mx-auto max-w-7xl px-5 pb-20">
    <section class="paper edge-torn mt-8 p-6 sm:p-10" data-reveal>
      <p class="kicker text-[11px] text-black/50">Chủ đề</p>
      <RansomTitle text={label} as="h1" stampEvery={0} class="text-[40px] sm:text-[56px]" />
      <p class="mt-3 text-black/70">
        {TOPIC_COPY[topic] ?? "Chuyện cũ như mưa, đọc lại cho lòng vơi."}
      </p>

      <details class="topic-panel" data-topic-panel open>
        <summary class="topic-panel__summary">
          <span aria-hidden="true">▾</span>
          <span>Vừng ơi, mở cửa ra !!!!!!</span>
        </summary>
        <div class="topic-panel__body">
          <div class="topic-grid">
            {TOPICS.map((t) => (
              <TopicCard slug={t.slug} label={t.label} icon={t.icon} color={t.color} count={counts[t.slug] ?? 0} />
            ))}
          </div>
        </div>
      </details>

      <div class="mt-6">
        <a class="btn" href="/topics">Quay lại danh sách chủ đề</a>
      </div>
    </section>

    <section class="mt-10" aria-label="Bài viết trong chủ đề">
        {posts.length === 0 ? (
        <p class="text-white/70">Chưa có bài nào.</p>
      ) : (
        <div class="pinterest-grid">
          {posts.map((p) => (
            <FeedCard
              href={`/entries/${p.slug}${p.video_url ? "#entry-video" : ""}`}
              image={resolvePostCoverUrl(p)}
              title={p.title}
              description={p.summary ?? ""}
              author={p.author_name ?? ""}
              date={p.published_at ?? p.created_at}
              timeZone={p.published_tz ?? undefined}
              topic={p.topic ?? undefined}
              locked={isLocked}
              pinned={Boolean(p.pinned)}
              pinnedStyle={p.pinned_style ?? undefined}
            />
          ))}
        </div>
      )}
    </section>
  </main>

</BaseLayout>
