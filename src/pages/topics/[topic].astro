---
import BaseLayout from "../../layouts/BaseLayout.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import FeedCard from "../../components/FeedCard.astro";
import TopicCard from "../../components/TopicCard.astro";
import { TOPICS, topicLabel, TOPIC_COPY } from "../../config/topics";
import { ensurePostsSchema, getDb, type PostRecord } from "../../lib/d1";
import { getPublishedPostsFromContent, mergePostsBySlug } from "../../lib/posts";

export const prerender = false;

const { topic = "two-of-us" } = Astro.params;
const label = topicLabel(topic);
const isLocked = topic === "trash-bin";

let allPosts: PostRecord[] = [];
try {
  const db = getDb(Astro.locals);
  await ensurePostsSchema(db);
  const { results = [] } = await db
    .prepare(
      `SELECT id, slug, title, summary, cover_url, topic, published_at, pinned, status
       FROM posts
       WHERE status = 'published'`
    )
    .all<PostRecord>();
  const contentPosts = await getPublishedPostsFromContent();
  allPosts = mergePostsBySlug(results, contentPosts);
} catch (err) {
  console.warn("Using content posts fallback:", err);
  allPosts = await getPublishedPostsFromContent();
}

const posts = allPosts
  .filter((p) => (p.topic ?? "two-of-us") === topic)
  .sort((a, b) => {
    const pinnedA = a.pinned ? 1 : 0;
    const pinnedB = b.pinned ? 1 : 0;
    if (pinnedA !== pinnedB) return pinnedB - pinnedA;
    return +new Date(b.published_at ?? "") - +new Date(a.published_at ?? "");
  });
const counts: Record<string, number> = {};
for (const p of allPosts) {
  const t = p.topic ?? "two-of-us";
  counts[t] = (counts[t] ?? 0) + 1;
}
---

<BaseLayout title={label} active="topics">
  <main class="mx-auto max-w-6xl px-5 pb-20">
    <section class="paper edge-torn mt-8 p-6 sm:p-10" data-reveal>
      <p class="kicker text-[11px] text-black/50">Chủ đề</p>
      <RansomTitle text={label} as="h1" stampEvery={0} class="text-[40px] sm:text-[56px]" />
      <p class="mt-3 text-black/70">
        {TOPIC_COPY[topic] ?? "Chuyện cũ như mưa, đọc lại cho lòng vơi."}
      </p>

      <details class="topic-panel" data-topic-panel open>
        <summary class="topic-panel__summary">
          <span aria-hidden="true">▾</span>
          <span>Vừng ơi, mở cửa ra !!!!!!</span>
        </summary>
        <div class="topic-panel__body">
          <div class="topic-grid">
            {TOPICS.map((t) => (
              <TopicCard slug={t.slug} label={t.label} icon={t.icon} color={t.color} count={counts[t.slug] ?? 0} />
            ))}
          </div>
        </div>
      </details>

      <div class="mt-6">
        <a class="btn" href="/topics">Quay lại danh sách chủ đề</a>
      </div>
    </section>

    <section class="mt-10" aria-label="Bài viết trong chủ đề">
        {posts.length === 0 ? (
        <p class="text-white/70">Chưa có bài nào.</p>
      ) : (
        <div class={`lock-wrap ${isLocked ? "is-locked" : ""}`} data-lock-wrap>
          <div class="pinterest-grid lock-content" data-lock-content>
            {posts.map((p) => (
              <FeedCard
                href={`/entries/${p.slug}`}
                image={p.cover_url ?? "/noise.svg"}
                title={p.title}
                description={p.summary ?? ""}
                date={p.published_at ?? ""}
                topic={p.topic ?? undefined}
                locked={isLocked}
                pinned={Boolean(p.pinned)}
              />
            ))}
          </div>

          {isLocked && (
            <div class="lock-panel" data-lock-panel>
              <div class="lock-card">
                <div class="kicker text-xs text-white/60">ĐÃ KHÓA</div>
                <h3 class="lock-title">Thùng rác cảm xúc</h3>
                <p class="lock-desc">Nhập mật khẩu để mở kho lưu trữ bí mật.</p>
                <form class="lock-form" data-lock-form>
                  <input class="input" type="password" name="passcode" placeholder="Mật khẩu" autocomplete="off" />
                  <button class="btn" type="submit">Mở khóa</button>
                </form>
                <p class="lock-hint" data-lock-error></p>
              </div>
            </div>
          )}
        </div>
      )}
    </section>
  </main>

  {isLocked && (
    <script is:inline>
      const PASS = "281225";
      const KEY = "tatw-trash-pass";

      const initLock = () => {
        const wrap = document.querySelector("[data-lock-wrap]");
        const panel = document.querySelector("[data-lock-panel]");
        const form = document.querySelector("[data-lock-form]");
        const err = document.querySelector("[data-lock-error]");

        if (!wrap || !panel || !form) return;
        if (form.dataset.bound === "1") return;
        form.dataset.bound = "1";

        const unlock = () => {
          wrap.classList.add("is-unlocked");
          panel.classList.add("is-hidden");
        };

        if (localStorage.getItem(KEY) === PASS) unlock();

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const input = form.querySelector("input[name='passcode']");
          const val = input?.value?.trim();
          if (val === PASS) {
            localStorage.setItem(KEY, PASS);
            unlock();
            if (err) err.textContent = "";
          } else {
            if (err) err.textContent = "Sai mật khẩu rồi.";
          }
        });
      };

      initLock();
      document.addEventListener("astro:page-load", initLock);
    </script>
  )}
</BaseLayout>
