---
import BaseLayout from "../../layouts/BaseLayout.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import TopicCard from "../../components/TopicCard.astro";
import { resolveTopicSlug, TOPICS } from "../../config/topics";
import { ensurePostsSchema, getDb, type PostRecord } from "../../lib/d1";
import { getPublishedPostsFromContent, mergePostsBySlug, shouldUseContentFallback } from "../../lib/posts";

export const prerender = false;

let posts: PostRecord[] = [];
let dbPosts: PostRecord[] = [];
try {
  const allowBootstrap = Astro.locals?.runtime?.env?.ALLOW_SCHEMA_BOOTSTRAP === "true";
  const db = getDb(Astro.locals);
  await ensurePostsSchema(db, { allowBootstrap });
  const { results = [] } = await db
    .prepare(
      `SELECT id, slug, title, summary, cover_url, topic, published_at, created_at,
        CASE
          WHEN pinned = 1 AND (pinned_until IS NULL OR datetime(pinned_until) > datetime('now')) THEN 1
          ELSE 0
        END as pinned,
        pinned_priority, pinned_until, pinned_style
       FROM posts
       WHERE status = 'published'`
    )
    .all<PostRecord>();
  dbPosts = results ?? [];
  if (shouldUseContentFallback()) {
    const contentPosts = await getPublishedPostsFromContent();
    posts = mergePostsBySlug(dbPosts, contentPosts);
  } else {
    posts = dbPosts;
  }
} catch (err) {
  console.warn("Using content posts fallback:", err);
  posts = await getPublishedPostsFromContent();
}

const counts: Record<string, number> = {};
for (const p of posts) {
  const t = resolveTopicSlug(p.topic);
  counts[t] = (counts[t] ?? 0) + 1;
}
---

<BaseLayout title="Chủ đề" active="topics">
  <main class="mx-auto max-w-7xl px-5 pb-20">
    <section class="paper edge-torn mt-8 p-6 sm:p-10" data-reveal>
      <p class="kicker text-[11px] text-black/50">Chủ đề</p>
      <RansomTitle text="CHỦ ĐỀ" as="h1" stampEvery={0} class="text-[44px] sm:text-[60px]" />
      <p class="mt-3 text-black/70">
        Xem thì xem, đừng đọc quá kỹ, đừng đào sâu nhé, tao ngại đấy, xin đấy !!!!!!!!!!!!!!!!!!!!!
      </p>

      <details class="topic-panel" data-topic-panel open>
        <summary class="topic-panel__summary">
          <span aria-hidden="true">▾</span>
          <span>Vừng ơi, mở cửa ra !!!!!!</span>
        </summary>
        <div class="topic-panel__body">
          <div class="topic-grid">
            {TOPICS.map((t) => (
              <TopicCard slug={t.slug} label={t.label} icon={t.icon} color={t.color} count={counts[t.slug] ?? 0} />
            ))}
          </div>
        </div>
      </details>

      <div class="mt-6">
        <a class="btn" href="/entries">Thích xem thêm thì bấm vào đây</a>
      </div>
    </section>
  </main>
</BaseLayout>
