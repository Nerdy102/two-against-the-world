---
import { getCollection, getEntryBySlug } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import FrameWall from "../../components/FrameWall.astro";
import { formatDate } from "../../lib/formatDate";
import { topicLabel } from "../../config/topics";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const post = await getEntryBySlug("posts", slug!);
if (!post) throw new Error(`Post not found: ${slug}`);

const { Content } = await post.render();

// Safe helpers (avoid blank rendering)
const s = (v: unknown) => (typeof v === "string" ? v.trim() : "");
const joinTags = (tags: unknown) =>
  Array.isArray(tags) ? tags.filter(Boolean).join(", ") : "";

// Pull meta fields (your schema provides defaults, but this keeps it robust)
const author = s(post.data.author);
const location = s(post.data.location);
const eventTime = s(post.data.eventTime);
const writtenAt = s(post.data.writtenAt);
const photoTime = s(post.data.photoTime);
const sideNote = s(post.data.sideNote);
const tagsText = joinTags(post.data.tags);

// Build photo list: /public/photos/<photoDir>/01.jpg..N
const count = Number(post.data.photoCount ?? 0);
const photos = Array.from({ length: Math.max(0, count) }, (_, i) => {
  const n = String(i + 1).padStart(2, "0");
  return `/photos/${post.data.photoDir}/${n}.jpg`;
});

const wallImages = [
  { src: post.data.cover, alt: `${post.data.title} — cover` },
  ...photos.map((src, i) => ({ src, alt: `${post.data.title} — photo ${i + 1}` })),
];
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <main class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-10">
    {/* TOP PAPER (TITLE + META) */}
    <div class="paper edge-torn p-6 sm:p-10" data-reveal>
      <div class="kicker text-xs text-[rgba(0,0,0,0.58)]">ENTRY</div>

      <RansomTitle
        text={post.data.title}
        as="h1"
        stampEvery={0}
        class="mt-3 text-[40px] sm:text-[56px]"
      />

      {post.data.description && (
        <p class="mt-4 text-[rgba(0,0,0,0.70)] max-w-2xl">
          {post.data.description}
        </p>
      )}

      {/* META GRID */}
      <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div class="meta-card">
          <div class="meta-k">Published</div>
          <div class="meta-v">{formatDate(post.data.pubDate)}</div>
        </div>

        <div class="meta-card">
          <div class="meta-k">Topic</div>
          <div class="meta-v">{topicLabel(post.data.topic)}</div>
        </div>

        <div class="meta-card">
          <div class="meta-k">Photos</div>
          <div class="meta-v">{count}</div>
        </div>

        <div class="meta-card">
          <div class="meta-k">Author</div>
          <div class="meta-v">{author || "—"}</div>
        </div>

        <div class="meta-card">
          <div class="meta-k">Location</div>
          <div class="meta-v">{location || "—"}</div>
        </div>

        <div class="meta-card">
          <div class="meta-k">Event time</div>
          <div class="meta-v">{eventTime || "—"}</div>
        </div>

        <div class="meta-card">
          <div class="meta-k">Written at</div>
          <div class="meta-v">{writtenAt || "—"}</div>
        </div>

        <div class="meta-card">
          <div class="meta-k">Photo time</div>
          <div class="meta-v">{photoTime || "—"}</div>
        </div>

        <div class="meta-card">
          <div class="meta-k">Tags</div>
          <div class="meta-v">{tagsText || "—"}</div>
        </div>
      </div>

      {/* SIDE NOTE (OPTIONAL) */}
      {sideNote && (
        <div class="mt-6 meta-card">
          <div class="meta-k">Side note</div>
          <div class="meta-v">{sideNote}</div>
        </div>
      )}
    </div>

    {/* PHOTO WALL */}
    <section class="mt-10" aria-label="Photo wall">
      <FrameWall images={wallImages} seed={post.slug} />
    </section>

    {/* NOTES / BODY */}
    <section class="mt-10" aria-label="Notes" data-reveal>
      <div class="paper edge-torn p-6 sm:p-10 prose prose-scrap max-w-none">
        <Content />
      </div>
    </section>
  </main>
</BaseLayout>
