---
import { getCollection, getEntryBySlug } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import FrameWall from "../../components/FrameWall.astro";
import { formatDate } from "../../lib/formatDate";
import { topicLabel, topicMeta } from "../../config/topics";
import { PASSCODE } from "../../config/secrets";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const post = await getEntryBySlug("posts", slug!);
if (!post) throw new Error(`Post not found: ${slug}`);

const { Content } = await post.render();

// Safe helpers (avoid blank rendering)
const s = (v: unknown) => (typeof v === "string" ? v.trim() : "");
const joinTags = (tags: unknown) =>
  Array.isArray(tags) ? tags.filter(Boolean).join(", ") : "";

// Pull meta fields (your schema provides defaults, but this keeps it robust)
const author = s(post.data.author);
const location = s(post.data.location);
const eventTime = s(post.data.eventTime);
const writtenAt = s(post.data.writtenAt);
const photoTime = s(post.data.photoTime);
const sideNote = s(post.data.sideNote);
const tagsText = joinTags(post.data.tags);
const voiceMemo = s(post.data.voiceMemo);
const voiceMemoTitle = s(post.data.voiceMemoTitle);
const videoUrl = s(post.data.videoUrl);
const videoPoster = s(post.data.videoPoster);
const isLocked = post.data.topic === "trash-bin";

const toEmbedUrl = (url: string) => {
  if (url.includes("youtube.com/watch")) {
    const match = url.match(/[?&]v=([^&]+)/);
    const id = match?.[1];
    return id ? `https://www.youtube.com/embed/${id}` : url;
  }
  if (url.includes("youtu.be/")) {
    const id = url.split("youtu.be/")[1]?.split("?")[0];
    return id ? `https://www.youtube.com/embed/${id}` : url;
  }
  if (url.includes("vimeo.com/")) {
    const id = url.split("vimeo.com/")[1]?.split("?")[0];
    return id ? `https://player.vimeo.com/video/${id}` : url;
  }
  return url;
};

const videoIsFile = /\.(mp4|webm|ogg)$/i.test(videoUrl);
const videoEmbedUrl = videoUrl ? toEmbedUrl(videoUrl) : "";

// Build photo list: /public/photos/<photoDir>/01.jpg..N
const count = Number(post.data.photoCount ?? 0);
const photos = Array.from({ length: Math.max(0, count) }, (_, i) => {
  const n = String(i + 1).padStart(2, "0");
  return `/photos/${post.data.photoDir}/${n}.jpg`;
});

const wallImages = [
  { src: post.data.cover, alt: `${post.data.title} ‚Äî cover` },
  ...photos.map((src, i) => ({ src, alt: `${post.data.title} ‚Äî photo ${i + 1}` })),
];
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <main class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-10">
    {isLocked && (
      <div class="lock-panel" data-lock-panel>
        <div class="lock-card">
          <div class="kicker text-xs text-white/60">ƒê√É KH√ìA</div>
          <h3 class="lock-title">Th√πng r√°c c·∫£m x√∫c</h3>
          <p class="lock-desc">Nh·∫≠p pass ƒë·ªÉ m·ªü kho x√†m x√≠ n√†y nh√© üòú</p>
          <form class="lock-form" data-lock-form>
            <input class="input" type="password" name="passcode" placeholder="M·∫≠t kh·∫©u" autocomplete="off" />
            <button class="btn" type="submit">M·ªü kh√≥a</button>
          </form>
          <p class="lock-hint" data-lock-error></p>
        </div>
      </div>
    )}

    <div class={`lock-wrap ${isLocked ? "is-locked" : ""}`} data-lock-wrap>
      <div class="lock-content" data-lock-content>
    {/* TOP PAPER (TITLE + META) */}
    <div class="paper edge-torn p-6 sm:p-10" data-reveal>
      <div class="kicker text-xs text-[rgba(0,0,0,0.58)]">N·ªòI DUNG X√ÄM NG√îN üòú</div>

      <RansomTitle
        text={post.data.title}
        as="h1"
        stampEvery={0}
        class="mt-3 text-[40px] sm:text-[56px]"
      />

      {post.data.description && (
        <p class="mt-4 text-[rgba(0,0,0,0.70)] max-w-2xl">
          {post.data.description}
        </p>
      )}

      <div class="mt-5 flex flex-wrap items-center gap-3 text-[12px] text-black/60">
        <span>Ch·ªß ƒë·ªÅ: {topicLabel(post.data.topic)}</span>
        <span>‚Ä¢</span>
        <span>{formatDate(post.data.pubDate)}</span>
      </div>
    </div>

    {/* PHOTO WALL */}
    <section class="mt-10" aria-label="B·ª©c t∆∞·ªùng ·∫£nh">
      <FrameWall images={wallImages} seed={post.slug} />
    </section>

    {/* MEDIA */}
    {(voiceMemo || videoUrl) && (
      <section class="mt-10" aria-label="ƒêa ph∆∞∆°ng ti·ªán" data-reveal>
        <div class="paper edge-torn p-6 sm:p-10">
          <div class="kicker text-xs text-black/50">ƒêA PH∆Ø∆†NG TI·ªÜN</div>
          <h2 class="mt-3 text-[26px] sm:text-[32px] font-semibold text-black/80">Nghe & xem</h2>

          {voiceMemo && (
            <div class="mt-4">
              <div class="meta-label">Ghi √¢m</div>
              {voiceMemoTitle && <div class="mt-1 text-black/70">{voiceMemoTitle}</div>}
              <audio class="mt-2 w-full" controls src={voiceMemo}></audio>
            </div>
          )}

          {videoUrl && (
            <div class="mt-6">
              <div class="meta-label">Video</div>
              {videoIsFile ? (
                <video class="mt-2 w-full rounded-2xl border border-black/10" controls poster={videoPoster || undefined}>
                  <source src={videoUrl} />
                </video>
              ) : (
                <div class="mt-2 aspect-video w-full overflow-hidden rounded-2xl border border-black/10">
                  <iframe
                    src={videoEmbedUrl}
                    class="h-full w-full"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    title="Video"
                  ></iframe>
                </div>
              )}
            </div>
          )}
        </div>
      </section>
    )}

    {/* NOTES / BODY */}
    <section class="mt-10" aria-label="Ghi ch√∫" data-reveal>
      <div class="paper edge-torn p-6 sm:p-10 prose prose-scrap max-w-none">
        <Content />
      </div>
    </section>

    {/* COMMENTS */}
    <section class="mt-10" aria-label="B√¨nh lu·∫≠n" data-reveal>
      <div class="paper edge-torn p-6 sm:p-10">
        <div class="kicker text-xs text-black/50">üí¨</div>
        <h2 class="mt-3 text-[26px] sm:text-[32px] font-semibold text-black/80">ƒê·ªÉ l·∫°i l·ªùi nh·∫Øn x√†m x√≠</h2>
        <p class="mt-2 text-black/60">Nh·∫≠p t√™n + bi·ªát danh (·∫©n danh th√¥i nh√©) r·ªìi th·∫£ v√†i d√≤ng.</p>

        <form class="comment-form mt-6" data-comment-form data-comment-slug={post.slug}>
          <label class="comment-field">
            <span>T√™n</span>
            <input class="input" name="name" placeholder="T√™n c·ªßa b·∫°n" required />
          </label>
          <label class="comment-field">
            <span>Bi·ªát danh</span>
            <input class="input" name="nickname" placeholder="Bi·ªát danh (·∫©n danh)" required />
          </label>
          <label class="comment-field comment-field--full">
            <span>N·ªôi dung</span>
            <textarea class="input comment-textarea" name="message" rows={4} placeholder="Vi·∫øt g√¨ ƒë√≥..." required></textarea>
          </label>
          <button class="btn comment-submit" type="submit">G·ª≠i l·ªùi nh·∫Øn</button>
          <p class="comment-hint" data-comment-error></p>
        </form>

        <div class="comment-list mt-8" data-comment-list></div>
      </div>
    </section>

    {/* META GRID */}
    <section class="mt-10" aria-label="Chi ti·∫øt b√†i vi·∫øt" data-reveal>
      <div class="paper edge-torn p-6 sm:p-10">
        <div class="kicker text-xs text-black/50">CHUY·ªÜN L·∫ÆT NH·∫ÆT ‚ú®</div>
        <h2 class="mt-3 text-[26px] sm:text-[32px] font-semibold text-black/80">Chuy·ªán nh·ªè x√≠u ‚ú®</h2>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="meta-card">
            <div class="meta-k">Ng√†y ƒëƒÉng</div>
            <div class="meta-v">{formatDate(post.data.pubDate)}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Ch·ªß ƒë·ªÅ</div>
            <div class="meta-v">
              <span style={`color:${topicMeta(post.data.topic).color};`}>{topicLabel(post.data.topic)}</span>
            </div>
          </div>

          <div class="meta-card">
            <div class="meta-k">S·ªë ·∫£nh</div>
            <div class="meta-v">{count}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">T√°c gi·∫£</div>
            <div class="meta-v">{author || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">ƒê·ªãa ƒëi·ªÉm</div>
            <div class="meta-v">{location || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Th·ªùi gian s·ª± ki·ªán</div>
            <div class="meta-v">{eventTime || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Vi·∫øt l√∫c</div>
            <div class="meta-v">{writtenAt || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Ch·ª•p l√∫c</div>
            <div class="meta-v">{photoTime || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Tags</div>
            <div class="meta-v">{tagsText || "‚Äî"}</div>
          </div>
        </div>

        {sideNote && (
          <div class="mt-6 meta-card">
            <div class="meta-k">Ghi ch√∫ th√™m</div>
            <div class="meta-v">{sideNote}</div>
          </div>
        )}
      </div>
    </section>
      </div>
    </div>
  </main>

  {isLocked && (
    <script is:inline>
      const PASS = "281225";
      const KEY = "tatw-trash-pass";

      const initLock = () => {
        const wrap = document.querySelector("[data-lock-wrap]");
        const panel = document.querySelector("[data-lock-panel]");
        const form = document.querySelector("[data-lock-form]");
        const err = document.querySelector("[data-lock-error]");

        if (!wrap || !panel || !form) return;
        if (form.dataset.bound === "1") return;
        form.dataset.bound = "1";

        const unlock = () => {
          wrap.classList.add("is-unlocked");
          panel.classList.add("is-hidden");
        };

        if (localStorage.getItem(KEY) === PASS) unlock();

        form.addEventListener("submit", (e) => {
          e.preventDefault();
          const input = form.querySelector("input[name='passcode']");
          const val = input?.value?.trim();
          if (val === PASS) {
            localStorage.setItem(KEY, PASS);
            unlock();
            if (err) err.textContent = "";
          } else {
            if (err) err.textContent = "Sai m·∫≠t kh·∫©u r·ªìi.";
          }
        });
      };

      initLock();
      document.addEventListener("astro:page-load", initLock);
    </script>
  )}

  <script is:inline>
    const initComments = () => {
      const form = document.querySelector("[data-comment-form]");
      const list = document.querySelector("[data-comment-list]");
      const err = document.querySelector("[data-comment-error]");

      if (!form || !list) return;
      if (form.dataset.bound === "1") return;
      form.dataset.bound = "1";

      const slug = form.dataset.commentSlug || "unknown";
      const key = `tatw-comments-${slug}`;

      const load = () => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      };

      const save = (items) => {
        localStorage.setItem(key, JSON.stringify(items));
      };

      const render = () => {
        const items = load();
        if (!items.length) {
          list.innerHTML = "<p class='text-black/60 text-sm'>Ch∆∞a c√≥ l·ªùi nh·∫Øn n√†o.</p>";
          return;
        }
        list.innerHTML = items
          .map(
            (item) => `
              <div class="comment-card">
                <div class="comment-meta">
                  <span class="comment-name">${item.name}</span>
                  <span class="comment-nick">${item.nickname}</span>
                  <span class="comment-time">${item.time}</span>
                </div>
                <p class="comment-body">${item.message}</p>
              </div>
            `
          )
          .join("");
      };

      render();

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = form.querySelector("input[name='name']")?.value?.trim();
        const nickname = form.querySelector("input[name='nickname']")?.value?.trim();
        const message = form.querySelector("textarea[name='message']")?.value?.trim();
        if (!name || !nickname || !message) {
          if (err) err.textContent = "ƒêi·ªÅn ƒë·ªß 3 √¥ m·ªõi ƒë∆∞·ª£c nh√©!";
          return;
        }
        const items = load();
        items.unshift({
          name,
          nickname,
          message,
          time: new Date().toLocaleString("vi-VN"),
        });
        save(items.slice(0, 50));
        form.reset();
        if (err) err.textContent = "";
        render();
      });
    };

    initComments();
    document.addEventListener("astro:page-load", initComments);
  </script>
</BaseLayout>
