---
import BaseLayout from "../../layouts/BaseLayout.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import FrameWall from "../../components/FrameWall.astro";
import { formatDate } from "../../lib/formatDate";
import { topicLabel, topicMeta } from "../../config/topics";
import { getDb, type PostRecord } from "../../lib/d1";
import { getHybridPostBySlug } from "../../lib/posts";
import { marked } from "marked";

export const prerender = false;

const { slug } = Astro.params;
let post: PostRecord | null = null;
try {
  const db = getDb(Astro.locals);
  post = await db
    .prepare(
      `SELECT *
       FROM posts
       WHERE slug = ? AND status = 'published'
       LIMIT 1`
    )
    .bind(slug)
    .first<PostRecord>();
  post = await getHybridPostBySlug(post, slug);
} catch (err) {
  console.warn("Using content post fallback:", err);
  post = await getHybridPostBySlug(null, slug);
}
if (!post) throw new Error(`Post not found: ${slug}`);

const contentHtml = marked.parse(post.body_markdown ?? post.content_md ?? "");
const turnstileSiteKey = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY ?? "";
const siteUrl = import.meta.env.PUBLIC_SITE_URL ?? "";
const canonicalUrl = siteUrl ? new URL(`/entries/${post.slug}`, siteUrl).toString() : "";

// Safe helpers (avoid blank rendering)
const s = (v: unknown) => (typeof v === "string" ? v.trim() : "");
const joinTags = (tags: unknown) =>
  Array.isArray(tags) ? tags.filter(Boolean).join(", ") : "";

// Pull meta fields (your schema provides defaults, but this keeps it robust)
const author = s(post.author);
const location = s(post.location);
const eventTime = s(post.event_time);
const writtenAt = s(post.written_at);
const photoTime = s(post.photo_time);
const sideNote = s(post.side_note);
const tagsText = joinTags(
  post.tags_csv ? post.tags_csv.split(",").map((t) => t.trim()).filter(Boolean) : []
);
const voiceMemo = s(post.voice_memo);
const voiceMemoTitle = s(post.voice_memo_title);

// Build photo list: /public/photos/<photoDir>/01.jpg..N
const count = Number(post.photo_count ?? 0);
const photos =
  post.photo_dir && count > 0
    ? Array.from({ length: Math.max(0, count) }, (_, i) => {
        const n = String(i + 1).padStart(2, "0");
        return `/photos/${post.photo_dir}/${n}.jpg`;
      })
    : [];

const wallImages = [
  { src: post.cover_url ?? "/noise.svg", alt: `${post.title} ‚Äî cover` },
  ...photos.map((src, i) => ({ src, alt: `${post.title} ‚Äî photo ${i + 1}` })),
];
const isSingleImage = wallImages.length === 1;
const useBlendedStory = isSingleImage;
---

<BaseLayout title={post.title} description={post.summary ?? ""}>
  <main class="mx-auto max-w-5xl px-4 sm:px-6 lg:px-8 py-10">
    {/* TOP PAPER (TITLE + META) */}
    <div class="paper edge-torn p-6 sm:p-10 entry-hero" data-reveal>
      <div class="kicker text-xs text-[rgba(0,0,0,0.58)]">Emotional Anchor</div>

      <RansomTitle text={post.title} as="h1" stampEvery={0} class="mt-3 text-[40px] sm:text-[56px]" />

      {(post.summary || author) && (
        <p class="mt-4 text-[rgba(0,0,0,0.70)] max-w-2xl entry-summary">
          {post.summary}
          {author && (
            <span class="entry-summary__author">
              {post.summary ? " ¬∑ " : ""}by {author}
            </span>
          )}
        </p>
      )}

      <div class="entry-meta mt-5 flex flex-wrap items-center gap-3 text-[12px] text-black/60">
        <span>Ch·ªß ƒë·ªÅ: {topicLabel(post.topic ?? undefined)}</span>
        <span>‚Ä¢</span>
        <span>{formatDate(post.published_at ?? post.created_at)}</span>
      </div>

      <div class="entry-share">
        <button
          class="share-btn share-btn--hero"
          type="button"
          data-share-link
          data-share-url={canonicalUrl}
          aria-label="Chia s·∫ª b√†i vi·∫øt"
          title="Chia s·∫ª"
        >
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path
              d="M21.8 3.2L10.2 12.7"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M21.8 3.2l-5.9 17.4-3.2-6.1-6.9-2.1 16-9.2z"
              fill="none"
              stroke="currentColor"
              stroke-width="1.8"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <span class="share-btn__label">SHARE</span>
        </button>
        <span class="share-toast" data-share-state role="status" aria-live="polite" aria-atomic="true"></span>
      </div>
    </div>

    {/* PHOTO WALL */}
    {!useBlendedStory && (
      <section class="mt-10" aria-label="B·ª©c t∆∞·ªùng ·∫£nh">
        <FrameWall images={wallImages} seed={post.slug} />
      </section>
    )}

    {/* MEDIA */}
    {voiceMemo && (
      <section class="mt-10" aria-label="ƒêa ph∆∞∆°ng ti·ªán" data-reveal>
        <div class="paper edge-torn p-6 sm:p-10">
          <div class="kicker text-xs text-black/50">ƒêA PH∆Ø∆†NG TI·ªÜN</div>
          <h2 class="mt-3 text-[26px] sm:text-[32px] font-semibold text-black/80">Nghe & xem</h2>

          <div class="mt-4">
            <div class="meta-label">Ghi √¢m</div>
            {voiceMemoTitle && <div class="mt-1 text-black/70">{voiceMemoTitle}</div>}
            <audio class="mt-2 w-full" controls src={voiceMemo}></audio>
          </div>
        </div>
      </section>
    )}

    {/* NOTES / BODY */}
    <section class="mt-10" aria-label="Ghi ch√∫" data-reveal>
      {useBlendedStory ? (
        <div class="paper edge-torn post-story">
          <div class="post-story__media">
            <img src={wallImages[0]?.src} alt={wallImages[0]?.alt ?? ""} loading="lazy" decoding="async" />
          </div>
          <div class="post-story__body p-6 sm:p-10 prose prose-scrap max-w-none">
            <div set:html={contentHtml} />
          </div>
        </div>
      ) : (
        <div class="paper edge-torn p-6 sm:p-10 prose prose-scrap max-w-none">
          <div set:html={contentHtml} />
        </div>
      )}
    </section>

    {/* COMMENTS */}
    <section class="mt-10" aria-label="B√¨nh lu·∫≠n" data-reveal>
      <div class="paper paper--alt edge-torn p-6 sm:p-10 comment-slab">
        <div class="kicker text-xs text-black/50">üí¨</div>
        <h2 class="mt-3 text-[26px] sm:text-[32px] font-semibold text-black/80">ƒê·ªÉ l·∫°i l·ªùi nh·∫Øn x√†m x√≠</h2>
        <p class="mt-2 text-black/60">Nh·∫≠p bi·ªát danh r·ªìi th·∫£ v√†i d√≤ng nha.</p>

        <div class="mt-4 flex flex-wrap items-center gap-3">
          <div class="reaction-bar" data-reaction-bar>
            <button class="btn reaction-btn" type="button" data-reaction-kind="ü•∫">
              ü•∫ <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="ü§ß">
              ü§ß <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="üò≠">
              üò≠ <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="ü§°">
              ü§° <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="üòé">
              üòé <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="‚ò∫Ô∏è">
              ‚ò∫Ô∏è <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="üòñ">
              üòñ <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="üòè">
              üòè <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="ü•π">
              ü•π <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="ü§™">
              ü§™ <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="ü§ì">
              ü§ì <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="üòà">
              üòà <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="üòº">
              üòº <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="ü´∂üèª">
              ü´∂üèª <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="‚úåüèª">
              ‚úåüèª <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="üñïüèª">
              üñïüèª <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="üíã">
              üíã <span data-reaction-count>0</span>
            </button>
            <button class="btn reaction-btn" type="button" data-reaction-kind="üëÄ">
              üëÄ <span data-reaction-count>0</span>
            </button>
          </div>
          <span class="text-xs text-black/50" data-reaction-state>Ch·ªçn icon ƒë·ªÉ th·∫£ c·∫£m x√∫c.</span>
        </div>

        <form class="comment-form mt-6" data-comment-form data-comment-slug={post.slug}>
          <label class="comment-field">
            <span>Bi·ªát danh</span>
            <input class="input" name="nickname" placeholder="Bi·ªát danh (·∫©n danh)" required />
          </label>
          <label class="comment-field comment-field--full">
            <span>N·ªôi dung</span>
            <textarea class="input comment-textarea" name="message" rows={4} placeholder="Vi·∫øt g√¨ ƒë√≥..." required></textarea>
          </label>
          <button class="btn comment-submit" type="submit">G·ª≠i l·ªùi nh·∫Øn</button>
          <p class="comment-hint" data-comment-error></p>
          <div class="comment-toast" data-comment-toast role="status" aria-live="polite" aria-atomic="true"></div>
        </form>

        {turnstileSiteKey && (
          <div class="mt-4">
            <div
              class="cf-turnstile"
              data-sitekey={turnstileSiteKey}
              data-theme="light"
              data-size="flexible"
              data-appearance="interaction-only"
              data-turnstile-widget
            ></div>
          </div>
        )}

        <div class="comment-list mt-8" data-comment-list></div>
      </div>
    </section>

    {/* META GRID */}
    <section class="mt-10" aria-label="Chi ti·∫øt b√†i vi·∫øt" data-reveal>
      <div class="paper paper--alt edge-torn p-6 sm:p-10 entry-meta-wrap">
        <div class="kicker text-xs text-black/50">CHUY·ªÜN L·∫ÆT NH·∫ÆT ‚ú®</div>
        <h2 class="mt-3 text-[26px] sm:text-[32px] font-semibold text-black/80">Chuy·ªán nh·ªè x√≠u ‚ú®</h2>

        <div class="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="meta-card">
            <div class="meta-k">Ng√†y ƒëƒÉng</div>
            <div class="meta-v">{formatDate(post.published_at ?? post.created_at)}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Ch·ªß ƒë·ªÅ</div>
            <div class="meta-v">
              <span style={`color:${topicMeta(post.topic ?? undefined).color};`}>
                {topicLabel(post.topic ?? undefined)}
              </span>
            </div>
          </div>

          <div class="meta-card">
            <div class="meta-k">S·ªë ·∫£nh</div>
            <div class="meta-v">{count}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">T√°c gi·∫£</div>
            <div class="meta-v">{author || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">ƒê·ªãa ƒëi·ªÉm</div>
            <div class="meta-v">{location || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Th·ªùi gian s·ª± ki·ªán</div>
            <div class="meta-v">{eventTime || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Vi·∫øt l√∫c</div>
            <div class="meta-v">{writtenAt || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Ch·ª•p l√∫c</div>
            <div class="meta-v">{photoTime || "‚Äî"}</div>
          </div>

          <div class="meta-card">
            <div class="meta-k">Tags</div>
            <div class="meta-v">{tagsText || "‚Äî"}</div>
          </div>
        </div>

        {sideNote && (
          <div class="mt-6 meta-card">
            <div class="meta-k">Ghi ch√∫ th√™m</div>
            <div class="meta-v">{sideNote}</div>
          </div>
        )}
      </div>
    </section>
  </main>

  <script is:inline>
    const initComments = () => {
      const form = document.querySelector("[data-comment-form]");
      const list = document.querySelector("[data-comment-list]");
      const err = document.querySelector("[data-comment-error]");
      const toast = document.querySelector("[data-comment-toast]");
      const hasTurnstile = Boolean(document.querySelector("[data-turnstile-widget]"));

      if (!form || !list) return;
      if (form.dataset.bound === "1") return;
      form.dataset.bound = "1";

      const slug = form.dataset.commentSlug || "unknown";
      const escapeHtml = (value = "") =>
        String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      const render = (items = []) => {
        if (!items.length) {
          list.innerHTML = "<p class='text-black/60 text-sm'>Ch∆∞a c√≥ l·ªùi nh·∫Øn n√†o.</p>";
          return;
        }
        list.innerHTML = items
          .map(
            (item) => `
              <div class="comment-card">
                <div class="comment-meta">
                  <span class="comment-name">${escapeHtml(item.display_name || "·∫®n danh")}</span>
                  <span class="comment-time">${new Date(item.created_at).toLocaleString("vi-VN")}</span>
                </div>
                <p class="comment-body">${escapeHtml(item.body)}</p>
              </div>
            `
          )
          .join("");
      };

      const refresh = async () => {
        try {
          const res = await fetch(`/api/comments?slug=${encodeURIComponent(slug)}`);
          if (!res.ok) throw new Error("Failed");
          const data = await res.json();
          render(data.comments || []);
        } catch (error) {
          if (err) err.textContent = "Ch∆∞a t·∫£i ƒë∆∞·ª£c l·ªùi nh·∫Øn.";
        }
      };

      refresh();
      const poll = setInterval(refresh, 5000);

      let toastTimeout = null;
      const showToast = (message, variant = "error") => {
        if (!toast) return;
        toast.textContent = message;
        toast.dataset.state = variant;
        toast.classList.add("is-visible");
        if (toastTimeout) window.clearTimeout(toastTimeout);
        toastTimeout = window.setTimeout(() => {
          toast.classList.remove("is-visible");
          toast.textContent = "";
          toast.dataset.state = "";
        }, 2200);
      };

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const nickname = form.querySelector("input[name='nickname']")?.value?.trim();
        const message = form.querySelector("textarea[name='message']")?.value?.trim();
        if (!nickname || !message) {
          if (err) err.textContent = "Nh·∫≠p bi·ªát danh + l·ªùi nh·∫Øn m·ªõi ƒë∆∞·ª£c nh√©!";
          showToast("Nh·∫≠p bi·ªát danh + l·ªùi nh·∫Øn m·ªõi ƒë∆∞·ª£c nh√©!");
          return;
        }
        fetch("/api/comments", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({
            slug,
            displayName: nickname,
            body: message,
            turnstileToken: hasTurnstile && window.turnstile ? window.turnstile.getResponse() : null,
          }),
        })
          .then(async (res) => {
            const data = await res.json().catch(() => ({}));
            if (!res.ok) {
              const messageText = data?.error || "G·ª≠i ch∆∞a ƒë∆∞·ª£c, th·ª≠ l·∫°i sau nha.";
              if (err) err.textContent = messageText;
              showToast(messageText);
              return;
            }
            form.reset();
            if (err) {
              err.textContent = data?.status === "pending" ? "Comment ƒëang ch·ªù duy·ªát." : "";
            }
            if (data?.status === "pending") {
              showToast("Comment ƒëang ch·ªù duy·ªát.", "info");
            }
            if (hasTurnstile && window.turnstile) {
              window.turnstile.reset();
            }
            refresh();
          })
          .catch(() => {
            const messageText = "G·ª≠i ch∆∞a ƒë∆∞·ª£c, th·ª≠ l·∫°i sau nha.";
            if (err) err.textContent = messageText;
            showToast(messageText);
          });
      });

      document.addEventListener("astro:before-swap", () => clearInterval(poll), { once: true });
    };

    initComments();
    document.addEventListener("astro:page-load", initComments);
  </script>

  {turnstileSiteKey && (
    <script is:inline src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  )}

  <script is:inline>
    const initReactions = () => {
      const bar = document.querySelector("[data-reaction-bar]");
      const stateEl = document.querySelector("[data-reaction-state]");
      const shareBtn = document.querySelector("[data-share-link]");
      const shareState = document.querySelector("[data-share-state]");
      const form = document.querySelector("[data-comment-form]");
      if (!bar || !form) return;
      if (bar.dataset.bound === "1") return;
      bar.dataset.bound = "1";

      const buttons = Array.from(bar.querySelectorAll("[data-reaction-kind]"));
      const slug = form.dataset.commentSlug || "unknown";

      const render = ({ counts = {}, reactedKinds = [], total = 0 }) => {
        buttons.forEach((button) => {
          const kind = button.dataset.reactionKind;
          if (!kind) return;
          const countEl = button.querySelector("[data-reaction-count]");
          const count = Number(counts[kind] ?? 0);
          if (countEl) countEl.textContent = count;
          button.classList.toggle("is-active", reactedKinds.includes(kind));
        });
        if (stateEl) {
          stateEl.textContent = total
            ? `ƒê√£ th·∫£ ${total} c·∫£m x√∫c.`
            : "Ch·ªçn icon ƒë·ªÉ th·∫£ c·∫£m x√∫c.";
        }
      };

      const load = async () => {
        const res = await fetch(`/api/reactions?slug=${encodeURIComponent(slug)}`);
        if (!res.ok) return;
        const data = await res.json();
        render(data);
      };

      buttons.forEach((button) => {
        button.addEventListener("click", async () => {
          const kind = button.dataset.reactionKind;
          if (!kind) return;
          const res = await fetch("/api/reactions", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ slug, kind }),
          });
          if (!res.ok) return;
          const data = await res.json();
          render(data);
        });
      });

      let shareTimeout = null;
      const showShareToast = (message, variant = "success") => {
        if (!shareState) return;
        shareState.textContent = message;
        shareState.dataset.state = variant;
        shareState.classList.add("is-visible");
        if (shareTimeout) window.clearTimeout(shareTimeout);
        shareTimeout = window.setTimeout(() => {
          shareState.classList.remove("is-visible");
          shareState.textContent = "";
          shareState.dataset.state = "";
        }, 2000);
      };

      const fallbackCopy = (text) => {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.setAttribute("readonly", "");
        textarea.style.position = "absolute";
        textarea.style.left = "-9999px";
        document.body.appendChild(textarea);
        textarea.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(textarea);
        return ok;
      };

      shareBtn?.addEventListener("click", async () => {
        const url = shareBtn.getAttribute("data-share-url") || window.location.href;
        if (navigator.clipboard?.writeText) {
          try {
            await navigator.clipboard.writeText(url);
            showShareToast("Copied!");
            return;
          } catch (error) {
            // fall through to manual copy prompt
          }
        }
        const ok = fallbackCopy(url);
        if (ok) {
          showShareToast("Copied!");
          return;
        }
        const manual = window.prompt("Sao ch√©p li√™n k·∫øt:", url);
        showShareToast(manual !== null ? "Copied!" : "Kh√¥ng sao ch√©p ƒë∆∞·ª£c", manual !== null ? "success" : "error");
      });

      load();
    };

    initReactions();
    document.addEventListener("astro:page-load", initReactions);
  </script>
</BaseLayout>
