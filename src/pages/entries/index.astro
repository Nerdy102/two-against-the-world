---
import BaseLayout from "../../layouts/BaseLayout.astro";
import FeedCard from "../../components/FeedCard.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import { getCollection } from "astro:content";
import { formatDate } from "../../lib/formatDate";

const posts = (await getCollection("posts"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => {
    const pinnedA = a.data.pinned ? 1 : 0;
    const pinnedB = b.data.pinned ? 1 : 0;
    if (pinnedA !== pinnedB) return pinnedB - pinnedA;
    return +new Date(b.data.pubDate) - +new Date(a.data.pubDate);
  });

const dateCounts: Record<string, number> = {};
for (const p of posts) {
  const dateKey = p.data.pubDate.toISOString().slice(0, 10);
  dateCounts[dateKey] = (dateCounts[dateKey] ?? 0) + 1;
}

const seenDates = new Set<string>();
const dateStats = Object.entries(dateCounts)
  .map(([dateKey, count]) => ({
    dateKey,
    count,
    label: formatDate(dateKey),
  }))
  .sort((a, b) => b.dateKey.localeCompare(a.dateKey));
---

<BaseLayout title="Nháº­t kÃ½" description="Kho lÆ°u nháº­t kÃ½ tÃ¬nh yÃªu." active="entries">
  <main class="mx-auto max-w-6xl px-5 pb-24 pt-10">
    <section class="paper edge-torn p-6 sm:p-10" data-reveal>
      <div class="kicker text-xs text-black/50">LÆ¯U TRá»®</div>
      <RansomTitle text="Nháº­t kÃ½" as="h1" class="text-[44px] sm:text-[56px]" />
      <p class="mt-3 text-black/60">Báº¥m vÃ o bá»‹ Ã¡m Ä‘áº¥y hÃ­ hÃ­ :p</p>

      <div class="journal-tools" data-reveal>
        <div class="journal-tools__panel">
          <div class="journal-tools__header">
            <span class="journal-tools__icon">ğŸ““</span>
            <span>Nháº­t kÃ½</span>
            <span class="journal-tools__hint">TÃ¬m áº£nh theo ngÃ y</span>
          </div>
          <div class="journal-tools__content">
            <div class="journal-tools__fields">
              <label class="journal-tools__field">
                <span>NgÃ y Ä‘Äƒng</span>
                <input class="input" type="date" data-search-date />
              </label>
              <button class="btn journal-tools__reset" type="button" data-search-reset>Äáº·t láº¡i</button>
            </div>
            <div class="journal-tools__stats">
              <div class="journal-tools__stats-title">NgÃ y Ä‘Ã£ Ä‘Äƒng</div>
              <ul class="journal-tools__stats-list">
                {dateStats.map((stat) => (
                  <li>
                    <a href={`#date-${stat.dateKey}`}>
                      <span>{stat.label}</span>
                      <span class="journal-tools__count">{stat.count} bÃ i</span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mt-10">
      <div class="pinterest-grid">
        {posts.map((post) => (
          <FeedCard
            href={`/entries/${post.slug}`}
            title={post.data.title}
            description={post.data.description}
            date={post.data.pubDate}
            image={post.data.cover}
            topic={post.data.topic}
            locked={post.data.topic === "trash-bin"}
            pinned={post.data.pinned}
          />
        ))}
      </div>
    </section>

    <section class="mt-10">
      <div class="pinterest-grid" data-search-grid>
        {posts.map((post) => {
          const dateKey = post.data.pubDate.toISOString().slice(0, 10);
          const anchorId = seenDates.has(dateKey) ? undefined : `date-${dateKey}`;
          seenDates.add(dateKey);
          return (
            <FeedCard
              href={`/entries/${post.slug}`}
              title={post.data.title}
              description={post.data.description}
              date={post.data.pubDate}
              image={post.data.cover}
              topic={post.data.topic}
              locked={post.data.topic === "trash-bin"}
              pinned={post.data.pinned}
              dateKey={dateKey}
              anchorId={anchorId}
              searchText={`${post.data.title} ${post.data.description ?? ""} ${post.data.author ?? ""} ${post.data.location ?? ""} ${post.data.eventTime ?? ""} ${post.data.writtenAt ?? ""} ${post.data.photoTime ?? ""} ${post.data.sideNote ?? ""} ${(post.data.tags ?? []).join(" ")} ${post.data.topic ?? ""}`}
            />
          );
        })}
      </div>
    </section>
  </main>

  <script is:inline>
    const initSearch = () => {
      const dateInputs = Array.from(document.querySelectorAll("[data-search-date]"));
      const resets = Array.from(document.querySelectorAll("[data-search-reset]"));
      const cards = Array.from(document.querySelectorAll("[data-search-grid] .feed-card"));

      if (!dateInputs.length || !resets.length || !cards.length) return;
      if (dateInputs.some((input) => input.dataset.bound === "1")) return;
      dateInputs.forEach((input) => {
        input.dataset.bound = "1";
      });

      const syncDates = (value) => {
        dateInputs.forEach((input) => {
          if (input.value !== value) input.value = value;
        });
      };

      const filter = () => {
        const date = dateInputs[0]?.value ?? "";
        cards.forEach((card) => {
          const cardDate = card.getAttribute("data-date") || "";
          const matchesDate = date ? cardDate === date : true;
          card.classList.toggle("is-filtered", !matchesDate);
        });
      };

      dateInputs.forEach((input) => {
        input.addEventListener("change", () => {
          syncDates(input.value);
          filter();
        });
      });

      resets.forEach((reset) => {
        reset.addEventListener("click", () => {
          syncDates("");
          filter();
        });
      });
    };

    initSearch();
    document.addEventListener("astro:page-load", initSearch);
  </script>
</BaseLayout>
