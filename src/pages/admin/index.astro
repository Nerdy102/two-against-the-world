---
import BaseLayout from "../../layouts/BaseLayout.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import { TOPICS } from "../../config/topics";

export const prerender = false;
---

<BaseLayout title="Admin — Two Against The World" description="Admin dashboard">
  <main class="mx-auto max-w-6xl px-5 pb-24 pt-10">
    <section class="paper edge-torn p-6 sm:p-10" data-reveal>
      <div class="kicker text-xs text-black/50">ADMIN</div>
      <RansomTitle text="Publish là lên ngay" as="h1" class="text-[44px] sm:text-[56px]" />
      <p class="mt-3 text-black/60">
        Quản lý bài viết từ điện thoại: tạo draft, lưu và publish ngay lập tức.
      </p>
    </section>

    <section class="mt-10 grid gap-8 lg:grid-cols-[1fr_2fr]">
      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Danh sách bài</h2>
          <button class="btn" type="button" data-new-post>Tạo bài mới</button>
        </div>
        <div class="mt-4 space-y-3" data-post-list></div>
      </div>

      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <div class="flex flex-wrap items-center gap-3">
          <h2 class="text-lg font-semibold">Soạn bài</h2>
          <span class="text-xs text-black/50" data-post-status>Chưa chọn bài</span>
        </div>
        <div class="mt-4 space-y-3" data-admin-auth>
          <div data-auth-locked>
            <p class="text-xs text-black/60">
              Đăng nhập để mở khóa soạn bài & upload. Trạng thái:
              <span data-admin-status>Đang khóa</span>
            </p>
            <div class="flex flex-wrap items-center gap-3">
              <input class="input" type="text" name="admin_username" placeholder="Username" data-admin-username />
              <input
                class="input"
                type="password"
                name="admin_password"
                placeholder="Password"
                data-admin-password
              />
              <button class="btn" type="button" data-admin-login>Đăng nhập</button>
            </div>
          </div>
          <div class="hidden" data-auth-unlocked>
            <p class="text-xs text-black/60">
              Đã đăng nhập. <span data-admin-status>Đã mở khóa</span>
            </p>
            <button class="btn" type="button" data-admin-logout>Đăng xuất</button>
          </div>
        </div>

        <form class="mt-4 space-y-4" data-post-form>
          <p class="text-xs text-black/60">Trường có <span class="text-red-500">*</span> là bắt buộc.</p>
          <input type="hidden" name="id" />

          <label class="compose-field">
            <span>Tiêu đề <span class="text-red-500">*</span></span>
            <input class="input" name="title" placeholder="Tiêu đề bài viết" required />
          </label>

          <label class="compose-field">
            <span>Đường dẫn bài viết <span class="text-red-500">*</span></span>
            <input class="input" name="slug" placeholder="vi-du-duong-dan-bai-viet" required />
            <p class="mt-2 text-xs text-black/50">
              Gợi ý: Tự tạo từ tiêu đề (tiếng Việt), sẽ bỏ dấu và thay khoảng trắng bằng dấu gạch ngang.
            </p>
          </label>

          <label class="compose-field">
            <span>Tóm tắt</span>
            <input class="input" name="summary" placeholder="Một câu giới thiệu ngắn" />
          </label>

          <div class="compose-field">
            <span>Ảnh cover (upload)</span>
            <input type="hidden" name="cover_key" />
            <input type="hidden" name="cover_url" />
            <input
              class="input"
              type="file"
              name="cover_upload"
              accept="image/*,image/heic,image/heif"
              capture="environment"
            />
            <p class="mt-2 text-xs text-black/50">
              Chọn ảnh từ iPhone (HEIC/HEIF sẽ được tự tối ưu sang JPG). Ảnh cover sẽ tự chèn vào bài.
            </p>
            <button class="btn mt-3" type="button" data-upload-cover>Upload ảnh cover</button>
            <p class="text-xs text-black/50" data-cover-note></p>
          </div>

          <label class="compose-field">
            <span>Chủ đề</span>
            <select class="input" name="topic">
              <option value="">Chưa phân loại</option>
              {TOPICS.map((t) => (
                <option value={t.slug}>{t.label}</option>
              ))}
            </select>
          </label>

          <label class="compose-field">
            <span>Tác giả</span>
            <input class="input" name="author" placeholder="you | partner" />
          </label>

          <label class="compose-field">
            <span>Địa điểm</span>
            <input class="input" name="location" placeholder="Địa điểm" />
          </label>

          <label class="compose-field">
            <span>Thời gian sự kiện</span>
            <input class="input" name="event_time" placeholder="20:30 - 21:00" />
          </label>

          <label class="compose-field">
            <span>Viết lúc</span>
            <input class="input" name="written_at" placeholder="21/02/2026" />
          </label>

          <label class="compose-field">
            <span>Chụp lúc</span>
            <input class="input" name="photo_time" placeholder="21/02/2026" />
          </label>

          <label class="compose-field">
            <span>Tags (phân tách bằng dấu phẩy)</span>
            <input class="input" name="tags_csv" placeholder="memory, love" />
          </label>

          <label class="compose-field">
            <span>Ngày publish</span>
            <input class="input" name="published_at" placeholder="2026-02-02T10:00:00Z" />
          </label>

          <label class="compose-field">
            <span>Ghi chú thêm</span>
            <input class="input" name="side_note" placeholder="Một câu thêm" />
          </label>

          <label class="compose-field">
            <span>Voice memo (URL)</span>
            <input class="input" name="voice_memo" placeholder="https://..." />
          </label>

          <label class="compose-field">
            <span>Tiêu đề voice memo</span>
            <input class="input" name="voice_memo_title" placeholder="Tên đoạn ghi âm" />
          </label>

          <label class="compose-field">
            <span>Thư mục ảnh (nếu có)</span>
            <input class="input" name="photo_dir" placeholder="ten-thu-muc" />
          </label>

          <label class="compose-field">
            <span>Số ảnh</span>
            <input class="input" type="number" min="0" name="photo_count" placeholder="0" />
          </label>

          <label class="compose-field">
            <span>Ghim bài</span>
            <select class="input" name="pinned">
              <option value="0">Không</option>
              <option value="1">Có</option>
            </select>
          </label>

          <label class="compose-field">
            <span>Layout</span>
            <select class="input" name="layout">
              <option value="normal">Normal</option>
              <option value="long">Long</option>
            </select>
          </label>

          <label class="compose-field">
            <span>Thứ tự hiển thị</span>
            <input class="input" name="sort_order" type="number" min="-9999" max="9999" placeholder="0" />
          </label>

          <label class="compose-field">
            <span>Trạng thái</span>
            <select class="input" name="status">
              <option value="draft">Draft</option>
              <option value="published">Published</option>
            </select>
          </label>

          <label class="compose-field">
            <span>Nội dung (Markdown) <span class="text-red-500">*</span></span>
            <textarea
              class="input compose-textarea"
              name="content_md"
              rows={12}
              placeholder="Viết nội dung..."
              required
            ></textarea>
          </label>
          <div class="compose-field">
            <button class="btn" type="button" data-preview-toggle>Xem preview</button>
            <div class="mt-3 hidden prose prose-scrap max-w-none" data-preview></div>
          </div>

          <div class="compose-field">
            <span>Upload ảnh iPhone (tối ưu)</span>
            <input
              class="input"
              type="file"
              name="upload_photos"
              accept="image/*,image/heic,image/heif"
              multiple
            />
            <p class="mt-2 text-xs text-black/50">
              Tối ưu kích thước và nén nhẹ để đăng nhanh. Nếu ảnh HEIC lỗi, hãy chọn “Most Compatible” trong
              Camera → Formats.
            </p>
            <button class="btn mt-3" type="button" data-upload-photos>Upload ảnh</button>
            <p class="text-xs text-black/50" data-upload-note></p>
          </div>

          <div class="flex flex-wrap gap-3">
            <button class="btn" type="submit" data-save-post>Lưu</button>
            <button class="btn" type="button" data-submit-post>Đăng bài ngay</button>
            <button class="btn" type="button" data-publish-post>Publish</button>
            <button class="btn" type="button" data-unpublish-post>Gỡ publish</button>
            <button class="btn" type="button" data-delete-post>Xóa</button>
          </div>
          <p class="text-xs text-black/50" data-form-note></p>
        </form>
      </div>
    </section>

    <section class="mt-10 grid gap-8 lg:grid-cols-[1fr_2fr]">
      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Bình luận</h2>
          <select class="input text-sm" data-comment-filter>
            <option value="pending">Chờ duyệt</option>
            <option value="approved">Đã duyệt</option>
            <option value="hidden">Ẩn</option>
            <option value="">Tất cả</option>
          </select>
        </div>
        <div class="mt-4 space-y-3" data-comment-list></div>
      </div>
      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <h2 class="text-lg font-semibold">Moderation</h2>
        <p class="mt-2 text-xs text-black/60">
          Chọn trạng thái để duyệt/ẩn comment. Comment có link hoặc dài sẽ vào pending tự động.
        </p>
        <p class="mt-4 text-xs text-black/50" data-comment-note></p>
      </div>
    </section>
  </main>

  <script>
    import heic2any from "heic2any";
    import { marked } from "marked";

    const slugify = (s = "") =>
      s
        .toLowerCase()
        .replace(/đ/g, "d")
        .normalize("NFKD")
        .replace(/[^\w\s-]/g, "")
        .trim()
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-");

    const form = document.querySelector("[data-post-form]");
    const list = document.querySelector("[data-post-list]");
    const status = document.querySelector("[data-post-status]");
    const note = document.querySelector("[data-form-note]");
    const newBtn = document.querySelector("[data-new-post]");
    const publishBtn = document.querySelector("[data-publish-post]");
    const unpublishBtn = document.querySelector("[data-unpublish-post]");
    const submitBtn = document.querySelector("[data-submit-post]");
    const deleteBtn = document.querySelector("[data-delete-post]");
    const coverBtn = document.querySelector("[data-upload-cover]");
    const coverNote = document.querySelector("[data-cover-note]");
    const uploadBtn = document.querySelector("[data-upload-photos]");
    const uploadNote = document.querySelector("[data-upload-note]");
    const authWrap = document.querySelector("[data-admin-auth]");
    const lockStatus = document.querySelector("[data-admin-status]");
    const usernameInput = document.querySelector("[data-admin-username]");
    const passwordInput = document.querySelector("[data-admin-password]");
    const loginBtn = document.querySelector("[data-admin-login]");
    const logoutBtn = document.querySelector("[data-admin-logout]");
    const authLocked = document.querySelector("[data-auth-locked]");
    const authUnlocked = document.querySelector("[data-auth-unlocked]");
    const previewToggle = document.querySelector("[data-preview-toggle]");
    const previewEl = document.querySelector("[data-preview]");
    const commentList = document.querySelector("[data-comment-list]");
    const commentFilter = document.querySelector("[data-comment-filter]");
    const commentNote = document.querySelector("[data-comment-note]");
    let unlocked = false;

    const state = {
      posts: [],
      active: null,
      dirty: false,
    };

    const markDirty = () => {
      state.dirty = true;
    };

    const setLocked = (locked) => {
      if (lockStatus) {
        lockStatus.textContent = locked ? "Đang khóa" : "Đã mở khóa";
      }
      authWrap?.classList.toggle("opacity-60", locked);
      authLocked?.classList.toggle("hidden", !locked);
      authUnlocked?.classList.toggle("hidden", locked);
      const controls = [
        newBtn,
        publishBtn,
        unpublishBtn,
        submitBtn,
        deleteBtn,
        coverBtn,
        uploadBtn,
        ...(form ? Array.from(form.querySelectorAll("input, textarea, select, button")) : []),
      ].filter(Boolean);
      controls.forEach((el) => {
        if (
          el?.hasAttribute("data-admin-login") ||
          el?.hasAttribute("data-admin-logout") ||
          el?.hasAttribute("data-admin-password") ||
          el?.hasAttribute("data-admin-username")
        )
          return;
        el.disabled = locked;
      });
    };

    const isUnlocked = () => unlocked;

    const getCsrfToken = () => {
      const match = document.cookie.match(/(?:^|; )twaw_admin_csrf=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : "";
    };

    const login = async () => {
      if (!usernameInput?.value || !passwordInput?.value) {
        lockStatus.textContent = "Nhập username + password";
        return;
      }
      const res = await fetch("/api/admin/login", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ username: usernameInput.value, password: passwordInput.value }),
      });
      if (!res.ok) {
        lockStatus.textContent = "Sai thông tin đăng nhập";
        return;
      }
      await res.json().catch(() => ({}));
      unlocked = true;
      passwordInput.value = "";
      setLocked(false);
      await loadPosts();
      await loadComments();
    };

    const checkSession = async () => {
      const res = await fetch("/api/admin/session");
      if (!res.ok) {
        unlocked = false;
        setLocked(true);
        return;
      }
      const data = await res.json().catch(() => ({}));
      unlocked = Boolean(data?.authenticated);
      setLocked(!unlocked);
      if (unlocked) {
        await loadPosts();
        await loadComments();
      }
    };

    loginBtn?.addEventListener("click", login);
    passwordInput?.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        login();
      }
    });
    logoutBtn?.addEventListener("click", async () => {
      await fetch("/api/admin/logout", { method: "POST" });
      unlocked = false;
      setLocked(true);
    });

    const fields = [
      "id",
      "title",
      "slug",
      "summary",
      "cover_key",
      "cover_url",
      "topic",
      "author",
      "location",
      "event_time",
      "written_at",
      "photo_time",
      "tags_csv",
      "published_at",
      "side_note",
      "voice_memo",
      "voice_memo_title",
      "photo_dir",
      "photo_count",
      "pinned",
      "layout",
      "sort_order",
      "status",
      "content_md",
    ];

    const fillForm = (post = {}) => {
      fields.forEach((name) => {
        const input = form.querySelector(`[name="${name}"]`);
        if (!input) return;
        input.value = post[name] ?? (input.type === "number" ? 0 : "");
      });
      state.dirty = false;
      status.textContent = post.status
        ? `Trạng thái: ${post.status}`
        : "Chưa chọn bài";
    };

    const renderList = () => {
      if (!list) return;
      if (!state.posts.length) {
        list.innerHTML = "<p class='text-sm text-black/50'>Chưa có bài nào.</p>";
        return;
      }
      list.innerHTML = state.posts
        .map(
          (post) => `
            <button type="button" class="w-full text-left border border-black/10 rounded-2xl p-4 hover:border-black/30" data-post-id="${post.id}">
              <div class="text-xs text-black/50">${post.status}</div>
              <div class="font-semibold">${post.title}</div>
              <div class="text-xs text-black/50">${post.slug}</div>
            </button>
          `
        )
        .join("");
      list.querySelectorAll("[data-post-id]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.postId;
          state.active = state.posts.find((p) => p.id === id);
          fillForm(state.active);
        });
      });
    };

    const loadPosts = async () => {
      if (!isUnlocked()) return;
      const res = await fetch("/api/admin/posts");
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
        }
        return;
      }
      const data = await res.json();
      state.posts = data.posts || [];
      renderList();
    };

    const loadComments = async () => {
      if (!commentList || !isUnlocked()) return;
      const filter = commentFilter?.value ?? "pending";
      const res = await fetch(`/api/admin/comments?status=${encodeURIComponent(filter)}`);
      if (!res.ok) return;
      const data = await res.json();
      const items = data.comments || [];
      const escapeHtml = (value = "") =>
        String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      if (!items.length) {
        commentList.innerHTML = "<p class='text-sm text-black/50'>Chưa có comment.</p>";
        return;
      }
      commentList.innerHTML = items
        .map(
          (item) => `
            <div class="comment-card">
              <div class="comment-meta">
                <span class="comment-name">${escapeHtml(item.display_name || "Ẩn danh")}</span>
                <span class="comment-time">${new Date(item.created_at).toLocaleString("vi-VN")}</span>
                <span class="comment-nick">${escapeHtml(item.post_slug)}</span>
              </div>
              <p class="comment-body">${escapeHtml(item.body)}</p>
              <div class="mt-3 flex flex-wrap gap-2">
                <button class="btn text-xs" data-comment-action="approved" data-comment-id="${item.id}">Duyệt</button>
                <button class="btn text-xs" data-comment-action="hidden" data-comment-id="${item.id}">Ẩn</button>
                <button class="btn text-xs" data-comment-action="delete" data-comment-id="${item.id}">Xóa</button>
              </div>
            </div>
          `
        )
        .join("");
      commentList.querySelectorAll("[data-comment-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.commentId;
          const action = btn.dataset.commentAction;
          if (!id || !action) return;
          commentNote.textContent = "Đang xử lý comment...";
          const csrf = getCsrfToken();
          const res =
            action === "delete"
              ? await fetch(`/api/admin/comments/${id}`, {
                  method: "DELETE",
                  headers: { "x-csrf-token": csrf },
                })
              : await fetch(`/api/admin/comments/${id}`, {
                  method: "PUT",
                  headers: { "content-type": "application/json", "x-csrf-token": csrf },
                  body: JSON.stringify({ status: action }),
                });
          if (!res.ok) {
            commentNote.textContent = "Lỗi xử lý comment.";
            return;
          }
          commentNote.textContent = "Đã cập nhật comment.";
          await loadComments();
        });
      });
    };

    newBtn?.addEventListener("click", () => {
      state.active = null;
      fillForm({});
    });

    form?.querySelector("[name='title']")?.addEventListener("input", (e) => {
      const slugInput = form.querySelector("[name='slug']");
      if (!slugInput || slugInput.value.trim()) return;
      slugInput.value = slugify(e.target.value);
    });

    form?.querySelectorAll("input, textarea, select").forEach((input) => {
      input.addEventListener("input", () => {
        state.dirty = true;
      });
    });

    const requiredFields = ["title", "slug", "content_md"];

    const savePost = async ({ silent = false } = {}) => {
      if (!form) return false;
      if (!isUnlocked()) {
        note.textContent = "Cần mở khóa để lưu bài.";
        return false;
      }
      if (!silent) note.textContent = "Đang lưu...";
      const data = {};
      fields.forEach((name) => {
        const input = form.querySelector(`[name="${name}"]`);
        if (!input) return;
        if (name === "pinned") {
          data[name] = Number(input.value || 0);
          return;
        }
        data[name] = input.type === "number" ? Number(input.value || 0) : input.value;
      });
      if (data.tags_csv) {
        data.tags_json = JSON.stringify(
          String(data.tags_csv)
            .split(",")
            .map((t) => t.trim())
            .filter(Boolean)
        );
      }

      const missingField = requiredFields.find((name) => {
        const value = typeof data[name] === "string" ? data[name].trim() : "";
        return !value;
      });
      if (missingField) {
        const label = {
          title: "Tiêu đề",
          slug: "Đường dẫn",
          content_md: "Nội dung",
        }[missingField];
        note.textContent = `Thiếu ${label}.`;
        const input = form.querySelector(`[name="${missingField}"]`);
        input?.focus();
        return false;
      }

      const isNew = !data.id;
      const res = await fetch(isNew ? "/api/admin/posts" : `/api/admin/posts/${data.id}`, {
        method: isNew ? "POST" : "PUT",
        headers: { "content-type": "application/json", "x-csrf-token": getCsrfToken() },
        body: JSON.stringify(data),
      });
      const payload = await res.json().catch(() => ({}));
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để lưu bài.";
          return false;
        }
        if (!silent) {
          note.textContent = payload?.error
            ? `Lưu lỗi: ${payload.error}`
            : "Lưu chưa được, thử lại nhé.";
        }
        return false;
      }
      if (isNew) {
        data.id = payload.id;
      }
      if (!silent) note.textContent = "Đã lưu.";
      await loadPosts();
      state.active = state.posts.find((p) => p.id === data.id);
      fillForm(state.active);
      return true;
    };

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      await savePost();
    });

    setInterval(async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id || !state.dirty || !isUnlocked()) return;
      const saved = await savePost({ silent: true });
      if (saved) state.dirty = false;
    }, 3000);

    publishBtn?.addEventListener("click", async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      const res = await fetch(`/api/admin/posts/${id}/publish`, {
        method: "POST",
        headers: { "x-csrf-token": getCsrfToken() },
      });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để publish.";
          return;
        }
        note.textContent = "Publish lỗi, thử lại nhé.";
        return;
      }
      await loadPosts();
      state.active = state.posts.find((p) => p.id === id);
      fillForm(state.active);
    });

    unpublishBtn?.addEventListener("click", async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      const res = await fetch(`/api/admin/posts/${id}/unpublish`, {
        method: "POST",
        headers: { "x-csrf-token": getCsrfToken() },
      });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để gỡ publish.";
          return;
        }
        note.textContent = "Gỡ publish lỗi, thử lại nhé.";
        return;
      }
      await loadPosts();
      state.active = state.posts.find((p) => p.id === id);
      fillForm(state.active);
    });

    submitBtn?.addEventListener("click", async () => {
      const saved = await savePost();
      if (!saved) return;
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      const res = await fetch(`/api/admin/posts/${id}/publish`, {
        method: "POST",
        headers: { "x-csrf-token": getCsrfToken() },
      });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để publish.";
          return;
        }
        note.textContent = "Publish lỗi, thử lại nhé.";
        return;
      }
      await loadPosts();
      state.active = state.posts.find((p) => p.id === id);
      fillForm(state.active);
      note.textContent = "Đã đăng bài.";
    });

    deleteBtn?.addEventListener("click", async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      if (!confirm("Xóa bài này?")) return;
      const res = await fetch(`/api/admin/posts/${id}`, {
        method: "DELETE",
        headers: { "x-csrf-token": getCsrfToken() },
      });
      if (!res.ok) {
        note.textContent = "Xóa lỗi, thử lại nhé.";
        return;
      }
      note.textContent = "Đã xóa.";
      await loadPosts();
      fillForm({});
    });

    previewToggle?.addEventListener("click", () => {
      if (!previewEl) return;
      previewEl.classList.toggle("hidden");
      const content = form?.querySelector("[name='content_md']")?.value ?? "";
      previewEl.innerHTML = marked.parse(content);
    });

    form?.querySelector("[name='content_md']")?.addEventListener("input", () => {
      if (!previewEl || previewEl.classList.contains("hidden")) return;
      previewEl.innerHTML = marked.parse(form.querySelector("[name='content_md']").value || "");
    });

    commentFilter?.addEventListener("change", loadComments);

    checkSession();

    const isHeic = (file) => {
      const name = file?.name?.toLowerCase() || "";
      return file?.type === "image/heic" || file?.type === "image/heif" || name.endsWith(".heic");
    };

    const toJpegBlob = async (file, quality = 0.82) => {
      if (!isHeic(file)) return file;
      const blob = await heic2any({ blob: file, toType: "image/jpeg", quality });
      return blob instanceof Blob ? blob : new Blob([blob], { type: "image/jpeg" });
    };

    const resizeImage = async (file, maxSize = 2048, quality = 0.82) => {
      const source = await toJpegBlob(file, quality);
      const bitmap = await createImageBitmap(source, { imageOrientation: "from-image" });
      const ratio = Math.min(1, maxSize / Math.max(bitmap.width, bitmap.height));
      const targetWidth = Math.round(bitmap.width * ratio);
      const targetHeight = Math.round(bitmap.height * ratio);
      const canvas = document.createElement("canvas");
      canvas.width = targetWidth;
      canvas.height = targetHeight;
      const ctx = canvas.getContext("2d");
      if (!ctx) throw new Error("NO_CONTEXT");
      ctx.drawImage(bitmap, 0, 0, targetWidth, targetHeight);
      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", quality));
      if (!blob) throw new Error("NO_BLOB");
      return { blob, width: targetWidth, height: targetHeight };
    };

    const uploadImage = async ({ file, slug, filename }) => {
      const { blob, width, height } = await resizeImage(file);
      const formData = new FormData();
      formData.append("file", blob, filename);
      formData.append("slug", slug);
      formData.append(
        "meta",
        JSON.stringify({
          width,
          height,
          size: blob.size,
          originalName: file.name,
          fileName: filename,
        })
      );
      const res = await fetch("/api/admin/upload", {
        method: "POST",
        headers: { "x-csrf-token": getCsrfToken() },
        body: formData,
      });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          throw new Error("UNAUTHORIZED");
        }
        throw new Error("UPLOAD_FAILED");
      }
      return res.json();
    };

    coverBtn?.addEventListener("click", async () => {
      if (!isUnlocked()) {
        coverNote.textContent = "Cần mở khóa để upload.";
        return;
      }
      const input = form?.querySelector("input[name='cover_upload']");
      const file = input?.files?.[0];
      if (!file) return;
      coverNote.textContent = "Đang xử lý ảnh cover...";
      const slugValue = form?.querySelector("[name='slug']")?.value;
      if (!slugValue) {
        coverNote.textContent = "Hãy nhập đường dẫn trước khi upload cover.";
        return;
      }
      const slug = slugValue || "untitled";
      const safeSlug = slugify(slug);
      const filenameBase = file.name.replace(/\.[^.]+$/, "");
      const filename = `${filenameBase || "cover"}-${Date.now()}.jpg`;
      try {
        const payload = await uploadImage({ file, slug: safeSlug, filename });
        const coverInput = form?.querySelector("[name='cover_url']");
        const coverKeyInput = form?.querySelector("[name='cover_key']");
        if (payload.url && coverInput) {
          coverInput.value = payload.url;
          coverInput.dispatchEvent(new Event("input", { bubbles: true }));
        }
        if (payload.key && coverKeyInput) {
          coverKeyInput.value = payload.key;
          coverKeyInput.dispatchEvent(new Event("input", { bubbles: true }));
        }
        const contentField = form?.querySelector("[name='content_md']");
        if (payload.url && contentField && !contentField.value.includes(payload.url)) {
          contentField.value = `![cover](${payload.url})\n\n${contentField.value}`.trim();
          contentField.dispatchEvent(new Event("input", { bubbles: true }));
        }
        coverNote.textContent = "Đã upload ảnh cover.";
        input.value = "";
        markDirty();
      } catch (error) {
        coverNote.textContent = "Upload ảnh cover lỗi. Thử lại hoặc đổi định dạng ảnh.";
      }
    });

    uploadBtn?.addEventListener("click", async () => {
      if (!isUnlocked()) {
        uploadNote.textContent = "Cần mở khóa để upload.";
        return;
      }
      const input = form?.querySelector("input[name='upload_photos']");
      if (!input?.files?.length) return;
      uploadNote.textContent = "Đang xử lý ảnh...";
      const slugValue = form?.querySelector("[name='slug']")?.value;
      if (!slugValue) {
        uploadNote.textContent = "Hãy nhập đường dẫn trước khi upload ảnh.";
        return;
      }
      const slug = slugValue || "untitled";
      const safeSlug = slugify(slug);
      const date = new Date().toISOString().slice(0, 10);
      let successCount = 0;
      for (const [index, file] of Array.from(input.files).entries()) {
        try {
          const paddedIndex = String(index + 1).padStart(3, "0");
          const filename = `${date}_${safeSlug}_${paddedIndex}.jpg`;
          const payload = await uploadImage({ file, slug: safeSlug, filename });
          const contentField = form?.querySelector("[name='content_md']");
          if (payload.url && contentField) {
            contentField.value += `\n\n![${filename}](${payload.url})`;
            contentField.dispatchEvent(new Event("input", { bubbles: true }));
            markDirty();
          }
          successCount += 1;
        } catch (error) {
          uploadNote.textContent = "Có ảnh upload lỗi. Thử lại hoặc đổi định dạng ảnh.";
        }
      }
      uploadNote.textContent = `Đã upload ${successCount} ảnh.`;
      input.value = "";
    });

    setLocked(true);
  </script>
</BaseLayout>
