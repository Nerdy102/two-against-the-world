---
import BaseLayout from "../../layouts/BaseLayout.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import { TOPICS } from "../../config/topics";
import { COMMENT_STATUSES } from "../../lib/constants";

export const prerender = false;

const enablePinnedFields = import.meta.env.PUBLIC_ENABLE_PINNED_FIELDS !== "false";
const enableUploadHelpers = import.meta.env.PUBLIC_ENABLE_UPLOAD_HELPERS !== "false";
const commentStatusLabels: Record<(typeof COMMENT_STATUSES)[number], string> = {
  pending: "Chờ duyệt",
  visible: "Đã duyệt",
  hidden: "Ẩn",
};
---

<BaseLayout title="Admin — Two Against The World" description="Admin dashboard">
  <main class="mx-auto max-w-7xl px-5 pb-24 pt-10">
    <section class="paper edge-torn p-6 sm:p-10" data-reveal>
      <div class="kicker text-xs text-black/50">ADMIN</div>
      <RansomTitle text="Publish là lên ngay" as="h1" class="text-[44px] sm:text-[56px]" />
      <p class="mt-3 text-black/60">
        Quản lý bài viết từ điện thoại: tạo draft, lưu và publish ngay lập tức.
      </p>
    </section>

    <section class="mt-10 grid gap-8 lg:grid-cols-[1fr_2fr]">
      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Danh sách bài</h2>
          <button class="btn" type="button" data-new-post>Tạo bài mới</button>
        </div>
        <div class="mt-4 space-y-3" data-post-list></div>
      </div>

      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <div class="flex flex-wrap items-center gap-3">
          <h2 class="text-lg font-semibold">Soạn bài</h2>
          <span class="text-xs text-black/50" data-post-status>Chưa chọn bài</span>
        </div>
        <div class="mt-4 space-y-3" data-admin-auth>
          <div data-auth-locked>
            <p class="text-xs text-black/60">
              Đăng nhập để mở khóa soạn bài & upload. Trạng thái:
              <span data-admin-status>Đang khóa</span>
            </p>
            <div class="flex flex-wrap items-center gap-3">
              <input
                class="input"
                type="password"
                name="admin_password"
                placeholder="Admin password"
                data-admin-password
              />
              <button class="btn" type="button" data-admin-login>Mở khóa</button>
            </div>
          </div>
          <div class="hidden" data-auth-unlocked>
            <p class="text-xs text-black/60">
              Đã đăng nhập. <span data-admin-status>Đã mở khóa</span>
            </p>
            <button class="btn" type="button" data-admin-logout>Đăng xuất</button>
          </div>
        </div>
        <div class="admin-toast" data-admin-toast role="status" aria-live="polite" aria-atomic="true"></div>

        <form class="mt-4 space-y-4" data-post-form>
          <p class="text-xs text-black/60">
            Trường có <span class="text-red-500">*</span> là bắt buộc. Bắt buộc tối thiểu: Tiêu đề, Chủ đề,
            Tác giả, Ảnh, Nội dung.
          </p>
          <input type="hidden" name="id" />

          <label class="compose-field">
            <span>Tiêu đề <span class="text-red-500">*</span></span>
            <input class="input" name="title" placeholder="Tiêu đề bài viết" required />
          </label>

          <div class="compose-field hidden" data-link-preview>
            <span>Link bài viết</span>
            <div class="flex flex-wrap items-center gap-2">
              <input class="input flex-1 min-w-[220px]" type="text" readonly data-link-text />
              <button class="btn" type="button" data-link-open>Mở</button>
              <button class="btn" type="button" data-link-copy>Sao chép</button>
            </div>
            <p class="mt-2 text-xs text-black/50">
              Link sẽ hiện sau khi lưu hoặc publish.
            </p>
          </div>

          <label class="compose-field">
            <span>Chủ đề <span class="text-red-500">*</span></span>
            <select class="input" name="topic" required>
              <option value="">Chưa phân loại</option>
              {TOPICS.map((t) => (
                <option value={t.slug}>{t.label}</option>
              ))}
            </select>
          </label>

          <label class="compose-field">
            <span>Tác giả <span class="text-red-500">*</span></span>
            <input
              class="input"
              name="author"
              placeholder="nhà triết học trên giường | nhà triết học ở hộp đêm"
              required
            />
          </label>

          <div class="compose-field">
            <span>Ảnh <span class="text-red-500">*</span></span>
            <input type="hidden" name="cover_key" />
            <input type="hidden" name="cover_url" />
            <input
              class="input"
              type="file"
              name="upload_photos"
              accept="image/*,image/heic,image/heif"
              multiple
              data-upload-input
            />
            <p class="mt-2 text-xs text-black/50">Ảnh đầu tiên là ảnh bìa (cover).</p>
            <div class="compose-preview" data-upload-preview></div>
            {enableUploadHelpers && <button class="btn hidden mt-3" type="button" data-upload-cancel>Hủy</button>}
            {enableUploadHelpers && <p class="text-xs text-black/50" data-upload-progress></p>}
            <p class="text-xs text-black/50" data-upload-note></p>
          </div>

          <label class="compose-field">
            <span>Nội dung (Markdown) <span class="text-red-500">*</span></span>
            <textarea
              class="input compose-textarea"
              name="content_md"
              rows={12}
              placeholder="Viết nội dung..."
              required
            ></textarea>
          </label>
          <div class="compose-field">
            <button class="btn" type="button" data-preview-toggle>Xem preview</button>
            <div class="mt-3 hidden prose prose-scrap max-w-none" data-preview></div>
          </div>

          <details class="compose-advanced">
            <summary class="compose-advanced__summary">Nâng cao (tuỳ chọn)</summary>
            <div class="mt-4 grid gap-4">
              <label class="compose-field">
                <span>Đường dẫn bài viết</span>
                <input class="input" name="slug" placeholder="vi-du-duong-dan-bai-viet" />
                <p class="mt-2 text-xs text-black/50">
                  Tự tạo từ tiêu đề nếu bỏ trống. Sẽ bỏ dấu và thay khoảng trắng bằng dấu gạch ngang.
                </p>
              </label>

              <label class="compose-field">
                <span>Tóm tắt</span>
                <input class="input" name="summary" placeholder="Một câu giới thiệu ngắn" />
              </label>

              <label class="compose-field">
                <span>Địa điểm</span>
                <input class="input" name="location" placeholder="Địa điểm" />
              </label>

              <label class="compose-field">
                <span>Thời gian sự kiện</span>
                <input class="input" name="event_time" placeholder="20:30 - 21:00" />
              </label>

              <label class="compose-field">
                <span>Viết lúc</span>
                <input class="input" name="written_at" placeholder="21/02/2026" />
              </label>

              <label class="compose-field">
                <span>Chụp lúc</span>
                <input class="input" name="photo_time" placeholder="21/02/2026" />
              </label>

              <label class="compose-field">
                <span>Tags (phân tách bằng dấu phẩy)</span>
                <input class="input" name="tags_csv" placeholder="memory, love" />
              </label>

              <label class="compose-field">
                <span>Ghi chú thêm</span>
                <input class="input" name="side_note" placeholder="Một câu thêm" />
              </label>

              <label class="compose-field">
                <span>Voice memo (URL)</span>
                <input class="input" name="voice_memo" placeholder="https://..." />
              </label>

              <label class="compose-field">
                <span>Tiêu đề voice memo</span>
                <input class="input" name="voice_memo_title" placeholder="Tên đoạn ghi âm" />
              </label>

              {enablePinnedFields && (
                <>
                  <label class="compose-field">
                    <span>Ghim bài</span>
                    <select class="input" name="pinned">
                      <option value="0">Không</option>
                      <option value="1">Có</option>
                    </select>
                  </label>

                  <label class="compose-field">
                    <span>Độ ưu tiên ghim</span>
                    <input class="input" name="pinned_priority" type="number" min="0" max="999" placeholder="0" />
                  </label>

                  <label class="compose-field">
                    <span>Ghim đến (ISO)</span>
                    <input class="input" name="pinned_until" placeholder="2026-02-02T10:00:00Z" />
                  </label>

                  <label class="compose-field">
                    <span>Kiểu ghim</span>
                    <select class="input" name="pinned_style">
                      <option value="">Mặc định</option>
                      <option value="event">Event</option>
                      <option value="announcement">Announcement</option>
                      <option value="memory">Memory</option>
                    </select>
                  </label>
                </>
              )}

              <label class="compose-field">
                <span>Layout</span>
                <select class="input" name="layout">
                  <option value="normal">Normal</option>
                  <option value="long">Long</option>
                </select>
              </label>

              <label class="compose-field">
                <span>Thứ tự hiển thị</span>
                <input class="input" name="sort_order" type="number" min="-9999" max="9999" placeholder="0" />
              </label>

              <label class="compose-field">
                <span>Trạng thái</span>
                <select class="input" name="status">
                  <option value="draft">Draft</option>
                  <option value="published">Published</option>
                  <option value="archived">Archived</option>
                </select>
              </label>
            </div>
          </details>

          <div class="flex flex-wrap gap-3">
            <button class="btn" type="submit" data-save-post>Lưu</button>
            <button class="btn" type="button" data-submit-post>Đăng bài ngay</button>
            <button class="btn" type="button" data-publish-post>Publish</button>
            <button class="btn" type="button" data-unpublish-post>Gỡ publish</button>
            <button class="btn" type="button" data-delete-post>Xóa</button>
          </div>
          <p class="text-xs text-black/50" data-form-note></p>
        </form>
      </div>
    </section>

    <section class="mt-10 grid gap-8 lg:grid-cols-[1fr_2fr]">
      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Bình luận</h2>
          <select class="input text-sm" data-comment-filter>
            {COMMENT_STATUSES.map((status) => (
              <option value={status}>{commentStatusLabels[status]}</option>
            ))}
            <option value="">Tất cả</option>
          </select>
        </div>
        <div class="mt-4 space-y-3" data-comment-list></div>
      </div>
      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <h2 class="text-lg font-semibold">Moderation</h2>
        <p class="mt-2 text-xs text-black/60">
          Chọn trạng thái để hiển thị hoặc ẩn comment sau khi đã đăng.
        </p>
        <p class="mt-4 text-xs text-black/50" data-comment-note></p>
      </div>
    </section>
  </main>

  <script>
    // @ts-nocheck
    import { marked } from "marked";

    const slugify = (s = "") =>
      s
        .toLowerCase()
        .replace(/đ/g, "d")
        .normalize("NFKD")
        .replace(/[^\w\s-]/g, "")
        .trim()
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-");

    const form = document.querySelector("[data-post-form]");
    const list = document.querySelector("[data-post-list]");
    const status = document.querySelector("[data-post-status]");
    const note = document.querySelector("[data-form-note]");
    const newBtn = document.querySelector("[data-new-post]");
    const publishBtn = document.querySelector("[data-publish-post]");
    const unpublishBtn = document.querySelector("[data-unpublish-post]");
    const submitBtn = document.querySelector("[data-submit-post]");
    const deleteBtn = document.querySelector("[data-delete-post]");
    const uploadInput = document.querySelector("[data-upload-input]");
    const uploadPreview = document.querySelector("[data-upload-preview]");
    const uploadNote = document.querySelector("[data-upload-note]");
    const uploadProgress = document.querySelector("[data-upload-progress]");
    const uploadCancel = document.querySelector("[data-upload-cancel]");
    const authWrap = document.querySelector("[data-admin-auth]");
    const lockStatus = document.querySelector("[data-admin-status]");
    const passwordInput = document.querySelector("[data-admin-password]");
    const loginBtn = document.querySelector("[data-admin-login]");
    const logoutBtn = document.querySelector("[data-admin-logout]");
    const authLocked = document.querySelector("[data-auth-locked]");
    const authUnlocked = document.querySelector("[data-auth-unlocked]");
    const previewToggle = document.querySelector("[data-preview-toggle]");
    const previewEl = document.querySelector("[data-preview]");
    const adminToast = document.querySelector("[data-admin-toast]");
    const linkPreview = document.querySelector("[data-link-preview]");
    const linkText = document.querySelector("[data-link-text]");
    const linkOpen = document.querySelector("[data-link-open]");
    const linkCopy = document.querySelector("[data-link-copy]");
    const commentList = document.querySelector("[data-comment-list]");
    const commentFilter = document.querySelector("[data-comment-filter]");
    const commentNote = document.querySelector("[data-comment-note]");
    let unlocked = false;
    const enableDraftSave = import.meta.env.PUBLIC_ENABLE_ADMIN_DRAFT_SAVE !== "false";
    const enableUploadHelpers = import.meta.env.PUBLIC_ENABLE_UPLOAD_HELPERS !== "false";
    const MAX_UPLOAD_FILES = 6;
    const MAX_FILE_BYTES = 2.5 * 1024 * 1024;
    let uploadController = null;
    let selectedFiles = [];
    let previewUrls = [];
    let coverIndex = 0;
    let uploadBatchId = null;

    const state = {
      posts: [],
      active: null,
      dirty: false,
    };
    let renderPreview = () => {};
    let clearPreviewUrls = () => {};

    const markDirty = () => {
      state.dirty = true;
    };

    const setLocked = (locked) => {
      if (lockStatus) {
        lockStatus.textContent = locked ? "Đang khóa" : "Đã mở khóa";
      }
      authWrap?.classList.toggle("opacity-60", locked);
      authLocked?.classList.toggle("hidden", !locked);
      authUnlocked?.classList.toggle("hidden", locked);
      const controls = [
        newBtn,
        publishBtn,
        unpublishBtn,
        submitBtn,
        deleteBtn,
        ...(form ? Array.from(form.querySelectorAll("input, textarea, select, button")) : []),
      ].filter(Boolean);
      controls.forEach((el) => {
        if (
          el?.hasAttribute("data-admin-login") ||
          el?.hasAttribute("data-admin-logout") ||
          el?.hasAttribute("data-admin-password")
        )
          return;
        el.disabled = locked;
      });
    };

    const isUnlocked = () => unlocked;

    let toastTimeout = null;
    const formatApiError = (payload, fallback) => {
      const message = [payload?.error, payload?.detail].filter(Boolean).join(" — ");
      return message || fallback;
    };
    const showToast = (message, variant = "error") => {
      if (!adminToast) return;
      adminToast.textContent = message;
      adminToast.dataset.state = variant;
      adminToast.classList.add("is-visible");
      if (toastTimeout) window.clearTimeout(toastTimeout);
      toastTimeout = window.setTimeout(() => {
        adminToast.classList.remove("is-visible");
        adminToast.textContent = "";
        adminToast.dataset.state = "";
      }, 2200);
    };

    const getCsrfToken = () => {
      const match = document.cookie.match(/(?:^|; )twaw_admin_csrf=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : "";
    };

    const getSiteBase = () => import.meta.env.PUBLIC_SITE_URL || window.location.origin;

    const setLoginLoading = (isLoading) => {
      if (loginBtn) loginBtn.disabled = isLoading;
      if (passwordInput) passwordInput.disabled = isLoading;
    };

    const getSlugValue = () => {
      const slugInput = form?.querySelector("[name='slug']");
      const rawSlug = slugInput?.value?.trim();
      if (rawSlug) return slugify(rawSlug);
      const titleValue = form?.querySelector("[name='title']")?.value ?? "";
      return slugify(titleValue);
    };

    const updateLinkPreview = () => {
      if (!linkPreview || !linkText) return;
      const hasId = Boolean(form?.querySelector("[name='id']")?.value);
      if (!hasId) {
        linkPreview.classList.add("hidden");
        linkText.value = "";
        if (linkOpen) linkOpen.disabled = true;
        return;
      }
      const slugValue = getSlugValue();
      if (!slugValue) {
        linkPreview.classList.add("hidden");
        linkText.value = "";
        if (linkOpen) linkOpen.disabled = true;
        return;
      }
      const base = getSiteBase();
      linkText.value = base.replace(/\/$/, "") + "/entries/" + slugValue;
      linkPreview.classList.remove("hidden");
      if (linkOpen) linkOpen.disabled = false;
    };

    const login = async () => {
      if (!passwordInput?.value) {
        lockStatus.textContent = "Nhập password";
        showToast("Nhập password để mở khóa.");
        return;
      }
      setLoginLoading(true);
      try {
        const res = await fetch("/api/admin/unlock", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ password: passwordInput.value }),
        });
        const payload = await res.json().catch(() => ({}));
        if (!res.ok) {
          lockStatus.textContent = "Không mở khóa được";
          const hint = [payload?.howToFixProd, payload?.howToFixLocal].filter(Boolean).join(" | ");
          const message = formatApiError(payload, "Không mở khóa được. Thử lại nhé.");
          showToast(hint ? `${message} (${hint})` : message);
          setLocked(true);
          return;
        }
        unlocked = Boolean(payload?.authenticated);
        if (!unlocked) {
          lockStatus.textContent = "Không mở khóa được";
          showToast("Không mở khóa được. Thử lại nhé.");
          setLocked(true);
          return;
        }
        passwordInput.value = "";
        setLocked(false);
        await loadPosts();
        await loadComments();
      } finally {
        setLoginLoading(false);
      }
    };

    const checkSession = async () => {
      const res = await fetch("/api/admin/session");
      if (!res.ok) {
        unlocked = false;
        setLocked(true);
        return;
      }
      const data = await res.json().catch(() => ({}));
      unlocked = Boolean(data?.authenticated);
      setLocked(!unlocked);
      if (unlocked) {
        await loadPosts();
        await loadComments();
      }
    };

    loginBtn?.addEventListener("click", login);
    passwordInput?.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        login();
      }
    });
    logoutBtn?.addEventListener("click", async () => {
      await fetch("/api/admin/logout", { method: "POST" });
      unlocked = false;
      setLocked(true);
    });

    linkCopy?.addEventListener("click", async () => {
      if (!linkText?.value) return;
      try {
        await navigator.clipboard.writeText(linkText.value);
        showToast("Đã sao chép link.", "info");
      } catch {
        showToast("Không sao chép được link.", "error");
      }
    });

    linkOpen?.addEventListener("click", () => {
      if (!linkText?.value) return;
      window.open(linkText.value, "_blank", "noopener,noreferrer");
    });

    const fields = [
      "id",
      "title",
      "slug",
      "summary",
      "cover_key",
      "cover_url",
      "topic",
      "author",
      "location",
      "event_time",
      "written_at",
      "photo_time",
      "tags_csv",
      "side_note",
      "voice_memo",
      "voice_memo_title",
      "pinned",
      "pinned_priority",
      "pinned_until",
      "pinned_style",
      "layout",
      "sort_order",
      "status",
      "content_md",
    ];

    const DRAFT_KEY = "twaw_admin_draft_v1";

    const saveDraft = () => {
      if (!form || !enableDraftSave) return;
      if (state.active?.id) return;
      const data = {};
      fields.forEach((name) => {
        const input = form.querySelector(`[name="${name}"]`);
        if (!input) return;
        data[name] = input.value;
      });
      localStorage.setItem(DRAFT_KEY, JSON.stringify({ data, savedAt: Date.now() }));
    };

    const loadDraft = () => {
      if (!form || state.active?.id || !enableDraftSave) return;
      const raw = localStorage.getItem(DRAFT_KEY);
      if (!raw) return;
      let payload = null;
      try {
        payload = JSON.parse(raw);
      } catch {
        return;
      }
      if (!payload?.data) return;
      fields.forEach((name) => {
        const input = form.querySelector(`[name="${name}"]`);
        if (!input || payload.data[name] === undefined) return;
        input.value = payload.data[name];
      });
      status.textContent = "Đang dùng bản nháp trên máy";
      updateLinkPreview();
    };

    const clearDraft = () => {
      localStorage.removeItem(DRAFT_KEY);
    };

    const fillForm = (post = {}) => {
      fields.forEach((name) => {
        const input = form.querySelector(`[name="${name}"]`);
        if (!input) return;
        if (name === "author") {
          input.value = post.author ?? post.author_name ?? "";
          return;
        }
        if (name === "content_md") {
          input.value = post.content_md ?? post.body_markdown ?? "";
          return;
        }
        input.value = post[name] ?? (input.type === "number" ? 0 : "");
      });
      if (uploadInput) uploadInput.value = "";
      selectedFiles = [];
      renderPreview();
      state.dirty = false;
      status.textContent = post.status
        ? `Trạng thái: ${post.status}`
        : "Chưa chọn bài";
      updateLinkPreview();
    };

    const renderList = () => {
      if (!list) return;
      if (!state.posts.length) {
        list.innerHTML = "<p class='text-sm text-black/50'>Chưa có bài nào.</p>";
        return;
      }
      list.innerHTML = state.posts
        .map(
          (post) => `
            <button type="button" class="w-full text-left border border-black/10 rounded-2xl p-4 hover:border-black/30" data-post-id="${post.id}">
              <div class="text-xs text-black/50">${post.status}</div>
              <div class="font-semibold">${post.title}</div>
              <div class="text-xs text-black/50">${post.slug}</div>
            </button>
          `
        )
        .join("");
      list.querySelectorAll("[data-post-id]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.postId;
          state.active = state.posts.find((p) => p.id === id);
          fillForm(state.active);
        });
      });
    };

    const loadPosts = async () => {
      if (!isUnlocked()) return;
      const res = await fetch("/api/admin/posts");
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
        }
        const payload = await res.json().catch(() => ({}));
        showToast(formatApiError(payload, "Không tải được bài viết."));
        return;
      }
      const data = await res.json();
      state.posts = data.posts || [];
      renderList();
    };

    const loadComments = async () => {
      if (!commentList || !isUnlocked()) return;
      const filter = commentFilter?.value ?? "visible";
      const res = await fetch(`/api/admin/comments?status=${encodeURIComponent(filter)}`);
      if (!res.ok) {
        const payload = await res.json().catch(() => ({}));
        showToast(formatApiError(payload, "Không tải được comment."));
        return;
      }
      const data = await res.json();
      const items = data.comments || [];
      const escapeHtml = (value = "") =>
        String(value)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      if (!items.length) {
        commentList.innerHTML = "<p class='text-sm text-black/50'>Chưa có comment.</p>";
        return;
      }
      commentList.innerHTML = items
        .map(
          (item) => `
            <div class="comment-card">
              <div class="comment-meta">
                <span class="comment-name">${escapeHtml(item.display_name || "Ẩn danh")}</span>
                <span class="comment-time">${new Date(item.created_at).toLocaleString("vi-VN")}</span>
                <span class="comment-nick">${escapeHtml(item.post_slug)}</span>
              </div>
              <p class="comment-body">${escapeHtml(item.body)}</p>
              <div class="mt-3 flex flex-wrap gap-2">
                <button class="btn text-xs" data-comment-action="visible" data-comment-id="${item.id}">Duyệt</button>
                <button class="btn text-xs" data-comment-action="hidden" data-comment-id="${item.id}">Ẩn</button>
                <button class="btn text-xs" data-comment-action="delete" data-comment-id="${item.id}">Xóa</button>
              </div>
            </div>
          `
        )
        .join("");
      commentList.querySelectorAll("[data-comment-action]").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.commentId;
          const action = btn.dataset.commentAction;
          if (!id || !action) return;
          commentNote.textContent = "Đang xử lý comment...";
          const csrf = getCsrfToken();
          const res =
            action === "delete"
              ? await fetch(`/api/admin/comments/${id}`, {
                  method: "DELETE",
                  headers: { "x-csrf-token": csrf },
                })
              : await fetch(`/api/admin/comments/${id}`, {
                  method: "PUT",
                  headers: { "content-type": "application/json", "x-csrf-token": csrf },
                  body: JSON.stringify({ status: action }),
                });
          if (!res.ok) {
            commentNote.textContent = "Lỗi xử lý comment.";
            const payload = await res.json().catch(() => ({}));
            showToast(formatApiError(payload, "Lỗi xử lý comment."));
            return;
          }
          commentNote.textContent = "Đã cập nhật comment.";
          await loadComments();
        });
      });
    };

    newBtn?.addEventListener("click", () => {
      state.active = null;
      fillForm({});
    });

    form?.querySelector("[name='title']")?.addEventListener("input", (e) => {
      const slugInput = form.querySelector("[name='slug']");
      if (!slugInput || slugInput.value.trim()) return;
      slugInput.value = slugify(e.target.value);
      updateLinkPreview();
    });

    form?.querySelector("[name='slug']")?.addEventListener("input", updateLinkPreview);

    form?.querySelectorAll("input, textarea, select").forEach((input) => {
      input.addEventListener("input", () => {
        state.dirty = true;
        saveDraft();
      });
    });

    const requiredFields = ["title", "author", "content_md"];
    const requiredOnCreate = ["topic"];

    const savePost = async ({ silent = false } = {}) => {
      if (!form) return false;
      if (!isUnlocked()) {
        note.textContent = "Cần mở khóa để lưu bài.";
        return false;
      }
      if (!silent) note.textContent = "Đang lưu...";
      const data = {};
      fields.forEach((name) => {
        const input = form.querySelector(`[name="${name}"]`);
        if (!input) return;
        if (name === "pinned") {
          data[name] = Number(input.value || 0);
          return;
        }
        data[name] = input.type === "number" ? Number(input.value || 0) : input.value;
      });
      if (data.tags_csv) {
        data.tags_json = JSON.stringify(
          String(data.tags_csv)
            .split(",")
            .map((t) => t.trim())
            .filter(Boolean)
        );
      }

      const isNew = !data.id;

      const missingField = requiredFields.find((name) => {
        const value = typeof data[name] === "string" ? data[name].trim() : "";
        return !value;
      });
      if (missingField) {
        const label = {
          title: "Tiêu đề",
          author: "Tác giả",
          content_md: "Nội dung",
        }[missingField];
        note.textContent = `Thiếu ${label}.`;
        const input = form.querySelector(`[name="${missingField}"]`);
        input?.focus();
        return false;
      }
      if (isNew) {
        const missingOnCreate = requiredOnCreate.find((name) => {
          const value = typeof data[name] === "string" ? data[name].trim() : "";
          return !value;
        });
        if (missingOnCreate) {
          note.textContent = "Thiếu Chủ đề.";
          const input = form.querySelector(`[name="${missingOnCreate}"]`);
          input?.focus();
          return false;
        }
        const contentValue = String(data.content_md || "");
        const hasImage = Boolean(data.cover_url) || /!\[.*?\]\(.+?\)/.test(contentValue);
        if (!hasImage) {
          note.textContent = "Thiếu ảnh. Hãy upload ít nhất 1 ảnh.";
          return false;
        }
      }
      const res = await fetch(isNew ? "/api/admin/posts" : `/api/admin/posts/${data.id}`, {
        method: isNew ? "POST" : "PUT",
        headers: { "content-type": "application/json", "x-csrf-token": getCsrfToken() },
        body: JSON.stringify(data),
      });
      const payload = await res.json().catch(() => ({}));
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để lưu bài.";
          return false;
        }
        if (!silent) {
          const message = formatApiError(payload, "Lưu chưa được, thử lại nhé.");
          note.textContent = message ? `Lưu lỗi: ${message}` : "Lưu chưa được, thử lại nhé.";
          showToast(message || "Lưu chưa được, thử lại nhé.");
        }
        return false;
      }
      if (isNew) {
        data.id = payload.id;
      }
      if (payload?.slug) {
        const slugInput = form.querySelector("[name='slug']");
        if (slugInput) {
          slugInput.value = payload.slug;
        }
        updateLinkPreview();
      }
      if (!silent) note.textContent = "Đã lưu.";
      clearDraft();
      await loadPosts();
      state.active = state.posts.find((p) => p.id === data.id);
      fillForm(state.active);
      return true;
    };

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      await savePost();
    });

    setInterval(async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id || !state.dirty || !isUnlocked()) return;
      const saved = await savePost({ silent: true });
      if (saved) state.dirty = false;
    }, 3000);

    publishBtn?.addEventListener("click", async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      const res = await fetch(`/api/admin/posts/${id}/publish`, {
        method: "POST",
        headers: { "x-csrf-token": getCsrfToken() },
      });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để publish.";
          return;
        }
        const payload = await res.json().catch(() => ({}));
        const message = formatApiError(payload, "Publish lỗi, thử lại nhé.");
        note.textContent = message;
        showToast(message);
        return;
      }
      await loadPosts();
      state.active = state.posts.find((p) => p.id === id);
      fillForm(state.active);
      updateLinkPreview();
      showToast("Đã publish. Link sẵn sàng mở.", "success");
    });

    unpublishBtn?.addEventListener("click", async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      const res = await fetch(`/api/admin/posts/${id}/unpublish`, {
        method: "POST",
        headers: { "x-csrf-token": getCsrfToken() },
      });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để gỡ publish.";
          return;
        }
        const payload = await res.json().catch(() => ({}));
        const message = formatApiError(payload, "Gỡ publish lỗi, thử lại nhé.");
        note.textContent = message;
        showToast(message);
        return;
      }
      await loadPosts();
      state.active = state.posts.find((p) => p.id === id);
      fillForm(state.active);
    });

    submitBtn?.addEventListener("click", async () => {
      const saved = await savePost();
      if (!saved) return;
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      const res = await fetch(`/api/admin/posts/${id}/publish`, {
        method: "POST",
        headers: { "x-csrf-token": getCsrfToken() },
      });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để publish.";
          return;
        }
        const payload = await res.json().catch(() => ({}));
        const message = formatApiError(payload, "Publish lỗi, thử lại nhé.");
        note.textContent = message;
        showToast(message);
        return;
      }
      await loadPosts();
      state.active = state.posts.find((p) => p.id === id);
      fillForm(state.active);
      note.textContent = "Đã đăng bài.";
      updateLinkPreview();
      showToast("Đã publish. Link sẵn sàng mở.", "success");
    });

    deleteBtn?.addEventListener("click", async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      if (!confirm("Xóa bài này?")) return;
      const res = await fetch(`/api/admin/posts/${id}`, {
        method: "DELETE",
        headers: { "x-csrf-token": getCsrfToken() },
      });
      if (!res.ok) {
        const payload = await res.json().catch(() => ({}));
        const message = formatApiError(payload, "Xóa lỗi, thử lại nhé.");
        note.textContent = message;
        showToast(message);
        return;
      }
      note.textContent = "Đã xóa.";
      await loadPosts();
      fillForm({});
    });

    previewToggle?.addEventListener("click", () => {
      if (!previewEl) return;
      previewEl.classList.toggle("hidden");
      const content = form?.querySelector("[name='content_md']")?.value ?? "";
      previewEl.innerHTML = marked.parse(content);
    });

    form?.querySelector("[name='content_md']")?.addEventListener("input", () => {
      if (!previewEl || previewEl.classList.contains("hidden")) return;
      previewEl.innerHTML = marked.parse(form.querySelector("[name='content_md']").value || "");
    });

    commentFilter?.addEventListener("change", loadComments);

    loadDraft();
    checkSession();

    const isHeic = (file) => {
      const name = file?.name?.toLowerCase() || "";
      return (
        file?.type === "image/heic" ||
        file?.type === "image/heif" ||
        file?.type === "image/heic-sequence" ||
        file?.type === "image/heif-sequence" ||
        name.endsWith(".heic") ||
        name.endsWith(".heif")
      );
    };

    const encodeJpeg = (canvas, quality) =>
      new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", quality));

    const decodeImage = async (source) => {
      try {
        const bitmap = await createImageBitmap(source, { imageOrientation: "from-image" });
        return {
          width: bitmap.width,
          height: bitmap.height,
          draw: (ctx, w, h) => ctx.drawImage(bitmap, 0, 0, w, h),
          cleanup: () => bitmap.close?.(),
        };
      } catch (error) {
        const url = URL.createObjectURL(source);
        const image = await new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error("IMAGE_DECODE_FAILED"));
          img.src = url;
        });
        return {
          width: image.naturalWidth || image.width,
          height: image.naturalHeight || image.height,
          draw: (ctx, w, h) => ctx.drawImage(image, 0, 0, w, h),
          cleanup: () => URL.revokeObjectURL(url),
        };
      }
    };

    const resizeImage = async (file, maxSize = 2048, quality = 0.82) => {
      const source = file;
      let decoded = null;
      try {
        decoded = await decodeImage(source);
      } catch (error) {
        throw new Error("IMAGE_DECODE_FAILED");
      }
      const ratio = Math.min(1, maxSize / Math.max(decoded.width, decoded.height));
      const targetWidth = Math.round(decoded.width * ratio);
      const targetHeight = Math.round(decoded.height * ratio);
      const canvas = document.createElement("canvas");
      canvas.width = targetWidth;
      canvas.height = targetHeight;
      const ctx = canvas.getContext("2d");
      if (!ctx) throw new Error("NO_CONTEXT");
      decoded.draw(ctx, targetWidth, targetHeight);
      decoded.cleanup?.();
      let currentQuality = quality;
      let blob = await encodeJpeg(canvas, currentQuality);
      while (blob && blob.size > MAX_FILE_BYTES && currentQuality > 0.5) {
        currentQuality = Math.max(0.5, currentQuality - 0.1);
        blob = await encodeJpeg(canvas, currentQuality);
      }
      if (!blob) throw new Error("NO_BLOB");
      return { blob, width: targetWidth, height: targetHeight };
    };

    const extensionFromMime = (type = "") => {
      if (type === "image/jpeg" || type === "image/jpg") return "jpg";
      if (type === "image/png") return "png";
      if (type === "image/webp") return "webp";
      if (type === "image/avif") return "avif";
      if (type === "image/heic" || type === "image/heic-sequence") return "heic";
      if (type === "image/heif" || type === "image/heif-sequence") return "heif";
      return "";
    };

    const renameForBlobType = (name, blobType) => {
      const ext = extensionFromMime(blobType);
      if (!ext) return name;
      const base = typeof name === "string" && name.trim() ? name.trim() : "image";
      if (/\.[a-z0-9]+$/i.test(base)) {
        return base.replace(/\.[a-z0-9]+$/i, `.${ext}`);
      }
      return `${base}.${ext}`;
    };

    const prepareUpload = async (file) => {
      if (isHeic(file)) {
        // Keep iPhone HEIC/HEIF files as-is (no auto conversion).
        return { blob: file, width: null, height: null, original: true };
      }
      try {
        const { blob, width, height } = await resizeImage(file);
        return { blob, width, height, original: false };
      } catch (error) {
        throw error;
      }
    };

    const uploadImage = async ({ file, slug, filename, sortOrder, batchId, index, signal }) => {
      const { blob, width, height, original } = await prepareUpload(file);
      const uploadName = renameForBlobType(filename || file?.name || "image", blob?.type || "");
      const formData = new FormData();
      formData.append("file", blob, uploadName);
      formData.append("slug", slug);
      formData.append(
        "meta",
        JSON.stringify({
          width,
          height,
          size: blob.size,
          originalName: file.name,
          fileName: uploadName,
          original,
          sort_order: sortOrder ?? 0,
          batch_id: batchId,
          index,
        })
      );
      const res = await fetch("/api/admin/upload", {
        method: "POST",
        headers: { "x-csrf-token": getCsrfToken() },
        body: formData,
        signal,
      });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          throw new Error("UNAUTHORIZED");
        }
        throw new Error("UPLOAD_FAILED");
      }
      return res.json();
    };

    clearPreviewUrls = () => {
      previewUrls.forEach((url) => URL.revokeObjectURL(url));
      previewUrls = [];
    };

    renderPreview = () => {
      if (!uploadPreview) return;
      uploadPreview.innerHTML = "";
      clearPreviewUrls();
      if (!selectedFiles.length) return;
      selectedFiles.forEach((file, index) => {
        const url = URL.createObjectURL(file);
        previewUrls.push(url);
        const card = document.createElement("div");
        card.className = "compose-thumb";
        const img = document.createElement("img");
        img.src = url;
        img.alt = file.name;
        const label = document.createElement("span");
        label.textContent = index === coverIndex ? "Cover" : "Ảnh";
        const actions = document.createElement("div");
        actions.className = "compose-thumb__actions";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn text-xs";
        btn.textContent = index === coverIndex ? "Cover" : "Đặt làm cover";
        btn.disabled = index === coverIndex;
        btn.addEventListener("click", () => {
          coverIndex = index;
          renderPreview();
        });
        actions.append(btn);
        card.append(img, label, actions);
        uploadPreview.append(card);
      });
    };

    uploadInput?.addEventListener("change", () => {
      selectedFiles = Array.from(uploadInput.files || []);
      coverIndex = 0;
      uploadBatchId = Date.now();
      renderPreview();
      markDirty();
      startUpload();
    });

    uploadCancel?.addEventListener("click", () => {
      uploadController?.abort();
      if (uploadProgress) uploadProgress.textContent = "";
      uploadCancel?.classList.add("hidden");
    });

    const startUpload = async () => {
      if (!isUnlocked()) {
        uploadNote.textContent = "Cần mở khóa để upload.";
        return;
      }
      if (!selectedFiles.length) return;
      if (selectedFiles.length > MAX_UPLOAD_FILES) {
        uploadNote.textContent = `Chọn tối đa ${MAX_UPLOAD_FILES} ảnh thôi nha.`;
        return;
      }
      uploadNote.textContent = "";
      if (uploadProgress) uploadProgress.textContent = "Đang xử lý ảnh...";
      const safeSlug = getSlugValue() || "untitled";
      const batchId = uploadBatchId ?? Date.now();
      let successCount = 0;
      uploadController?.abort();
      uploadController = new AbortController();
      uploadCancel?.classList.remove("hidden");
      let nextSortOrder = 1;
      for (const [index, file] of selectedFiles.entries()) {
        try {
          if (uploadController.signal.aborted) break;
          const filename = file.name || `image-${index + 1}.${isHeic(file) ? "heic" : "jpg"}`;
          const sortOrder = index === coverIndex ? 0 : nextSortOrder++;
          if (uploadProgress) {
            uploadProgress.textContent = `Đang upload ${index + 1}/${selectedFiles.length}...`;
          }
          const payload = await uploadImage({
            file,
            slug: safeSlug,
            filename,
            sortOrder,
            batchId,
            index: index + 1,
            signal: uploadController.signal,
          });
          const contentField = form?.querySelector("[name='content_md']");
          const coverInput = form?.querySelector("[name='cover_url']");
          const coverKeyInput = form?.querySelector("[name='cover_key']");
          if (sortOrder === 0) {
            if (payload.url && coverInput) {
              coverInput.value = payload.url;
              coverInput.dispatchEvent(new Event("input", { bubbles: true }));
            }
            if (payload.key && coverKeyInput) {
              coverKeyInput.value = payload.key;
              coverKeyInput.dispatchEvent(new Event("input", { bubbles: true }));
            }
            if (payload.url && contentField && !contentField.value.includes(payload.url)) {
              contentField.value = `![cover](${payload.url})\n\n${contentField.value}`.trim();
              contentField.dispatchEvent(new Event("input", { bubbles: true }));
            }
          }
          if (payload.url && contentField) {
            if (sortOrder !== 0) {
              contentField.value += `\n\n![${filename}](${payload.url})`;
              contentField.dispatchEvent(new Event("input", { bubbles: true }));
            }
            markDirty();
          }
          successCount += 1;
        } catch (error) {
          if (error?.name === "AbortError") {
            uploadNote.textContent = "Đã hủy upload ảnh.";
          } else if (error?.message === "IMAGE_DECODE_FAILED") {
            uploadNote.textContent = "Không đọc được ảnh này để tối ưu. Vui lòng thử ảnh khác.";
            showToast("Image decode failed. Try another image.", "info");
          } else {
            uploadNote.textContent =
              "Có ảnh upload lỗi. Thử ảnh khác rồi upload lại.";
          }
        }
      }
      if (uploadProgress) uploadProgress.textContent = "";
      if (!uploadController?.signal?.aborted) {
        uploadNote.textContent = `Đã upload ${successCount} ảnh.`;
      }
      if (uploadInput) uploadInput.value = "";
      selectedFiles = [];
      renderPreview();
      uploadCancel?.classList.add("hidden");
      uploadController = null;
      uploadBatchId = null;
    };

    setLocked(true);
  </script>
</BaseLayout>
