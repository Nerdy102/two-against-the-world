---
import BaseLayout from "../../layouts/BaseLayout.astro";
import RansomTitle from "../../components/RansomTitle.astro";
import { TOPICS } from "../../config/topics";

export const prerender = false;
---

<BaseLayout title="Admin — Two Against The World" description="Admin dashboard">
  <main class="mx-auto max-w-6xl px-5 pb-24 pt-10">
    <section class="paper edge-torn p-6 sm:p-10" data-reveal>
      <div class="kicker text-xs text-black/50">ADMIN</div>
      <RansomTitle text="Publish là lên ngay" as="h1" class="text-[44px] sm:text-[56px]" />
      <p class="mt-3 text-black/60">
        Quản lý bài viết từ điện thoại: tạo draft, lưu và publish ngay lập tức.
      </p>
    </section>

    <section class="mt-10 grid gap-8 lg:grid-cols-[1fr_2fr]">
      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Danh sách bài</h2>
          <button class="btn" type="button" data-new-post>Tạo bài mới</button>
        </div>
        <div class="mt-4 space-y-3" data-post-list></div>
      </div>

      <div class="paper edge-torn p-6 sm:p-8" data-reveal>
        <div class="flex flex-wrap items-center gap-3">
          <h2 class="text-lg font-semibold">Soạn bài</h2>
          <span class="text-xs text-black/50" data-post-status>Chưa chọn bài</span>
        </div>
        <div class="mt-4 space-y-3" data-admin-lock>
          <p class="text-xs text-black/60">
            Nhập mật khẩu để mở khóa soạn bài & upload. Trạng thái: <span data-admin-status>Đang khóa</span>
          </p>
          <div class="flex flex-wrap items-center gap-3">
            <input
              class="input"
              type="password"
              name="admin_password"
              placeholder="Nhập mật khẩu"
              data-admin-password
            />
            <button class="btn" type="button" data-admin-unlock>Mở khóa</button>
          </div>
        </div>

        <form class="mt-4 space-y-4" data-post-form>
          <p class="text-xs text-black/60">Trường có <span class="text-red-500">*</span> là bắt buộc.</p>
          <input type="hidden" name="id" />

          <label class="compose-field">
            <span>Tiêu đề <span class="text-red-500">*</span></span>
            <input class="input" name="title" placeholder="Tiêu đề bài viết" required />
          </label>

          <label class="compose-field">
            <span>Đường dẫn bài viết <span class="text-red-500">*</span></span>
            <input class="input" name="slug" placeholder="vi-du-duong-dan-bai-viet" required />
            <p class="mt-2 text-xs text-black/50">
              Gợi ý: Tự tạo từ tiêu đề (tiếng Việt), sẽ bỏ dấu và thay khoảng trắng bằng dấu gạch ngang.
            </p>
          </label>

          <label class="compose-field">
            <span>Tóm tắt</span>
            <input class="input" name="summary" placeholder="Một câu giới thiệu ngắn" />
          </label>

          <div class="compose-field">
            <span>Ảnh cover (upload)</span>
            <input type="hidden" name="cover_url" />
            <input
              class="input"
              type="file"
              name="cover_upload"
              accept="image/*,image/heic,image/heif"
              capture="environment"
            />
            <p class="mt-2 text-xs text-black/50">
              Chọn ảnh từ iPhone (HEIC/HEIF sẽ được tự tối ưu sang JPG). Ảnh cover sẽ tự chèn vào bài.
            </p>
            <button class="btn mt-3" type="button" data-upload-cover>Upload ảnh cover</button>
            <p class="text-xs text-black/50" data-cover-note></p>
          </div>

          <label class="compose-field">
            <span>Chủ đề</span>
            <select class="input" name="topic">
              <option value="">Chưa phân loại</option>
              {TOPICS.map((t) => (
                <option value={t.slug}>{t.label}</option>
              ))}
            </select>
          </label>

          <label class="compose-field">
            <span>Tác giả</span>
            <input class="input" name="author" placeholder="you | partner" />
          </label>

          <label class="compose-field">
            <span>Địa điểm</span>
            <input class="input" name="location" placeholder="Địa điểm" />
          </label>

          <label class="compose-field">
            <span>Thời gian sự kiện</span>
            <input class="input" name="event_time" placeholder="20:30 - 21:00" />
          </label>

          <label class="compose-field">
            <span>Viết lúc</span>
            <input class="input" name="written_at" placeholder="21/02/2026" />
          </label>

          <label class="compose-field">
            <span>Chụp lúc</span>
            <input class="input" name="photo_time" placeholder="21/02/2026" />
          </label>

          <label class="compose-field">
            <span>Tags (phân tách bằng dấu phẩy)</span>
            <input class="input" name="tags_csv" placeholder="memory, love" />
          </label>

          <label class="compose-field">
            <span>Ghi chú thêm</span>
            <input class="input" name="side_note" placeholder="Một câu thêm" />
          </label>

          <label class="compose-field">
            <span>Voice memo (URL)</span>
            <input class="input" name="voice_memo" placeholder="https://..." />
          </label>

          <label class="compose-field">
            <span>Tiêu đề voice memo</span>
            <input class="input" name="voice_memo_title" placeholder="Tên đoạn ghi âm" />
          </label>

          <label class="compose-field">
            <span>Thư mục ảnh (nếu có)</span>
            <input class="input" name="photo_dir" placeholder="ten-thu-muc" />
          </label>

          <label class="compose-field">
            <span>Số ảnh</span>
            <input class="input" type="number" min="0" name="photo_count" placeholder="0" />
          </label>

          <label class="compose-field">
            <span>Ghim bài</span>
            <select class="input" name="pinned">
              <option value="0">Không</option>
              <option value="1">Có</option>
            </select>
          </label>

          <label class="compose-field">
            <span>Nội dung (Markdown) <span class="text-red-500">*</span></span>
            <textarea
              class="input compose-textarea"
              name="content_md"
              rows={12}
              placeholder="Viết nội dung..."
              required
            ></textarea>
          </label>

          <div class="compose-field">
            <span>Upload ảnh iPhone (tối ưu)</span>
            <input
              class="input"
              type="file"
              name="upload_photos"
              accept="image/*,image/heic,image/heif"
              multiple
            />
            <p class="mt-2 text-xs text-black/50">
              Tối ưu kích thước và nén nhẹ để đăng nhanh. Nếu ảnh HEIC lỗi, hãy chọn “Most Compatible” trong
              Camera → Formats.
            </p>
            <button class="btn mt-3" type="button" data-upload-photos>Upload ảnh</button>
            <p class="text-xs text-black/50" data-upload-note></p>
          </div>

          <div class="flex flex-wrap gap-3">
            <button class="btn" type="submit" data-save-post>Lưu</button>
            <button class="btn" type="button" data-submit-post>Đăng bài ngay</button>
            <button class="btn" type="button" data-publish-post>Publish</button>
            <button class="btn" type="button" data-unpublish-post>Gỡ publish</button>
          </div>
          <p class="text-xs text-black/50" data-form-note></p>
        </form>
      </div>
    </section>
  </main>

  <script>
    import heic2any from "heic2any";

    const slugify = (s = "") =>
      s
        .toLowerCase()
        .replace(/đ/g, "d")
        .normalize("NFKD")
        .replace(/[^\w\s-]/g, "")
        .trim()
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-");

    const form = document.querySelector("[data-post-form]");
    const list = document.querySelector("[data-post-list]");
    const status = document.querySelector("[data-post-status]");
    const note = document.querySelector("[data-form-note]");
    const newBtn = document.querySelector("[data-new-post]");
    const publishBtn = document.querySelector("[data-publish-post]");
    const unpublishBtn = document.querySelector("[data-unpublish-post]");
    const submitBtn = document.querySelector("[data-submit-post]");
    const coverBtn = document.querySelector("[data-upload-cover]");
    const coverNote = document.querySelector("[data-cover-note]");
    const uploadBtn = document.querySelector("[data-upload-photos]");
    const uploadNote = document.querySelector("[data-upload-note]");
    const lockWrap = document.querySelector("[data-admin-lock]");
    const lockStatus = document.querySelector("[data-admin-status]");
    const lockInput = document.querySelector("[data-admin-password]");
    const unlockBtn = document.querySelector("[data-admin-unlock]");
    let unlocked = false;

    const state = {
      posts: [],
      active: null,
      dirty: false,
    };

    const markDirty = () => {
      state.dirty = true;
    };

    const setLocked = (locked) => {
      if (lockStatus) {
        lockStatus.textContent = locked ? "Đang khóa" : "Đã mở khóa";
      }
      lockWrap?.classList.toggle("opacity-60", locked);
      const controls = [
        newBtn,
        publishBtn,
        unpublishBtn,
        submitBtn,
        coverBtn,
        uploadBtn,
        ...(form ? Array.from(form.querySelectorAll("input, textarea, select, button")) : []),
      ].filter(Boolean);
      controls.forEach((el) => {
        if (el?.hasAttribute("data-admin-unlock") || el?.hasAttribute("data-admin-password")) return;
        el.disabled = locked;
      });
    };

    const isUnlocked = () => unlocked;

    const unlock = async () => {
      if (!lockInput?.value) {
        lockStatus.textContent = "Nhập mật khẩu";
        return;
      }
      const res = await fetch("/api/admin/unlock", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ password: lockInput.value }),
      });
      if (!res.ok) {
        lockStatus.textContent = "Sai mật khẩu";
        return;
      }
      const data = await res.json().catch(() => ({}));
      if (!data?.unlocked) {
        lockStatus.textContent = "Sai mật khẩu";
        return;
      }
      unlocked = true;
      lockInput.value = "";
      setLocked(false);
      await loadPosts();
    };

    const checkSession = async () => {
      const res = await fetch("/api/admin/session");
      if (!res.ok) {
        unlocked = false;
        setLocked(true);
        return;
      }
      const data = await res.json().catch(() => ({}));
      unlocked = Boolean(data?.unlocked);
      setLocked(!unlocked);
      if (unlocked) await loadPosts();
    };

    unlockBtn?.addEventListener("click", unlock);
    lockInput?.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        unlock();
      }
    });

    const fields = [
      "id",
      "title",
      "slug",
      "summary",
      "cover_url",
      "topic",
      "author",
      "location",
      "event_time",
      "written_at",
      "photo_time",
      "tags_csv",
      "side_note",
      "voice_memo",
      "voice_memo_title",
      "photo_dir",
      "photo_count",
      "pinned",
      "content_md",
    ];

    const fillForm = (post = {}) => {
      fields.forEach((name) => {
        const input = form.querySelector(`[name="${name}"]`);
        if (!input) return;
        input.value = post[name] ?? (input.type === "number" ? 0 : "");
      });
      state.dirty = false;
      status.textContent = post.status
        ? `Trạng thái: ${post.status}`
        : "Chưa chọn bài";
    };

    const renderList = () => {
      if (!list) return;
      if (!state.posts.length) {
        list.innerHTML = "<p class='text-sm text-black/50'>Chưa có bài nào.</p>";
        return;
      }
      list.innerHTML = state.posts
        .map(
          (post) => `
            <button type="button" class="w-full text-left border border-black/10 rounded-2xl p-4 hover:border-black/30" data-post-id="${post.id}">
              <div class="text-xs text-black/50">${post.status}</div>
              <div class="font-semibold">${post.title}</div>
              <div class="text-xs text-black/50">${post.slug}</div>
            </button>
          `
        )
        .join("");
      list.querySelectorAll("[data-post-id]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.postId;
          state.active = state.posts.find((p) => p.id === id);
          fillForm(state.active);
        });
      });
    };

    const loadPosts = async () => {
      if (!isUnlocked()) return;
      const res = await fetch("/api/admin/posts");
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
        }
        return;
      }
      const data = await res.json();
      state.posts = data.posts || [];
      renderList();
    };

    newBtn?.addEventListener("click", () => {
      state.active = null;
      fillForm({});
    });

    form?.querySelector("[name='title']")?.addEventListener("input", (e) => {
      const slugInput = form.querySelector("[name='slug']");
      if (!slugInput || slugInput.value.trim()) return;
      slugInput.value = slugify(e.target.value);
    });

    form?.querySelectorAll("input, textarea, select").forEach((input) => {
      input.addEventListener("input", () => {
        state.dirty = true;
      });
    });

    const requiredFields = ["title", "slug", "content_md"];

    const savePost = async ({ silent = false } = {}) => {
      if (!form) return false;
      if (!isUnlocked()) {
        note.textContent = "Cần mở khóa để lưu bài.";
        return false;
      }
      if (!silent) note.textContent = "Đang lưu...";
      const data = {};
      fields.forEach((name) => {
        const input = form.querySelector(`[name="${name}"]`);
        if (!input) return;
        if (name === "pinned") {
          data[name] = Number(input.value || 0);
          return;
        }
        data[name] = input.type === "number" ? Number(input.value || 0) : input.value;
      });

      const missingField = requiredFields.find((name) => {
        const value = typeof data[name] === "string" ? data[name].trim() : "";
        return !value;
      });
      if (missingField) {
        const label = {
          title: "Tiêu đề",
          slug: "Đường dẫn",
          content_md: "Nội dung",
        }[missingField];
        note.textContent = `Thiếu ${label}.`;
        const input = form.querySelector(`[name="${missingField}"]`);
        input?.focus();
        return false;
      }

      const isNew = !data.id;
      const res = await fetch(isNew ? "/api/admin/posts" : `/api/admin/posts/${data.id}`, {
        method: isNew ? "POST" : "PUT",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(data),
      });
      const payload = await res.json().catch(() => ({}));
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để lưu bài.";
          return false;
        }
        if (!silent) {
          note.textContent = payload?.error
            ? `Lưu lỗi: ${payload.error}`
            : "Lưu chưa được, thử lại nhé.";
        }
        return false;
      }
      if (isNew) {
        data.id = payload.id;
      }
      if (!silent) note.textContent = "Đã lưu.";
      await loadPosts();
      state.active = state.posts.find((p) => p.id === data.id);
      fillForm(state.active);
      return true;
    };

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      await savePost();
    });

    setInterval(async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id || !state.dirty || !isUnlocked()) return;
      const saved = await savePost({ silent: true });
      if (saved) state.dirty = false;
    }, 3000);

    publishBtn?.addEventListener("click", async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      const res = await fetch(`/api/admin/posts/${id}/publish`, { method: "POST" });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để publish.";
          return;
        }
        note.textContent = "Publish lỗi, thử lại nhé.";
        return;
      }
      await loadPosts();
      state.active = state.posts.find((p) => p.id === id);
      fillForm(state.active);
    });

    unpublishBtn?.addEventListener("click", async () => {
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      const res = await fetch(`/api/admin/posts/${id}/unpublish`, { method: "POST" });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để gỡ publish.";
          return;
        }
        note.textContent = "Gỡ publish lỗi, thử lại nhé.";
        return;
      }
      await loadPosts();
      state.active = state.posts.find((p) => p.id === id);
      fillForm(state.active);
    });

    submitBtn?.addEventListener("click", async () => {
      const saved = await savePost();
      if (!saved) return;
      const id = form?.querySelector("[name='id']")?.value;
      if (!id) return;
      const res = await fetch(`/api/admin/posts/${id}/publish`, { method: "POST" });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          note.textContent = "Cần mở khóa để publish.";
          return;
        }
        note.textContent = "Publish lỗi, thử lại nhé.";
        return;
      }
      await loadPosts();
      state.active = state.posts.find((p) => p.id === id);
      fillForm(state.active);
      note.textContent = "Đã đăng bài.";
    });

    checkSession();

    const isHeic = (file) => {
      const name = file?.name?.toLowerCase() || "";
      return file?.type === "image/heic" || file?.type === "image/heif" || name.endsWith(".heic");
    };

    const toJpegBlob = async (file, quality = 0.82) => {
      if (!isHeic(file)) return file;
      const blob = await heic2any({ blob: file, toType: "image/jpeg", quality });
      return blob instanceof Blob ? blob : new Blob([blob], { type: "image/jpeg" });
    };

    const resizeImage = async (file, maxSize = 2048, quality = 0.82) => {
      const source = await toJpegBlob(file, quality);
      const bitmap = await createImageBitmap(source, { imageOrientation: "from-image" });
      const ratio = Math.min(1, maxSize / Math.max(bitmap.width, bitmap.height));
      const targetWidth = Math.round(bitmap.width * ratio);
      const targetHeight = Math.round(bitmap.height * ratio);
      const canvas = document.createElement("canvas");
      canvas.width = targetWidth;
      canvas.height = targetHeight;
      const ctx = canvas.getContext("2d");
      if (!ctx) throw new Error("NO_CONTEXT");
      ctx.drawImage(bitmap, 0, 0, targetWidth, targetHeight);
      const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/jpeg", quality));
      if (!blob) throw new Error("NO_BLOB");
      return { blob, width: targetWidth, height: targetHeight };
    };

    const uploadImage = async ({ file, slug, filename }) => {
      const { blob, width, height } = await resizeImage(file);
      const formData = new FormData();
      formData.append("file", blob, filename);
      formData.append("slug", slug);
      formData.append(
        "meta",
        JSON.stringify({
          width,
          height,
          size: blob.size,
          originalName: file.name,
          fileName: filename,
        })
      );
      const res = await fetch("/api/admin/upload", {
        method: "POST",
        body: formData,
      });
      if (!res.ok) {
        if (res.status === 401) {
          unlocked = false;
          setLocked(true);
          throw new Error("UNAUTHORIZED");
        }
        throw new Error("UPLOAD_FAILED");
      }
      return res.json();
    };

    coverBtn?.addEventListener("click", async () => {
      if (!isUnlocked()) {
        coverNote.textContent = "Cần mở khóa để upload.";
        return;
      }
      const input = form?.querySelector("input[name='cover_upload']");
      const file = input?.files?.[0];
      if (!file) return;
      coverNote.textContent = "Đang xử lý ảnh cover...";
      const slugValue = form?.querySelector("[name='slug']")?.value;
      if (!slugValue) {
        coverNote.textContent = "Hãy nhập đường dẫn trước khi upload cover.";
        return;
      }
      const slug = slugValue || "untitled";
      const safeSlug = slugify(slug);
      const filenameBase = file.name.replace(/\.[^.]+$/, "");
      const filename = `${filenameBase || "cover"}-${Date.now()}.jpg`;
      try {
        const payload = await uploadImage({ file, slug: safeSlug, filename });
        const coverInput = form?.querySelector("[name='cover_url']");
        if (payload.url && coverInput) {
          coverInput.value = payload.url;
          coverInput.dispatchEvent(new Event("input", { bubbles: true }));
        }
        const contentField = form?.querySelector("[name='content_md']");
        if (payload.url && contentField && !contentField.value.includes(payload.url)) {
          contentField.value = `![cover](${payload.url})\n\n${contentField.value}`.trim();
          contentField.dispatchEvent(new Event("input", { bubbles: true }));
        }
        coverNote.textContent = "Đã upload ảnh cover.";
        input.value = "";
        markDirty();
      } catch (error) {
        coverNote.textContent = "Upload ảnh cover lỗi. Thử lại hoặc đổi định dạng ảnh.";
      }
    });

    uploadBtn?.addEventListener("click", async () => {
      if (!isUnlocked()) {
        uploadNote.textContent = "Cần mở khóa để upload.";
        return;
      }
      const input = form?.querySelector("input[name='upload_photos']");
      if (!input?.files?.length) return;
      uploadNote.textContent = "Đang xử lý ảnh...";
      const slugValue = form?.querySelector("[name='slug']")?.value;
      if (!slugValue) {
        uploadNote.textContent = "Hãy nhập đường dẫn trước khi upload ảnh.";
        return;
      }
      const slug = slugValue || "untitled";
      const safeSlug = slugify(slug);
      const date = new Date().toISOString().slice(0, 10);
      let successCount = 0;
      for (const [index, file] of Array.from(input.files).entries()) {
        try {
          const paddedIndex = String(index + 1).padStart(3, "0");
          const filename = `${date}_${safeSlug}_${paddedIndex}.jpg`;
          const payload = await uploadImage({ file, slug: safeSlug, filename });
          const contentField = form?.querySelector("[name='content_md']");
          if (payload.url && contentField) {
            contentField.value += `\n\n![${filename}](${payload.url})`;
            contentField.dispatchEvent(new Event("input", { bubbles: true }));
            markDirty();
          }
          successCount += 1;
        } catch (error) {
          uploadNote.textContent = "Có ảnh upload lỗi. Thử lại hoặc đổi định dạng ảnh.";
        }
      }
      uploadNote.textContent = `Đã upload ${successCount} ảnh.`;
      input.value = "";
    });

    setLocked(true);
  </script>
</BaseLayout>
