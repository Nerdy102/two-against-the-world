---
import BaseLayout from "../layouts/BaseLayout.astro";
import RansomTitle from "../components/RansomTitle.astro";
import FeedCard from "../components/FeedCard.astro";
import TopicCard from "../components/TopicCard.astro";
import { TOPICS } from "../config/topics";
import { ensurePostMediaSchema, ensurePostsSchema, getDb, type PostRecord } from "../lib/d1";
import {
  getPublishedPostsFromContent,
  mergePostsBySlug,
  resolvePostCoverUrl,
  shouldUseContentFallback,
} from "../lib/posts";

export const prerender = false;

let posts: PostRecord[] = [];
let dbPosts: PostRecord[] = [];
try {
  const allowBootstrap = Astro.locals?.runtime?.env?.ALLOW_SCHEMA_BOOTSTRAP === "true";
  const db = getDb(Astro.locals);
  await ensurePostsSchema(db, { allowBootstrap });
  await ensurePostMediaSchema(db, { allowBootstrap });
  const { results = [] } = await db
    .prepare(
      `SELECT
        id,
        slug,
        title,
        summary,
        COALESCE(
          NULLIF(posts.cover_url, ''),
          (
            SELECT pm.url
            FROM post_media pm
            WHERE pm.post_id = posts.id
            ORDER BY pm.sort_order ASC, datetime(pm.created_at) ASC
            LIMIT 1
          )
        ) as cover_url,
        video_url,
        video_poster,
        status,
        author_name,
        topic,
        published_at,
        CASE
          WHEN pinned = 1 AND (pinned_until IS NULL OR datetime(pinned_until) > datetime('now')) THEN 1
          ELSE 0
        END as pinned,
       pinned_priority, pinned_until, pinned_style, sort_order
       FROM posts
       WHERE status = 'published'
       ORDER BY pinned DESC, pinned_priority DESC, datetime(published_at) DESC`
    )
    .all<PostRecord>();
  dbPosts = results ?? [];
  if (shouldUseContentFallback()) {
    const contentPosts = await getPublishedPostsFromContent();
    posts = mergePostsBySlug(dbPosts, contentPosts);
  } else {
    posts = dbPosts;
  }
} catch (err) {
  console.warn("Using content posts fallback:", err);
  posts = await getPublishedPostsFromContent();
}

const counts: Record<string, number> = {};
for (const p of posts) {
  const t = p.topic ?? "two-of-us";
  counts[t] = (counts[t] ?? 0) + 1;
}

const entriesCard = {
  slug: "entries",
  label: "Nháº­t kÃ½",
  icon: "ğŸ““",
  color: "#f97316",
  href: "/entries",
};

---

<BaseLayout title="Nháº­t kÃ½ â€” Two Against The World" active="entries" description="Kho lÆ°u nháº­t kÃ½">
  <section class="paper edge-torn px-6 py-7 sm:px-8 sm:py-8" data-reveal>
    <p class="kicker text-[18px] text-black/50">ğŸ©¸â€œTin YÃªuâ€ğŸ–¤</p>
    <div class="mt-2">
  <RansomTitle
    text="Our-main-eventsğŸ¸"
    as="h1"
    stampEvery={0}
    class="text-[44px] sm:text-[56px] ransom-red"
  />
</div>

    <p class="mt-4 text-black/70">
      Cáº©n tháº­n nhÃ©, cháº¡m vÃ o lÃ  cÆ¡ duyÃªn cá»§a chÃºng ta sáº½ thÃ nh giao Æ°á»›c ğŸ•¯ï¸.
    </p>

    <details class="topic-panel" data-topic-panel open>
      <summary class="topic-panel__summary">
        <span aria-hidden="true">â–¾</span>
        <span>Vá»«ng Æ¡i, má»Ÿ cá»­a ra !!!!!!</span>
      </summary>
      <div class="topic-panel__body">
        <div class="topic-grid">
          {TOPICS.map((t) => (
            <TopicCard slug={t.slug} label={t.label} icon={t.icon} color={t.color} count={counts[t.slug] ?? 0} />
          ))}
          <TopicCard
            slug={entriesCard.slug}
            label={entriesCard.label}
            icon={entriesCard.icon}
            color={entriesCard.color}
            count={posts.length}
            href={entriesCard.href}
          />
        </div>
      </div>
    </details>
  </section>

  <section class="mt-10">
    <div class="pinterest-grid">
      {posts.map((post) => (
        <FeedCard
          href={`/entries/${post.slug}${post.video_url ? "#entry-video" : ""}`}
          image={resolvePostCoverUrl(post)}
          title={post.title}
          description={post.summary ?? ""}
          author={post.author_name ?? ""}
          date={post.published_at ?? ""}
          topic={post.topic ?? undefined}
          locked={post.topic === "trash-bin"}
          pinned={Boolean(post.pinned)}
          pinnedStyle={post.pinned_style ?? undefined}
        />
      ))}
    </div>
  </section>
</BaseLayout>
