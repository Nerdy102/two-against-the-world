---
import BaseLayout from "../layouts/BaseLayout.astro";
import RansomTitle from "../components/RansomTitle.astro";
import FeedCard from "../components/FeedCard.astro";
import TopicCard from "../components/TopicCard.astro";
import { resolveTopicSlug, TOPICS } from "../config/topics";
import { ensurePostMediaSchema, ensurePostsSchema, getDb, type PostRecord } from "../lib/d1";
import {
  getPublishedPostsFromContent,
  mergePostsBySlug,
  resolvePostCoverUrl,
  shouldUseContentFallback,
} from "../lib/posts";

export const prerender = false;

let posts: PostRecord[] = [];
let dbPosts: PostRecord[] = [];
try {
  const allowBootstrap = Astro.locals?.runtime?.env?.ALLOW_SCHEMA_BOOTSTRAP === "true";
  const db = getDb(Astro.locals);
  await ensurePostsSchema(db, { allowBootstrap });
  await ensurePostMediaSchema(db, { allowBootstrap });
  const { results = [] } = await db
    .prepare(
      `SELECT
        id,
        slug,
        title,
        summary,
        COALESCE(
          NULLIF(posts.cover_url, ''),
          (
            SELECT pm.url
            FROM post_media pm
            WHERE pm.post_id = posts.id
            ORDER BY pm.sort_order ASC, datetime(pm.created_at) ASC
            LIMIT 1
          )
        ) as cover_url,
        video_url,
        video_poster,
        status,
        author_name,
        topic,
        published_at,
        published_tz,
        created_at,
        CASE
          WHEN pinned = 1 AND (pinned_until IS NULL OR datetime(pinned_until) > datetime('now')) THEN 1
          ELSE 0
        END as pinned,
       pinned_priority, pinned_until, pinned_style, sort_order
       FROM posts
       WHERE status = 'published'
       ORDER BY pinned DESC, pinned_priority DESC,
         COALESCE(unixepoch(published_at), unixepoch(created_at), 0) DESC`
    )
    .all<PostRecord>();
  dbPosts = results ?? [];
  if (shouldUseContentFallback()) {
    const contentPosts = await getPublishedPostsFromContent();
    posts = mergePostsBySlug(dbPosts, contentPosts);
  } else {
    posts = dbPosts;
  }
} catch (err) {
  console.warn("Using content posts fallback:", err);
  posts = await getPublishedPostsFromContent();
}

const counts: Record<string, number> = {};
for (const p of posts) {
  const t = resolveTopicSlug(p.topic);
  counts[t] = (counts[t] ?? 0) + 1;
}

const entriesCard = {
  slug: "entries",
  label: "Nh·∫≠t k√Ω",
  icon: "üìì",
  color: "#f97316",
  href: "/entries",
};

const POSTS_PER_PAGE = 15;
const pageParam = Number.parseInt(Astro.url.searchParams.get("page") ?? "1", 10);
const requestedPage = Number.isNaN(pageParam) ? 1 : pageParam;
const totalPages = Math.max(1, Math.ceil(posts.length / POSTS_PER_PAGE));
const currentPage = Math.min(Math.max(requestedPage, 1), totalPages);
const pagedPosts = posts.slice((currentPage - 1) * POSTS_PER_PAGE, currentPage * POSTS_PER_PAGE);
const pageNumbers = Array.from({ length: totalPages }, (_, index) => index + 1);

const pageHref = (page: number) => {
  const params = new URLSearchParams(Astro.url.searchParams);
  if (page <= 1) {
    params.delete("page");
  } else {
    params.set("page", String(page));
  }
  const query = params.toString();
  return query ? `${Astro.url.pathname}?${query}` : Astro.url.pathname;
};

---

<BaseLayout title="Nh·∫≠t k√Ω ‚Äî Two Against The World" active="entries" description="Kho l∆∞u nh·∫≠t k√Ω">
  <section class="paper edge-torn px-6 py-7 sm:px-8 sm:py-8" data-reveal>
    <p class="kicker text-[18px] text-black/50">ü©∏‚ÄúTin Y√™u‚Äùüñ§</p>
    <div class="mt-2">
  <RansomTitle
    text="Our-main-eventsüé∏"
    as="h1"
    stampEvery={0}
    class="text-[44px] sm:text-[56px] ransom-red"
  />
</div>

    <p class="mt-4 text-black/70">
      C·∫©n th·∫≠n nh√©, ch·∫°m v√†o l√† c∆° duy√™n c·ªßa ch√∫ng ta s·∫Ω th√†nh giao ∆∞·ªõc üïØÔ∏è.
    </p>

    <details class="topic-panel" data-topic-panel open>
      <summary class="topic-panel__summary">
        <span aria-hidden="true">‚ñæ</span>
        <span>V·ª´ng ∆°i, m·ªü c·ª≠a ra !!!!!!</span>
      </summary>
      <div class="topic-panel__body">
        <div class="topic-grid">
          {TOPICS.map((t) => (
            <TopicCard slug={t.slug} label={t.label} icon={t.icon} color={t.color} count={counts[t.slug] ?? 0} />
          ))}
          <TopicCard
            slug={entriesCard.slug}
            label={entriesCard.label}
            icon={entriesCard.icon}
            color={entriesCard.color}
            count={posts.length}
            href={entriesCard.href}
          />
        </div>
      </div>
    </details>
  </section>

  <section class="mt-10">
    <div class="pinterest-grid">
      {pagedPosts.map((post) => (
        <FeedCard
          href={`/entries/${post.slug}${post.video_url ? "#entry-video" : ""}`}
          image={resolvePostCoverUrl(post)}
          title={post.title}
          description={post.summary ?? ""}
          author={post.author_name ?? ""}
          date={post.published_at ?? post.created_at}
          timeZone={post.published_tz ?? undefined}
          topic={post.topic ?? undefined}
          locked={post.topic === "trash-bin"}
          pinned={Boolean(post.pinned)}
          pinnedStyle={post.pinned_style ?? undefined}
        />
      ))}
    </div>

    {posts.length > 0 && (
      <nav class="feed-pagination" aria-label="Ph√¢n trang b√†i vi·∫øt">
        <div class="feed-pagination__meta">Trang {currentPage} / {totalPages}</div>
        <div class="feed-pagination__row">
          <a
            class={`feed-pagination__arrow ${currentPage <= 1 ? "is-disabled" : ""}`}
            href={pageHref(Math.max(1, currentPage - 1))}
            aria-disabled={currentPage <= 1 ? "true" : "false"}
          >
            ‚Üê Trang tr∆∞·ªõc
          </a>
          <ol class="feed-pagination__list">
            {pageNumbers.map((page) => (
              <li>
                <a class={`feed-pagination__page ${page === currentPage ? "is-active" : ""}`} href={pageHref(page)} aria-current={page === currentPage ? "page" : undefined}>
                  {page}
                </a>
              </li>
            ))}
          </ol>
          <a
            class={`feed-pagination__arrow ${currentPage >= totalPages ? "is-disabled" : ""}`}
            href={pageHref(Math.min(totalPages, currentPage + 1))}
            aria-disabled={currentPage >= totalPages ? "true" : "false"}
          >
            Trang sau ‚Üí
          </a>
        </div>
      </nav>
    )}
  </section>
</BaseLayout>
