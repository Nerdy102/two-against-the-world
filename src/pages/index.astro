---
import BaseLayout from "../layouts/BaseLayout.astro";
import RansomTitle from "../components/RansomTitle.astro";
import FeedCard from "../components/FeedCard.astro";
import TopicCard from "../components/TopicCard.astro";
import { TOPICS } from "../config/topics";
import { getDb, type PostRecord } from "../lib/d1";

export const prerender = false;

const db = getDb(Astro.locals);
const { results: posts = [] } = await db
  .prepare(
    `SELECT id, slug, title, summary, cover_url, status, author, topic, published_at, pinned
     FROM posts
     WHERE status = 'published'
     ORDER BY pinned DESC, datetime(published_at) DESC`
  )
  .all<PostRecord>();

const counts: Record<string, number> = {};
for (const p of posts) {
  const t = p.topic ?? "two-of-us";
  counts[t] = (counts[t] ?? 0) + 1;
}

const entriesCard = {
  slug: "entries",
  label: "Nháº­t kÃ½",
  icon: "ğŸ““",
  color: "#f97316",
  href: "/entries",
};

---

<BaseLayout title="Nháº­t kÃ½ â€” Two Against The World" active="entries" description="Kho lÆ°u nháº­t kÃ½">
  <section class="paper edge-torn px-6 py-7 sm:px-8 sm:py-8" data-reveal>
    <p class="kicker text-[18px] text-black/50">ğŸ©¸â€œTin YÃªuâ€ğŸ–¤</p>
    <div class="mt-2">
  <RansomTitle
    text="Our-main-eventsğŸ¸"
    as="h1"
    stampEvery={0}
    class="text-[44px] sm:text-[56px] ransom-red"
  />
</div>

    <p class="mt-4 text-black/70">
      Cáº©n tháº­n nhÃ©, cháº¡m vÃ o lÃ  cÆ¡ duyÃªn cá»§a chÃºng ta sáº½ thÃ nh giao Æ°á»›c ğŸ•¯ï¸.
    </p>

    <details class="topic-panel" data-topic-panel open>
      <summary class="topic-panel__summary">
        <span aria-hidden="true">â–¾</span>
        <span>Vá»«ng Æ¡i, má»Ÿ cá»­a ra !!!!!!</span>
      </summary>
      <div class="topic-panel__body">
        <div class="topic-grid">
          {TOPICS.map((t) => (
            <TopicCard slug={t.slug} label={t.label} icon={t.icon} color={t.color} count={counts[t.slug] ?? 0} />
          ))}
          <TopicCard
            slug={entriesCard.slug}
            label={entriesCard.label}
            icon={entriesCard.icon}
            color={entriesCard.color}
            count={posts.length}
            href={entriesCard.href}
          />
        </div>
      </div>
    </details>
  </section>

  <section class="mt-10">
    <div class="pinterest-grid">
      {posts.map((post) => (
        <FeedCard
          href={`/entries/${post.slug}`}
          image={post.cover_url ?? "/noise.svg"}
          title={post.title}
          description={post.summary ?? ""}
          date={post.published_at ?? ""}
          topic={post.topic ?? undefined}
          locked={post.topic === "trash-bin"}
          pinned={Boolean(post.pinned)}
        />
      ))}
    </div>
  </section>
</BaseLayout>
